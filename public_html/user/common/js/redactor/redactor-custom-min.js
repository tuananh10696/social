(function(){var r={},i,e,n,o,s;r.settings={};r.post=function(n){return new i("post",n)};r.get=function(n){return new i("get",n)};i=function(n,t){var u={method:n,url:"",before:function(){},success:function(){},error:function(){},data:!1,async:!0,headers:{}},i;this.p=this.extend(u,t);this.p=this.extend(this.p,r.settings);this.p.method=this.p.method.toUpperCase();this.prepareData();this.xhr=new XMLHttpRequest;this.xhr.open(this.p.method,this.p.url,this.p.async);this.setHeaders();i=typeof this.p.before=="function"?this.p.before(this.xhr):!0;i!==!1&&this.send()};i.prototype={extend:function(n,t){if(t)for(var i in t)n[i]=t[i];return n},prepareData:function(){this.p.method!=="POST"||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded");typeof this.p.data!="object"||this.isFormData()||(this.p.data=this.toParams(this.p.data));this.p.method==="GET"&&(this.p.url=this.p.url+"?"+this.p.data)},setHeaders:function(){this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest");for(var n in this.p.headers)this.xhr.setRequestHeader(n,this.p.headers[n])},isFormData:function(){return typeof FormData!="undefined"&&this.p.data instanceof window.FormData},isComplete:function(){return!(this.xhr.status<200||this.xhr.status>=300&&this.xhr.status!==304)},send:function(){this.p.async?(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded:function(){if(this.isComplete()){var n=this.xhr.response,t=this.parseJson(n);n=t?t:n;typeof this.p.success=="function"&&this.p.success(n,this.xhr)}else typeof this.p.error=="function"&&this.p.error(this.xhr.statusText)},parseJson:function(n){try{n=n.replace(/^\[/,"");n=n.replace(/\]$/,"");var t=JSON.parse(n);if(t&&typeof t=="object")return t}catch(i){}return!1},toParams:function(n){return Object.keys(n).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(n[t])}).join("&")}};var u=[0],h="data"+new Date,f={},t=function(n,t){return this.parse(n,t)};t.ready=function(n){document.readyState!="loading"?n():document.addEventListener("DOMContentLoaded",n)};t.prototype={get dom(){return!0},get length(){return this.nodes.length},parse:function(n,t){var i;if(n){if(n.dom)return this.nodes=n.nodes,n;i=typeof n!="string"?n.nodeType&&n.nodeType===11?n.childNodes:n.nodeType||n===window?[n]:n:/^\s*<(\w+|!)[^>]*>/.test(n)?this.create(n):this._query(n,t)}else i=[];this.nodes=this._slice(i)},create:function(n){var t,f;if(/^<(\w+)\s*\/?>(?:<\/\1>|)$/.test(n))return[document.createElement(RegExp.$1)];var i=[],r=document.createElement("div"),u=r.childNodes;for(r.innerHTML=n,t=0,f=u.length;t<f;t++)i.push(u[t]);return i},add:function(n){this.nodes=this.nodes.concat(this._toArray(n))},get:function(n){return this.nodes[n||0]||!1},getAll:function(){return this.nodes},eq:function(n){return new t(this.nodes[n])||!1},first:function(){return new t(this.nodes[0])||!1},last:function(){return new t(this.nodes[this.nodes.length-1])||!1},contents:function(){return this.get().childNodes},each:function(n){for(var i=this.nodes.length,t=0;t<i;t++)n.call(this,this.nodes[t].dom?this.nodes[t].get():this.nodes[t],t);return this},is:function(n){return this.filter(n).length>0},filter:function(n){var i;return n===undefined?this:(i=typeof n=="function"?n:function(t){return n instanceof Node?n===t:n&&n.dom?n.nodes.indexOf(t)!==-1:(t.matches=t.matches||t.msMatchesSelector||t.webkitMatchesSelector,t.nodeType===1?t.matches(n||"*"):!1)},new t(this.nodes.filter(i)))},not:function(n){return this.filter(function(i){return!new t(i).is(n||!0)})},find:function(n){var i=[];return this.each(function(t){for(var u=this._query(n||"*",t),r=0;r<u.length;r++)i.push(u[r])}),new t(i)},children:function(n){var i=[];return this.each(function(n){var r,t;if(n.children)for(r=n.children,t=0;t<r.length;t++)i.push(r[t])}),new t(i).filter(n)},parent:function(n){var i=[];return this.each(function(n){n.parentNode&&i.push(n.parentNode)}),new t(i).filter(n)},parents:function(n,i){i=this._getContext(i);var r=[];return this.each(function(u){for(var f=u.parentNode;f&&f!==i;)n?new t(f).is(n)&&r.push(f):r.push(f),f=f.parentNode}),new t(r)},closest:function(n,i){i=this._getContext(i);n=n.dom?n.get():n;var r=[],u=n&&n.nodeType;return this.each(function(f){do if(u&&f===n||new t(f).is(n))return r.push(f);while((f=f.parentNode)&&f!==i)}),new t(r)},next:function(){return new t(this.get().nextSibling)},nextElement:function(){return new t(this.get().nextElementSibling)},prev:function(){return new t(this.get().previousSibling)},prevElement:function(){return new t(this.get().previousElementSibling)},css:function(n,t){if(t===undefined&&typeof n!="object"){var i=this.get();return n==="width"||n==="height"?i.style?this._getHeightOrWidth(n,i,!1)+"px":undefined:i.style?getComputedStyle(i,null)[n]:undefined}return this.each(function(i){var r={},u;typeof n=="object"?r=n:r[n]=t;for(u in r)i.style&&(i.style[u]=r[u])})},attr:function(n,t,i){return(i=i?"data-":"",t===undefined&&typeof n!="object")?this.get().nodeType!==3?n==="checked"?this.get().checked:this.get().getAttribute(i+n):void 0:this.each(function(r){var f={},u;typeof n=="object"?f=n:f[n]=t;for(u in f)r.nodeType!==3&&(u==="checked"&&f[u]===!1?r.removeAttribute(u):r.setAttribute(i+u,f[u]))})},data:function(n,t){var r,u,f;if(n===undefined){var e=/^data\-(.+)$/,i=this.get().attributes,o={},s=function(n){return n[1].toUpperCase()};for(r in i)e.test(i[r].nodeName)&&(u=i[r].nodeName.match(e)[1],f=i[r].value,u=u.replace(/-([a-z])/g,s),o[u]=this._isNumber(f)?parseFloat(f):this._getBooleanFromStr(f));return o}return this.attr(n,t,!0)},val:function(n){if(n===undefined){var t=this.get();return t.type&&t.type==="checkbox"?t.checked:t.value}return this.each(function(t){t.value=n})},removeAttr:function(n){return this.each(function(t){var i=function(n){t.nodeType!==3&&t.removeAttribute(n)};n.split(" ").forEach(i)})},removeData:function(n){return this.each(function(t){var i=function(n){t.nodeType!==3&&t.removeAttribute("data-"+n)};n.split(" ").forEach(i)})},dataset:function(n,t){return this.each(function(i){u[this.dataindex(i)][n]=t})},dataget:function(n){return u[this.dataindex(this.get())][n]},dataindex:function(n){var t=n[h],i=u.length;return t||(t=n[h]=i,u[t]={}),t},addClass:function(n){return this._eachClass(n,"add")},removeClass:function(n){return this._eachClass(n,"remove")},toggleClass:function(n){return this._eachClass(n,"toggle")},hasClass:function(n){return this.nodes.some(function(t){return t.classList?t.classList.contains(n):!1})},empty:function(){return this.each(function(n){n.innerHTML=""})},html:function(n){return n===undefined?this.get().innerHTML||"":this.empty().append(n)},text:function(n){return n===undefined?this.get().textContent||"":this.each(function(t){t.textContent=n})},after:function(n){return this._inject(n,function(n,t){var r,i;if(typeof n=="string")t.insertAdjacentHTML("afterend",n);else for(r=n instanceof Node?[n]:this._toArray(n).reverse(),i=0;i<r.length;i++)t.parentNode.insertBefore(r[i],t.nextSibling);return t})},before:function(n){return this._inject(n,function(n,t){var r,i;if(typeof n=="string")t.insertAdjacentHTML("beforebegin",n);else for(r=n instanceof Node?[n]:this._toArray(n),i=0;i<r.length;i++)t.parentNode.insertBefore(r[i],t);return t})},append:function(n){return this._inject(n,function(n,t){var r,i;if(typeof n=="string")t.insertAdjacentHTML("beforeend",n);else for(r=n instanceof Node?[n]:this._toArray(n),i=0;i<r.length;i++)t.appendChild(r[i]);return t})},prepend:function(n){return this._inject(n,function(n,t){var r,i;if(typeof n=="string")t.insertAdjacentHTML("afterbegin",n);else for(r=n instanceof Node?[n]:this._toArray(n).reverse(),i=0;i<r.length;i++)t.insertBefore(r[i],t.firstChild);return t})},wrap:function(n){return this._inject(n,function(n,i){var r=typeof n=="string"?this.create(n)[0]:n instanceof Node?n:this._toArray(n)[0];return i.parentNode&&i.parentNode.insertBefore(r,i),r.appendChild(i),new t(r)})},unwrap:function(){return this.each(function(n){var i=new t(n);return i.replaceWith(i.contents())})},replaceWith:function(n){return this._inject(n,function(n,t){for(var f,i=document.createDocumentFragment(),u=typeof n=="string"?this.create(n):n instanceof Node?[n]:this._toArray(n),r=0;r<u.length;r++)i.appendChild(u[r]);return f=i.childNodes[0],t.parentNode.replaceChild(i,t),f})},remove:function(){return this.each(function(n){n.parentNode&&n.parentNode.removeChild(n)})},clone:function(n){var i=[];return this.each(function(t){var r=this._clone(t);n&&(r=this._cloneEvents(t,r));i.push(r)}),new t(i)},show:function(){return this.each(function(n){var e,i,u,t,r;if(n.style){if(this._getRealDisplay(n)!=="none")return;e=n.getAttribute("displayOld");n.style.display=e||"";this._getRealDisplay(n)==="none"&&(i=n.nodeName,u=document.body,f[i]?t=f[i]:(r=document.createElement(i),u.appendChild(r),t=this._getRealDisplay(r),t==="none"&&(t="block"),u.removeChild(r),f[i]=t),n.setAttribute("displayOld",t),n.style.display=t)}}.bind(this))},hide:function(){return this.each(function(n){n.style&&(n.getAttribute("displayOld")||n.style.display===""||n.setAttribute("displayOld",n.style.display),n.style.display="none")})},scrollTop:function(n){var t=this.get(),i=t===window,r=t.nodeType===9,u=r?document.scrollingElement||document.body.parentNode||document.body||document.documentElement:t;if(n!==undefined){i?window.scrollTo(0,n):u.scrollTop=n;return}return r?typeof pageYOffset!="undefined"?window.pageYOffset:document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0:i?window.pageYOffset:u.scrollTop},offset:function(){return this._getDim("Offset")},position:function(){return this._getDim("Position")},width:function(n,t){return this._getSize("width","Width",n,t)},height:function(n,t){return this._getSize("height","Height",n,t)},outerWidth:function(){return this._getInnerOrOuter("width","outer")},outerHeight:function(){return this._getInnerOrOuter("height","outer")},innerWidth:function(){return this._getInnerOrOuter("width","inner")},innerHeight:function(){return this._getInnerOrOuter("height","inner")},click:function(){return this._triggerEvent("click")},focus:function(){return this._triggerEvent("focus")},trigger:function(n){return this.each(function(t){for(var r,f,u=n.split(" "),i=0;i<u.length;i++){f={bubbles:!0,cancelable:!0};try{r=new window.CustomEvent(u[i],f)}catch(e){r=document.createEvent("CustomEvent");r.initCustomEvent(u[i],!0,!0)}t.dispatchEvent(r)}})},on:function(n,t,i){return this.each(function(r){for(var f,u,o=n.split(" "),e=0;e<o.length;e++)f=this._getEventName(o[e]),u=this._getEventNamespace(o[e]),t=i?this._getOneHandler(t,n):t,r.addEventListener(f,t),r._e=r._e||{},r._e[u]=r._e[u]||{},r._e[u][f]=r._e[u][f]||[],r._e[u][f].push(t)})},one:function(n,t){return this.on(n,t,!0)},off:function(n,t){var i=function(n,t,i){return n===i},r=function(n,t,i,r){return t===r},u=function(n,t,i,r){return n===i&&t===r},f=function(){return!0};return n===undefined?this.each(function(n){this._offEvent(n,!1,!1,t,f)}):this.each(function(f){for(var o,e,h=n.split(" "),s=0;s<h.length;s++)o=this._getEventName(h[s]),e=this._getEventNamespace(h[s]),e==="_events"?this._offEvent(f,o,e,t,i):o||e==="_events"?this._offEvent(f,o,e,t,u):this._offEvent(f,o,e,t,r)})},serialize:function(n){for(var t,r,f,i={},e=this.get().elements,u=0;u<e.length;u++)if((t=e[u],!/(checkbox|radio)/.test(t.type)||t.checked)&&t.name&&!t.disabled&&t.type!=="file"){if(t.type==="select-multiple")for(r=0;r<t.options.length;r++)f=t.options[r],f.selected&&(i[t.name]=f.value);i[t.name]=t.value}return n?i:this._toParams(i)},ajax:function(n,t){if(typeof i!="undefined"){var r=this.attr("method")||"post",u={url:this.attr("action"),data:this.serialize(),success:n,error:t};return new i(r,u)}},_queryContext:function(n,t){return t=this._getContext(t),t.nodeType!==3&&typeof t.querySelectorAll=="function"?t.querySelectorAll(n):[]},_query:function(n,t){if(t)return this._queryContext(n,t);if(/^[.#]?[\w-]*$/.test(n)){if(n[0]==="#"){var i=document.getElementById(n.slice(1));return i?[i]:[]}return n[0]==="."?document.getElementsByClassName(n.slice(1)):document.getElementsByTagName(n)}return document.querySelectorAll(n)},_getContext:function(n){return n=typeof n=="string"?document.querySelector(n):n,n&&n.dom?n.get():n||document},_inject:function(n,i){for(var r=this.nodes.length,f=[];r--;){var e=typeof n=="function"?n.call(this,this.nodes[r]):n,o=r===0?e:this._clone(e),u=i.call(this,o,this.nodes[r]);u&&(u.dom?f.push(u.get()):f.push(u))}return new t(f)},_cloneEvents:function(n,t){var i=n._e,r,u;if(i){t._e=i;for(r in i._events)for(u=0;u<i._events[r].length;u++)t.addEventListener(r,i._events[r][u])}return t},_clone:function(n){if(typeof n!="undefined")return typeof n=="string"?n:n instanceof Node?n.cloneNode(!0):"length"in n?[].map.call(this._toArray(n),function(n){return n.cloneNode(!0)}):n},_slice:function(n){return!n||n.length===0?[]:n.length?[].slice.call(n.nodes||n):[n]},_eachClass:function(n,t){return this.each(function(i){if(n){var r=function(n){i.classList&&i.classList[t](n)};n.split(" ").forEach(r)}})},_triggerEvent:function(n){var t=this.get();return t&&t.nodeType!==3&&t[n](),this},_getOneHandler:function(n,t){var i=this;return function(){n.apply(this,arguments);i.off(t)}},_getEventNamespace:function(n){var t=n.split("."),i=t[1]?t[1]:"_events";return t[2]?i+t[2]:i},_getEventName:function(n){return n.split(".")[0]},_offEvent:function(n,t,i,r,u){var f,e,s,o;for(f in n._e)for(e in n._e[f])if(u(e,f,t,i))for(s=n._e[f][e],o=0;o<s.length;o++)(typeof r=="undefined"||s[o].toString()===r.toString())&&(n.removeEventListener(e,s[o]),n._e[f][e].splice(o,1),n._e[f][e].length===0&&delete n._e[f][e],Object.keys(n._e[f]).length===0&&delete n._e[f])},_getInnerOrOuter:function(n,t){return this[n](undefined,t)},_getDocSize:function(n,t){var r=n.body,i=n.documentElement;return Math.max(r["scroll"+t],r["offset"+t],i["client"+t],i["scroll"+t],i["offset"+t])},_getSize:function(n,i,r,u){if(r===undefined){var f=this.get();return r=f.nodeType===3?0:f.nodeType===9?this._getDocSize(f,i):f===window?window["inner"+i]:this._getHeightOrWidth(n,f,u||"normal"),Math.round(r)}return this.each(function(i){r=parseFloat(r);r=r+this._adjustResultHeightOrWidth(n,i,u||"normal");new t(i).css(n,r+"px")}.bind(this))},_getHeightOrWidth:function(n,i,r){var s=n.charAt(0).toUpperCase()+n.slice(1),c=getComputedStyle(i,null),h=new t(i),e=0,u=h.parents().filter(function(n){return getComputedStyle(n,null).display==="none"?n:!1}),o,f;return c.display==="none"&&u.add(i),u.length!==0?(o="visibility: hidden !important; display: block !important;",f=[],u.each(function(n){var r=new t(n),i=r.attr("style");i!==null&&f.push(i);r.attr("style",i!==null?i+";"+o:o)}),e=h.get()["offset"+s]-this._adjustResultHeightOrWidth(n,i,r),u.each(function(n,i){var r=new t(n);f[i]===undefined?r.removeAttr("style"):r.attr("style",f[i])})):e=i["offset"+s]-this._adjustResultHeightOrWidth(n,i,r),e},_adjustResultHeightOrWidth:function(n,t,i){if(!t||i===!1)return 0;var u=0,r=getComputedStyle(t,null),f=r.boxSizing==="border-box";return n==="height"?((i==="inner"||i==="normal"&&f)&&(u+=(parseFloat(r.borderTopWidth)||0)+(parseFloat(r.borderBottomWidth)||0)),i==="outer"&&(u-=(parseFloat(r.marginTop)||0)+(parseFloat(r.marginBottom)||0))):((i==="inner"||i==="normal"&&f)&&(u+=(parseFloat(r.borderLeftWidth)||0)+(parseFloat(r.borderRightWidth)||0)),i==="outer"&&(u-=(parseFloat(r.marginLeft)||0)+(parseFloat(r.marginRight)||0))),u},_getDim:function(n){var t=this.get();return t.nodeType===3?{top:0,left:0}:this["_get"+n](t)},_getPosition:function(n){return{top:n.offsetTop,left:n.offsetLeft}},_getOffset:function(n){var t=n.getBoundingClientRect(),i=n.ownerDocument,r=i.documentElement,u=i.defaultView;return{top:t.top+u.pageYOffset-r.clientTop,left:t.left+u.pageXOffset-r.clientLeft}},_toArray:function(n){var i,t;if(n instanceof NodeList){for(i=[],t=0;t<n.length;t++)i[t]=n[t];return i}return n===undefined?[]:n.dom?n.nodes:n},_toParams:function(n){var t="";for(var i in n)t+="&"+this._encodeUri(i)+"="+this._encodeUri(n[i]);return t.replace(/^&/,"")},_encodeUri:function(n){return encodeURIComponent(n).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},_isNumber:function(n){return!isNaN(n)&&!isNaN(parseFloat(n))},_getBooleanFromStr:function(n){return n==="true"?!0:n==="false"?!1:n},_getRealDisplay:function(n){if(n.currentStyle)return n.currentStyle.display;if(window.getComputedStyle){var t=window.getComputedStyle(n,null);return t.getPropertyValue("display")}}};e=0;n=function(n,t){return o(n,t,[].slice.call(arguments,2))};n.version="3.0.8";n.options={};n.modules={};n.services={};n.classes={};n.plugins={};n.mixins={};n.modals={};n.lang={};n.dom=function(n,i){return new t(n,i)};n.ajax=r;n.Dom=t;n.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37};n.env={plugin:"plugins",module:"modules",service:"services","class":"classes",mixin:"mixins"};typeof jQuery!="undefined"&&function(n){n.fn.redactor=function(n){return o(this.toArray(),n,[].slice.call(arguments,1))}}(jQuery);o=function(t,i,r){for(var a,o,v,h,c="redactor",y=Array.isArray(t)?t:t&&t.nodeType?[t]:document.querySelectorAll(t),p=typeof i=="string"||typeof i=="function",f=[],u,l=0;l<y.length;l++)a=y[l],o=n.dom(a),u=o.dataget(c),u||p||(o.dataset(c,u=new s(a,i,e)),e++),u&&p&&(v=i==="destroy",i=v?"stop":i,typeof i=="function"?h=i.apply(u,r):(r.unshift(i),h=u.api.apply(u,r)),h!==undefined&&f.push(h),v&&o.dataset(c,!1));return f.length===0||f.length===1?f.length===0?u:f[0]:f};n.add=function(t,i,r){var u,f;if(typeof n.env[t]!="undefined")if(r.translations&&(n.lang=n.extend(!0,{},n.lang,r.translations)),r.modals&&(n.modals=n.extend(!0,{},n.modals,r.modals)),t==="mixin")n[n.env[t]][i]=r;else{if(u=function(){},u.prototype=r,r.mixins)for(f=0;f<r.mixins.length;f++)n.inherit(u,n.mixins[r.mixins[f]]);n[n.env[t]][i]=u}};n.addLang=function(t,i){typeof n.lang[t]=="undefined"&&(n.lang[t]={});n.lang[t]=n.extend(n.lang[t],i)};n.create=function(t){var r=t.split("."),e=[].slice.call(arguments,1),f="classes",i,u;return(typeof n.env[r[0]]!="undefined"&&(f=n.env[r[0]],t=r.slice(1).join(".")),i=new n[f][t],i.init)?(u=i.init.apply(i,e),u?u:i):i};n.inherit=function(n,t){var u=function(){},r,i;u.prototype=t;r=new u;for(i in n.prototype)n.prototype.__lookupGetter__(i)?r.__defineGetter__(i,n.prototype.__lookupGetter__(i)):r[i]=n.prototype[i];return n.prototype=r,n.prototype.super=t,n};n.error=function(n){throw n;};n.extend=function(){var t={},r=!1,i=0,e=arguments.length,u,f;for(Object.prototype.toString.call(arguments[0])==="[object Boolean]"&&(r=arguments[0],i++),u=function(i){for(var u in i)Object.prototype.hasOwnProperty.call(i,u)&&(t[u]=r&&Object.prototype.toString.call(i[u])==="[object Object]"?n.extend(!0,t[u],i[u]):i[u])};i<e;i++)f=arguments[i],u(f);return t};n.opts={animation:!0,lang:"en",direction:"ltr",spellcheck:!0,structure:!1,scrollTarget:!1,styles:!0,stylesClass:"redactor-styles",placeholder:!1,source:!0,showSource:!1,inline:!1,breakline:!1,markup:"p",enterKey:!0,clickToEdit:!1,clickToSave:!1,clickToCancel:!1,focus:!1,focusEnd:!1,minHeight:!1,maxHeight:!1,maxWidth:!1,plugins:[],callbacks:{},preClass:!1,preSpaces:4,tabindex:!1,tabAsSpaces:!1,tabKey:!0,autosave:!1,autosaveName:!1,autosaveData:!1,toolbar:!0,toolbarFixed:!0,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarExternal:!1,toolbarContext:!0,air:!1,formatting:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],formattingAdd:!1,formattingHide:!1,buttons:["html","format","bold","italic","deleted","lists","image","file","link"],buttonsTextLabeled:!1,buttonsAdd:[],buttonsAddFirst:[],buttonsAddAfter:!1,buttonsAddBefore:!1,buttonsHide:[],buttonsHideOnMobile:[],imageUpload:!1,imageUploadParam:"file",imageData:!1,imageEditable:!0,imageCaption:!0,imagePosition:!1,imageResizable:!1,imageFloatMargin:"10px",imageFigure:!0,fileUpload:!1,fileUploadParam:"file",fileData:!1,fileAttachment:!1,uploadData:!1,dragUpload:!0,multipleUpload:!0,clipboardUpload:!0,uploadBase64:!1,linkTarget:!1,linkTitle:!1,linkNewTab:!1,linkNofollow:!1,linkSize:30,linkValidation:!0,cleanOnEnter:!0,cleanInlineOnEnter:!1,paragraphize:!0,removeScript:!0,removeNewLines:!1,removeComments:!0,replaceTags:{b:"strong",i:"em",strike:"del"},pastePlainText:!1,pasteLinkTarget:!1,pasteImages:!0,pasteLinks:!0,pasteClean:!0,pasteKeepStyle:[],pasteKeepClass:[],pasteKeepAttrs:["td","th"],pasteBlockTags:["pre","h1","h2","h3","h4","h5","h6","table","tbody","thead","tfoot","th","tr","td","ul","ol","li","blockquote","p","figure","figcaption"],pasteInlineTags:["a","img","br","strong","ins","code","del","span","samp","kbd","sup","sub","mark","var","cite","small","b","u","em","i","abbr"],activeButtons:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",u:"underline"},activeButtonsAdd:{},activeButtonsObservers:{},autoparse:!0,autoparseStart:!0,autoparsePaste:!0,autoparseLinks:!0,autoparseImages:!0,autoparseVideo:!0,shortcodes:{"p.":{format:"p"},"quote.":{format:"blockquote"},"pre.":{format:"pre"},"h1.":{format:"h1"},"h2.":{format:"h2"},"h3.":{format:"h3"},"h4.":{format:"h4"},"h5.":{format:"h5"},"h6.":{format:"h6"},"1.":{format:"ol"},"*.":{format:"ul"}},shortcodesAdd:!1,shortcuts:{"ctrl+shift+m, meta+shift+m":{api:"module.inline.clearformat"},"ctrl+b, meta+b":{api:"module.inline.format",args:"b"},"ctrl+i, meta+i":{api:"module.inline.format",args:"i"},"ctrl+u, meta+u":{api:"module.inline.format",args:"u"},"ctrl+h, meta+h":{api:"module.inline.format",args:"sup"},"ctrl+l, meta+l":{api:"module.inline.format",args:"sub"},"ctrl+k, meta+k":{api:"module.link.open"},"ctrl+alt+0, meta+alt+0":{api:"module.block.format",args:"p"},"ctrl+alt+1, meta+alt+1":{api:"module.block.format",args:"h1"},"ctrl+alt+2, meta+alt+2":{api:"module.block.format",args:"h2"},"ctrl+alt+3, meta+alt+3":{api:"module.block.format",args:"h3"},"ctrl+alt+4, meta+alt+4":{api:"module.block.format",args:"h4"},"ctrl+alt+5, meta+alt+5":{api:"module.block.format",args:"h5"},"ctrl+alt+6, meta+alt+6":{api:"module.block.format",args:"h6"},"ctrl+shift+7, meta+shift+7":{api:"module.list.toggle",args:"ol"},"ctrl+shift+8, meta+shift+8":{api:"module.list.toggle",args:"ul"}},shortcutsAdd:!1,grammarly:!0,bufferLimit:100,emptyHtml:"<p><\/p>",markerChar:"ï»¿",imageTypes:["image/png","image/jpeg","image/gif"],inlineTags:["a","span","strong","strike","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small","abbr"],blockTags:["pre","ul","ol","li","p","h1","h2","h3","h4","h5","h6","dl","dt","dd","div","table","tbody","thead","tfoot","tr","th","td","blockquote","output","figcaption","figure","address","section","header","footer","aside","article","iframe"],regex:{youtube:/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/gi,vimeo:/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/(https?:\/\/(?:www\.|(?!www))[^\s\.]+\.[^\s]{2,}|www\.[^\s]+\.[^\s]{2,})/gi},input:!0,zindex:!1,modes:{inline:{pastePlainText:!0,pasteImages:!1,enterKey:!1,toolbar:!1,autoparse:!1,source:!1,showSource:!1,styles:!1,air:!1},original:{styles:!1}}};n.lang.en={format:"Format",image:"Image",file:"File",link:"Link",bold:"Bold",italic:"Italic",deleted:"Strikethrough",underline:"Underline",superscript:"Superscript",subscript:"Subscript","bold-abbr":"B","italic-abbr":"I","deleted-abbr":"S","underline-abbr":"U","superscript-abbr":"Sup","subscript-abbr":"Sub",lists:"Lists","link-insert":"Insert Link","link-edit":"Edit Link","link-in-new-tab":"Open link in new tab",unlink:"Unlink",cancel:"Cancel",close:"Close",insert:"Insert",save:"Save","delete":"Delete",text:"Text",edit:"Edit",title:"Title",paragraph:"Normal text",quote:"Quote",code:"Code",heading1:"Heading 1",heading2:"Heading 2",heading3:"Heading 3",heading4:"Heading 4",heading5:"Heading 5",heading6:"Heading 6",filename:"Name",optional:"optional",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",horizontalrule:"Line",upload:"Upload","upload-label":"Drop files here or click to upload","accessibility-help-label":"Rich text editor",caption:"Caption",bulletslist:"Bullets",numberslist:"Numbers","image-position":"Position",none:"None",left:"Left",right:"Right",center:"Center",undo:"Undo",redo:"Redo"};n.buttons={html:{title:"HTML",icon:!0,api:"module.source.toggle"},undo:{title:"## undo ##",icon:!0,api:"module.buffer.undo"},redo:{title:"## redo ##",icon:!0,api:"module.buffer.redo"},format:{title:"## format ##",icon:!0,dropdown:{p:{title:"## paragraph ##",api:"module.block.format",args:{tag:"p"}},blockquote:{title:"## quote ##",api:"module.block.format",args:{tag:"blockquote"}},pre:{title:"## code ##",api:"module.block.format",args:{tag:"pre"}},h1:{title:"## heading1 ##",api:"module.block.format",args:{tag:"h1"}},h2:{title:"## heading2 ##",api:"module.block.format",args:{tag:"h2"}},h3:{title:"## heading3 ##",api:"module.block.format",args:{tag:"h3"}},h4:{title:"## heading4 ##",api:"module.block.format",args:{tag:"h4"}},h5:{title:"## heading5 ##",api:"module.block.format",args:{tag:"h5"}},h6:{title:"## heading6 ##",api:"module.block.format",args:{tag:"h6"}}}},bold:{title:"## bold-abbr ##",icon:!0,tooltip:"## bold ##",api:"module.inline.format",args:{tag:"b"}},italic:{title:"## italic-abbr ##",icon:!0,tooltip:"## italic ##",api:"module.inline.format",args:{tag:"i"}},deleted:{title:"## deleted-abbr ##",icon:!0,tooltip:"## deleted ##",api:"module.inline.format",args:{tag:"del"}},underline:{title:"## underline-abbr ##",icon:!0,tooltip:"## underline ##",api:"module.inline.format",args:{tag:"u"}},sup:{title:"## superscript-abbr ##",icon:!0,tooltip:"## superscript ##",api:"module.inline.format",args:{tag:"sup"}},sub:{title:"## subscript-abbr ##",icon:!0,tooltip:"## subscript ##",api:"module.inline.format",args:{tag:"sub"}},lists:{title:"## lists ##",icon:!0,observe:"list",dropdown:{observe:"list",orderedlist:{title:"1. ## orderedlist ##",api:"module.list.toggle",args:"ol"},outdent:{title:"< ## outdent ##",api:"module.list.outdent"},indent:{title:"> ## indent ##",api:"module.list.indent"}}},ul:{title:"&bull; ## bulletslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ul"},ol:{title:"1. ## numberslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ol"},outdent:{title:"## outdent ##",icon:!0,api:"module.list.outdent",observe:"list"},indent:{title:"## indent ##",icon:!0,api:"module.list.indent",observe:"list"},image:{title:"## image ##",icon:!0,api:"module.image.open"},file:{title:"## file ##",icon:!0,api:"module.file.open"},link:{title:"## link ##",icon:!0,observe:"link",dropdown:{observe:"link",link:{title:"## link-insert ##",api:"module.link.open"},unlink:{title:"## unlink ##",api:"module.link.unlink"}}},line:{title:"## horizontalrule ##",icon:!0,api:"module.line.insert"}};s=function(t,i,r){this.module={};this.plugin={};this.instances={};this.started=!1;this.stopped=!1;this.uuid=r;this.rootElement=t;this.rootOpts=i;this.dragInside=!1;this.dragComponentInside=!1;this.keycodes=n.keycodes;this.namespace="redactor";this.$win=n.dom(window);this.$doc=n.dom(document);this.$body=n.dom("body");this.editorReadOnly=!1;this.opts=n.create("service.options",i,t);this.lang=n.create("service.lang",this);this.buildServices();this.buildModules();this.buildPlugins();this.start()};s.prototype={start:function(){this.stopped=!1;this.broadcast("start");this.broadcast("startcode");this.opts.clickToEdit?this.broadcast("startclicktoedit"):(this.broadcast("enable"),this.opts.showSource&&this.broadcast("startcodeshow"),this.broadcast("enablefocus"));this.broadcast("started");this.started=!0},stop:function(){this.started=!1;this.stopped=!0;this.broadcast("stop");this.broadcast("disable");this.broadcast("stopped")},isStarted:function(){return this.started},isStopped:function(){return this.stopped},buildServices:function(){var s=["options","lang"],f=["uuid","keycodes","opts","lang","$win","$doc","$body"],e=[],t,i,o,r,u;for(t in n.services)s.indexOf(t)===-1&&(this[t]=n.create("service."+t,this),e.push(t),f.push(t));for(i=0;i<e.length;i++)for(o=e[i],r=0;r<f.length;r++)u=f[r],o!==u&&(this[o][u]=this[u])},buildModules:function(){for(var t in n.modules)this.module[t]=n.create("module."+t,this),this.instances[t]=this.module[t]},buildPlugins:function(){for(var t,r=this.opts.plugins,i=0;i<r.length;i++)t=r[i],typeof n.plugins[t]!="undefined"&&(this.plugin[t]=n.create("plugin."+t,this),this.instances[t]=this.plugin[t])},isDragInside:function(){return this.dragInside},setDragInside:function(n){this.dragInside=n},isDragComponentInside:function(){return this.dragComponentInside},setDragComponentInside:function(n){this.dragComponentInside=n},getDragComponentInside:function(){return this.dragComponentInside},isReadOnly:function(){return this.editorReadOnly},enableReadOnly:function(){this.editorReadOnly=!0;this.broadcast("enablereadonly");this.component.clearActive();this.toolbar.disableButtons()},disableReadOnly:function(){this.editorReadOnly=!1;this.broadcast("disablereadonly");this.toolbar.enableButtons()},callMessageHandler:function(n,t,i){var r=t.split("."),u;r.length===1?typeof n["on"+t]=="function"&&n["on"+t].apply(n,i):(r[0]="on"+r[0],u=this.utils.checkProperty(n,r),typeof u=="function"&&u.apply(n,i))},broadcast:function(n){var t=[].slice.call(arguments,1);for(var i in this.instances)this.callMessageHandler(this.instances[i],n,t);return this.callback.trigger(n,t)},on:function(n,t){this.callback.add(n,t)},off:function(n,t){this.callback.remove(n,t)},api:function(t){if((this.isStarted()||t==="start")&&(!this.isReadOnly()||t==="disableReadOnly")){this.broadcast("state");var r=[].slice.call(arguments,1),i=t.split("."),f=i.length===1,u=i[0]==="on"||i[0]==="off",e=!u&&i.length===2,o=i[0]==="plugin",s=i[0]==="module";if(f){if(typeof this[i[0]]=="function")return this.callInstanceMethod(this,i[0],r)}else{if(u)return i[0]==="on"?this.on(i[1],r[0]):this.off(i[1],r[0]||undefined);if(e){if(this.isInstanceExists(this,i[0]))return this.callInstanceMethod(this[i[0]],i[1],r);n.error(new Error('Service "'+i[0]+'" not found'))}else if(o){if(this.isInstanceExists(this.plugin,i[1]))return this.callInstanceMethod(this.plugin[i[1]],i[2],r);n.error(new Error('Plugin "'+i[1]+'" not found'))}else if(s){if(this.isInstanceExists(this.module,i[1]))return this.callInstanceMethod(this.module[i[1]],i[2],r);n.error(new Error('Module "'+i[1]+'" not found'))}}}},isInstanceExists:function(n,t){return typeof n[t]!="undefined"},callInstanceMethod:function(n,t,i){if(typeof n[t]=="function")return n[t].apply(n,i)}};n.add("mixin","formatter",{buildArgs:function(n){this.args={"class":n["class"]||!1,style:n.style||!1,attr:n.attr||!1};this.args["class"]||this.args.style||this.args.attr||(this.args=!1)},applyArgs:function(n,t){return this.args?this[this.type](this.args,!1,n,t):this._clearAll(n,t)},clearClass:function(t,i){this.selection.save();var r=i?n.dom(i):this.getElements(t,!0);return r.removeAttr("class"),i=this._unwrapSpanWithoutAttr(r.getAll()),this.selection.restore(),i},clearStyle:function(t,i){this.selection.save();var r=i?n.dom(i):this.getElements(t,!0);return r.removeAttr("style"),i=this._unwrapSpanWithoutAttr(r.getAll()),this.selection.restore(),i},clearAttr:function(t,i){this.selection.save();var r=i?n.dom(i):this.getElements(t,!0);return this._removeAllAttr(r),i=this._unwrapSpanWithoutAttr(r.getAll()),this.selection.restore(),i},set:function(t,i,r,u){u!==!1&&this.selection.save();var f=r?n.dom(r):this.getElements(i);return t["class"]&&(f.removeAttr("class"),f.addClass(t["class"])),t.style&&(f.removeAttr("style"),f.css(t.style),f.each(function(t){var i=n.dom(t);i.attr("data-redactor-style-cache",i.attr("style"))})),t.attr&&(this._removeAllAttr(f),f.attr(t.attr)),u!==!1&&this.selection.restore(),f.getAll()},toggle:function(t,i,r,u){var e,f;return u!==!1&&this.selection.save(),e=r?n.dom(r):this.getElements(i),t["class"]&&e.toggleClass(t["class"]),t.style&&(f=t.style,e.each(function(t){var u=n.dom(t),e,i,r,o,s;for(e in f)i=f[e],r=u.css(e),r=this.utils.isRgb(r)?this.utils.rgb2hex(r):r.replace(/"/g,""),i=this.utils.isRgb(i)?this.utils.rgb2hex(i):i.replace(/"/g,""),r=this.utils.hex2long(r),i=this.utils.hex2long(i),o=typeof i=="string"?i.toLowerCase():i,s=typeof r=="string"?r.toLowerCase():r,o===s?u.css(e,""):u.css(e,i);this._convertStyleQuotes(u);this.utils.removeEmptyAttr(t,"style")?u.removeAttr("data-redactor-style-cache"):u.attr("data-redactor-style-cache",u.attr("style"))}.bind(this))),t.attr&&(f=t.attr,e.each(function(t){var r=n.dom(t);for(var i in f)r.attr(i)?r.removeAttr(i):r.attr(i,f[i])})),u!==!1&&this.selection.restore(),e.getAll()},add:function(t,i,r,u){var f,e;return u!==!1&&this.selection.save(),f=r?n.dom(r):this.getElements(i),t["class"]&&f.addClass(t["class"]),t.style&&(e=t.style,f.each(function(t){var i=n.dom(t);i.css(e);i.attr("data-redactor-style-cache",i.attr("style"));this._convertStyleQuotes(i)}.bind(this))),t.attr&&f.attr(t.attr),u!==!1&&this.selection.restore(),f.getAll()},remove:function(t,i,r,u){var f,e;return u!==!1&&this.selection.save(),f=r?n.dom(r):this.getElements(i),t["class"]&&f.removeClass(t["class"]),t.style&&(e=t.style,f.each(function(t){var i=n.dom(t);i.css(e,"");this.utils.removeEmptyAttr(t,"style")?i.removeAttr("data-redactor-style-cache"):i.attr("data-redactor-style-cache",i.attr("style"))}.bind(this))),t.attr&&f.removeAttr(t.attr),r=this._unwrapSpanWithoutAttr(f.getAll()),u!==!1&&this.selection.restore(),r},_removeAllAttr:function(n){n.each(function(n){for(var i,r,t=n.attributes.length;t-->0;)i=n.attributes[t],r=i.name,r!=="style"&&r!=="class"&&n.removeAttributeNode(i)})},_convertStyleQuotes:function(n){var t=n.attr("style");t&&n.attr("style",t.replace(/"/g,"'"))},_clearAll:function(n,t){var i,r;for(t!==!1&&this.selection.save(),i=0;i<n.length;i++)for(r=n[i];r.attributes.length>0;)r.removeAttribute(r.attributes[0].name);return n=this._unwrapSpanWithoutAttr(n),t!==!1&&this.selection.restore(),n},_unwrapSpanWithoutAttr:function(t){for(var i,f,u=[],r=0;r<t.length;r++)i=t[r],f=i.attributes.length,f<=0&&i.nodeType!==3&&i.tagName==="SPAN"?n.dom(i).unwrap():u.push(i);return u}});n.add("mixin","dom",n.Dom.prototype);n.add("mixin","component",{get cmnt(){return!0}});n.add("service","options",{init:function(t,i){var r=n.dom(i),u=n.extend({},n.opts,i?r.data():{},n.options);return n.extend(!0,u,t)}});n.add("service","lang",{init:function(n){this.app=n;this.opts=n.opts;this.vars=this._build(this.opts.lang)},rebuild:function(n){this.opts.lang=n;this.vars=this._build(n)},extend:function(t){this.vars=n.extend(this.vars,t)},parse:function(n){var t,i,r;if(n===undefined)return"";if(t=n.match(/## (.*?) ##/g),t)for(i=0;i<t.length;i++)r=t[i].replace(/^##\s/g,"").replace(/\s##$/g,""),n=n.replace(t[i],this.get(r));return n},get:function(t){var i="";return typeof this.vars[t]!="undefined"?i=this.vars[t]:this.opts.lang!=="en"&&typeof n.lang.en[t]!="undefined"&&(i=n.lang.en[t]),i},_build:function(t){var i=n.lang.en;return t!=="en"&&(i=n.lang[t]!==undefined?n.lang[t]:i),i}});n.add("service","callback",{init:function(n){this.app=n;this.opts=n.opts;this.callbacks={};this.opts.callbacks&&this._set(this.opts.callbacks,"")},stop:function(){this.callbacks={}},add:function(n,t){this.callbacks[n]||(this.callbacks[n]=[]);this.callbacks[n].push(t)},remove:function(n,t){if(t===undefined)delete this.callbacks[n];else{for(var i=0;i<this.callbacks[n].length;i++)this.callbacks[n].splice(i,1);Object.keys(this.callbacks[n]).length===0&&delete this.callbacks[n]}},trigger:function(n,t){var i=this._loop(n,t,this.callbacks);return typeof i=="undefined"?t[0]:i},_set:function(n,t){var i,r;for(i in n)r=t===""?i:t+"."+i,typeof n[i]=="object"?this._set(n[i],r):(this.callbacks[r]=[],this.callbacks[r].push(n[i]))},_loop:function(n,t,i){var f,r,u;for(r in i)if(n===r)for(u=0;u<i[r].length;u++)f=i[r][u].apply(this.app,t);return f}});n.add("service","animate",{init:function(n){this.animationOpt=n.opts.animation},start:function(t,i,r,u){var f={duration:!1,iterate:!1,delay:!1,timing:!1,prefix:"redactor-"};return f=typeof r=="function"?f:n.extend(f,r),u=typeof r=="function"?r:u,new n.AnimatePlay(t,i,f,u,this.animationOpt)},stop:function(t){var r,i;this.$el=n.dom(t);this.$el.removeClass("redactor-animated");r=this.$el.attr("redactor-animate-effect");this.$el.removeClass(r);this.$el.removeAttr("redactor-animate-effect");i=this.$el.attr("redactor-animate-hide");i&&this.$el.addClass(i).removeAttr("redactor-animate-hide");this.$el.off("animationend webkitAnimationEnd")}});n.AnimatePlay=function(t,i,r,u,f){return this.hidableEffects=["fadeOut","flipOut","slideUp","zoomOut","slideOutUp","slideOutRight","slideOutLeft"],this.prefixes=["","-webkit-"],this.$el=n.dom(t),this.$body=n.dom("body"),this.callback=u,this.animation=f?i:this.buildAnimationOff(i),this.defaults=r,this.animation==="slideUp"&&this.$el.height(this.$el.height()),this.isInanimate()?this.inanimate():this.animate()};n.AnimatePlay.prototype={buildAnimationOff:function(n){return this.isHidable(n)?"hide":"show"},buildHideClass:function(){return"redactor-animate-hide"},isInanimate:function(){return this.animation==="show"||this.animation==="hide"},isAnimated:function(){return this.$el.hasClass("redactor-animated")},isHidable:function(n){return this.hidableEffects.indexOf(n)!==-1},inanimate:function(){this.defaults.timing="linear";var n;return this.animation==="show"?(n=this.buildHideClass(),this.$el.attr("redactor-animate-hide",n),this.$el.removeClass(n)):(n=this.$el.attr("redactor-animate-hide"),this.$el.addClass(n).removeAttr("redactor-animate-hide")),typeof this.callback=="function"&&this.callback(this),this},animate:function(){var n=this.defaults.delay?this.defaults.delay:0;return setTimeout(function(){if(this.$body.addClass("no-scroll-x"),this.$el.addClass("redactor-animated"),!this.$el.attr("redactor-animate-hide")){var n=this.buildHideClass();this.$el.attr("redactor-animate-hide",n);this.$el.removeClass(n)}this.$el.addClass(this.defaults.prefix+this.animation);this.$el.attr("redactor-animate-effect",this.defaults.prefix+this.animation);this.set(this.defaults.duration+"s",this.defaults.iterate,this.defaults.timing);this.complete()}.bind(this),n*1e3),this},set:function(n,t,i){for(var r=this.prefixes.length;r--;)(n!==!1||n==="")&&this.$el.css(this.prefixes[r]+"animation-duration",n),(t!==!1||t==="")&&this.$el.css(this.prefixes[r]+"animation-iteration-count",t),(i!==!1||i==="")&&this.$el.css(this.prefixes[r]+"animation-timing-function",i)},clean:function(){this.$body.removeClass("no-scroll-x");this.$el.removeClass("redactor-animated");this.$el.removeClass(this.defaults.prefix+this.animation);this.$el.removeAttr("redactor-animate-effect");this.set("","","")},complete:function(){this.$el.one("animationend webkitAnimationEnd",function(){if(this.$el.hasClass(this.defaults.prefix+this.animation)&&this.clean(),this.isHidable(this.animation)){var n=this.$el.attr("redactor-animate-hide");this.$el.addClass(n).removeAttr("redactor-animate-hide")}this.animation==="slideUp"&&this.$el.height("");typeof this.callback=="function"&&this.callback(this.$el)}.bind(this))}};n.add("service","caret",{init:function(n){this.app=n},setStart:function(n){this._setCaret("Start",n)},setEnd:function(n){this._setCaret("End",n)},setBefore:function(n){this._setCaret("Before",n)},setAfter:function(n){this._setCaret("After",n)},isStart:function(n){return this._isStartOrEnd(n,"First")},isEnd:function(n){return this._isStartOrEnd(n,"Last")},setAtEnd:function(n){var r=this.inspector.parse(n),u=r.getTag(),t=document.createRange(),i;this._isInPage(n)&&(u==="a"?(i=this.utils.createInvisibleChar(),n.appendChild(i),t.setStartBefore(i),t.collapse(!0)):(t.selectNodeContents(n),t.collapse(!1)),this.selection.setRange(t))},setAtStart:function(n){var t=document.createRange(),r=this.inspector.parse(n),i;this._isInPage(n)&&(t.setStart(n,0),t.collapse(!0),(r.isInline()||this.utils.isEmpty(n))&&(i=this.utils.createInvisibleChar(),t.insertNode(i),t.selectNodeContents(i),t.collapse(!1)),this.selection.setRange(t))},setAtBefore:function(n){var r=this.inspector.parse(n),t=document.createRange(),i;this._isInPage(n)&&(t.setStartBefore(n),t.collapse(!0),r.isInline()&&(i=this.utils.createInvisibleChar(),n.parentNode.insertBefore(i,n),t.selectNodeContents(i),t.collapse(!1)),this.selection.setRange(t))},setAtAfter:function(n){var t=document.createRange(),i;this._isInPage(n)&&(t.setStartAfter(n),t.collapse(!0),i=this.utils.createInvisibleChar(),t.insertNode(i),t.selectNodeContents(i),t.collapse(!1),this.selection.setRange(t))},setAtPrev:function(n){var t=n.previousSibling;t&&(t=t.nodeType===3&&this._isEmptyTextNode(t)?t.previousElementSibling:t,t&&this.setEnd(t))},setAtNext:function(n){var t=n.nextSibling;t&&(t=t.nodeType===3&&this._isEmptyTextNode(t)?t.nextElementSibling:t,t&&this.setStart(t))},_setCaret:function(n,t){var i=this.inspector.parse(t),r=i.getNode();r&&(this.component.clearActive(),this["_set"+n](r,i,i.getTag()))},_setStart:function(n,t,i){var r,u,f,e,o,s;if(t.isText())return this.editor.focus(),this.setAtStart(n);if(i==="ul"||i==="ol"){if(n=t.findFirstNode("li"),r=this.utils.getFirstElement(n),u=this.inspector.parse(r),r&&u.isComponent())return this.setStart(u.getComponent())}else if(i==="dl")n=t.findFirstNode("dt");else{if(i==="br"||i==="hr")return this.setBefore(n);if(i==="td"||i==="th"){if(f=t.getFirstElement(n),f)return this.setStart(f)}else{if(i==="table"||i==="tr")return this.setStart(t.findFirstNode("th, td"));if(t.isComponentType("code")&&!t.isFigcaption())return e=t.findLastNode("pre, code"),this.editor.focus(),this.setAtStart(e);if(i==="figure"&&t.isComponentType("table"))return o=t.getTable(),s=this.inspector.parse(o),this.setStart(s.findFirstNode("th, td"));if(!t.isComponentType("table")&&t.isComponent()&&!t.isFigcaption())return this.component.setActive(n)}}this.editor.focus();this._setInline(n,"Start")||this.setAtStart(n)},_setEnd:function(n,t,i){var r,u,f,e,o,s;if(t.isText())return this.editor.focus(),this.setAtEnd(n);if(i==="ul"||i==="ol"){if(n=t.findLastNode("li"),r=this.utils.getLastElement(n),u=this.inspector.parse(r),r&&u.isComponent())return this.setEnd(u.getComponent())}else if(i==="dl")n=t.findLastNode("dd");else{if(i==="br"||i==="hr")return this.setAfter(n);if(i==="td"||i==="th"){if(f=t.getLastElement(),f)return this.setEnd(f)}else{if(i==="table"||i==="tr")return this.setEnd(t.findLastNode("th, td"));if(t.isComponentType("code")&&!t.isFigcaption())return e=t.findLastNode("pre, code"),this.editor.focus(),this.setAtEnd(e);if(i==="figure"&&t.isComponentType("table"))return o=t.getTable(),s=this.inspector.parse(o),this.setEnd(s.findLastNode("th, td"));if(!t.isComponentType("table")&&t.isComponent()&&!t.isFigcaption())return this.component.setActive(n)}}if(this.editor.focus(),!this._setInline(n,"End")){if(this.utils.isEmpty(n))return this.setStart(n);this.setAtEnd(n)}},_setBefore:function(n,t,i){if(n.nodeType===3||t.isInline())return this.setAtBefore(n);if(t.isFirstTableCell())return this.setAtPrev(t.getComponent());if(i==="td"||i==="th")return this.setAtPrev(n);if(t.isFirstListItem())return this.setAtPrev(t.getList());if(t.isFigcaption())return this.setStart(t.getComponent());if(!t.isComponentType("table")&&t.isComponent())return this.setAtPrev(t.getComponent());if(t.isBlock())return this.setAtPrev(n);this.editor.focus();this.setAtBefore(n)},_setAfter:function(n,t,i){if(n.nodeType===3||t.isInline())return this.setAtAfter(n);if(t.isLastTableCell())return this.setAtNext(t.getComponent());if(i==="td"||i==="th")return this.setAtNext(n);if(t.isFirstListItem())return this.setAtNext(t.getList());if(!t.isComponentType("table")&&t.isComponent())return this.setAtNext(t.getComponent());if(t.isBlock())return this.setAtNext(n);this.editor.focus();this.setAtAfter(n)},_setInline:function(n,t){var i=this._hasInlineChild(n,t==="Start"?"first":"last");if(i)return t==="Start"?this.setStart(i):this.setEnd(i),!0},_isStartOrEnd:function(n,t){var i=this.utils.getNode(n),r,u,f;return i?(r=this.inspector.parse(i),i=this._getStartEndNode(i,r,t),i&&(u=i.nodeType===3?i.textContent:i.innerHTML,u=this.utils.trimSpaces(u),u===""))?!0:!r.isFigcaption()&&r.isComponent()&&!r.isComponentEditable()?!0:(f=this.offset.get(i,!0),f?t==="First"?f.start===0:f.end===this.offset.size(i,!0):!1):!1},_isInPage:function(n){return n&&n.nodeType?n===document.body?!1:document.body.contains(n):!1},_hasInlineChild:function(t,i){var u=this.inspector.parse(t),r=i==="first"?u.getFirstNode():u.getLastNode(),f=n.dom(r);if(r&&r.nodeType!==3&&this.inspector.isInlineTag(r.tagName)&&!f.hasClass("redactor-component")&&!f.hasClass("non-editable"))return r},_isEmptyTextNode:function(n){var t=n.textContent.trim().replace(/\n/,"");return t=this.utils.removeInvisibleChars(t),t===""},_getStartEndNode:function(n,t,i){return t.isFigcaption()?n=t.getFigcaption():t.isTable()?n=t["find"+i+"Node"]("th, td"):t.isList()?n=t["find"+i+"Node"]("li"):t.isComponentType("code")&&(n=t.findLastNode("pre, code")),n}});n.add("service","selection",{init:function(n){this.app=n},is:function(){var t=this.get(),i,n;return t?(i=t.anchorNode,n=this.inspector.parse(i),n.isInEditor()||n.isEditor()):!1},isCollapsed:function(){var n=this.get(),t=this.getRange();return n&&n.isCollapsed?!0:t&&t.toString().length===0?!0:!1},isBackwards:function(){var i=!1,n=this.get(),t;return n&&!n.isCollapsed&&(t=document.createRange(),t.setStart(n.anchorNode,n.anchorOffset),t.setEnd(n.focusNode,n.focusOffset),i=t.collapsed,t.detach()),i},isIn:function(t){var i=n.dom(t).get(),r=this.getCurrent();return r&&i?i.contains(r):!1},isText:function(){var t=this.get();if(t){var i=t.anchorNode,n=this.getBlock(i),r=this.getBlocks();if(n&&this.inspector.isTableCellTag(n.tagName)||n===!1&&r.length===0)return!0}return!1},isAll:function(n){var t=this.utils.getNode(n),i,f,o,r,s,h,u,e;return t?(i=this.editor.isEditor(t),f=this.inspector.parse(t),!f.isFigcaption()&&this.component.isNonEditable(t)&&this.component.isActive(t))?!0:i&&(o=this.editor.getElement(),r=this.cleaner.output(o.html()),r=r.replace(/<p><\/p>$/i,""),s=this.getHtml().length,h=r.length,s!==h)?!1:i&&this.editor.isEmpty()||this.isCollapsed()?!1:(u=this.offset.get(t,!0),e=this.offset.size(t,!0),!i&&f.isComponentType("code")&&(e=this.getText().trim().length),u&&u.start===0&&u.end===e)?!0:!1:!1},hasNonEditable:function(){var t=this.getHtml(),i=n.dom("<div>").html(t);return!this.isCollapsed()&&i.find(".non-editable").length!==0},setRange:function(n){var t=window.getSelection();t.removeAllRanges();t.addRange(n)},setAll:function(t){var i=this.utils.getNode(t),r,f,e,u;i&&(r=this.inspector.parse(i),this.component.clearActive(),this.editor.focus(),this.editor.saveScroll(),this.editor.disableNonEditables(),i&&i.tagName==="TABLE"?(f=r.findFirstNode("td, th"),e=r.findLastNode("td, th"),n.dom(f).prepend(this.marker.build("start")),n.dom(e).append(this.marker.build("end")),this.restoreMarkers()):!r.isFigcaption()&&this.component.isNonEditable(i)?this.component.setActive(i):(r.isComponentType("code")&&(i=r.getComponentCodeElement(),i.focus()),u=document.createRange(),u.selectNodeContents(i),this.setRange(u)),this.editor.enableNonEditables(),this.editor.restoreScroll())},get:function(){var n=window.getSelection();return n.rangeCount>0?n:null},getRange:function(){var n=this.get();return n?n.getRangeAt(0)?n.getRangeAt(0):null:null},getTextBeforeCaret:function(n){n=typeof n=="undefined"?1:n;var r=this.editor.getElement().get(),t=this.getRange(),i=!1;return t&&(t=t.cloneRange(),t.collapse(!0),t.setStart(r,0),i=t.toString().slice(-n)),i},getTextAfterCaret:function(n){var i;n=typeof n=="undefined"?1:n;var u=this.editor.getElement().get(),t=this.getRange(),r=!1;return t&&(i=t.cloneRange(),i.selectNodeContents(u),i.setStart(t.endContainer,t.endOffset),r=i.toString().slice(0,n)),r},getPosition:function(){var n=this.getRange(),r={top:0,left:0,width:0,height:0},i,t;return window.getSelection&&n.getBoundingClientRect&&(n=n.cloneRange(),i=n.startOffset-1,n.setStart(n.startContainer,i<0?0:i),t=n.getBoundingClientRect(),r={top:t.top,left:t.left,width:t.right-t.left,height:t.bottom-t.top}),r},getCurrent:function(){var n=!1,t=this.get(),i=this.component.getActive(),r;return i?n=i:t&&this.is()&&(r=this.inspector.parse(t.anchorNode),n=r.isEditor()?!1:t.anchorNode),n},getParent:function(){var t=!1,i=this.getCurrent(),n,r;return i&&(n=i.parentNode,r=this.inspector.parse(n),t=r.isEditor()?!1:n),t},getElement:function(n){for(var t=n||this.getCurrent(),i;t;){if(i=this.inspector.parse(t),i.isElement()&&i.isInEditor())return t;t=t.parentNode}return!1},getInline:function(n){for(var t=n||this.getCurrent(),i=!1;t;)this._isInlineNode(t)&&(i=t),t=t.parentNode;return i},getInlineFirst:function(n){for(var t=n||this.getCurrent();t;){if(this._isInlineNode(t))return t;t=t.parentNode}return!1},getInlineAll:function(n){for(var t=n||this.getCurrent(),i=[];t;)this._isInlineNode(t)&&i.push(t),t=t.parentNode;return i},getBlock:function(n){for(var t=n||this.getCurrent(),i,r;t;){if(i=this.inspector.parse(t),r=this.inspector.isBlockTag(t.tagName),r&&i.isInEditor(t))return t;t=t.parentNode}return!1},getInlinesAllSelected:function(n){var r;if(this.isAll())return[];var t=this.getInlines({all:!0}),f=this.getNodes({textnodes:!0,inline:!1}),u=this.getText().replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),i=[];if(f.length!==0)return i;if(u==="")i=t;else if(t.length>1)for(r=0;r<t.length;r++)this._isTextSelected(t[r],u)&&i.push(t[r]);else t.length===1&&this._isTextSelected(t[0],u)&&(i=t);return n&&n.tags?this._filterNodesByTags(i,n.tags):i},getInlines:function(n){for(var t,u=this.getNodes(),i=[],r=0;r<u.length;r++)if(n&&n.all)for(t=u[r];t;)this._isInlineNode(t)&&!this._isInNodesArray(i,t)&&i.push(t),t=t.parentNode;else t=this.getInline(u[r]),t&&!this._isInNodesArray(i,t)&&i.push(t);return i=n&&n.tags?this._filterNodesByTags(i,n.tags):i,n&&n.inside?this._filterInlinesInside(i,n):i},getBlocks:function(n){var i=this.getNodes(),f=this.getBlock(),t,r,u;for(i=i.length===0&&f?[f]:i,t=[],r=0;r<i.length;r++)u=this.getBlock(i[r]),u&&!this._isInNodesArray(t,u)&&t.push(u);return t=n&&n.tags?this._filterNodesByTags(t,n.tags):t,n&&n.first?this._filterBlocksFirst(t,n):t},getElements:function(n){var t=this.getNodes({textnodes:!1}),u=this.getBlock(),i,r;for(t=t.length===0&&u?[u]:t,i=[],r=0;r<t.length;r++)this._isInNodesArray(i,t[r])||i.push(t[r]);return n&&n.tags?this._filterNodesByTags(i,n.tags):i},getNodes:function(n){var t=[],i=this.component.getActive(),r;return i?t=this._getNodesComponent(i):this.isCollapsed()?(r=this.getCurrent(),t=r?[r]:[]):this.is()&&!i&&(t=this._getRangeSelectedNodes()),t=this._filterServicesNodes(t),t=this._filterEditor(t),t=n&&n.tags?this._filterNodesByTags(t,n.tags):t,t=n&&n.textnodes?this._filterNodesTexts(t,n):t,n&&!n.textnodes?this._filterNodesElements(t):t},getText:function(){var n=this.get();return n?this.utils.removeInvisibleChars(n.toString()):""},getHtml:function(n){var t="",r=this.get(),u,f,i;if(r){for(u=document.createElement("div"),f=r.rangeCount,i=0;i<f;++i)u.appendChild(r.getRangeAt(i).cloneContents());t=u.innerHTML;t=n!==!1?this.cleaner.output(t):t;t=t.replace(/<p><\/p>$/i,"")}return t},clear:function(){this.component.clearActive();this.get().removeAllRanges()},collapseToStart:function(){var n=this.get();n&&!n.isCollapsed&&n.collapseToStart()},collapseToEnd:function(){var n=this.get();n&&!n.isCollapsed&&n.collapseToEnd()},saveActiveComponent:function(){var n=this.component.getActive();return n?(this.savedComponent=n,!0):!1},restoreActiveComponent:function(){return this.savedComponent?(this.component.setActive(this.savedComponent),!0):!1},save:function(){this._clearSaved();var n=this.getElement();n&&(n.tagName==="TD"||n.tagName==="TH")&&n.innerHTML===""?this.savedElement=n:this.saveActiveComponent()||(this.saved=this.offset.get())},restore:function(){(this.saved||this.savedComponent||this.savedElement)&&(this.editor.saveScroll(),this.savedElement?this.caret.setStart(this.savedElement):this.restoreActiveComponent()||this.offset.set(this.saved),this._clearSaved(),this.editor.restoreScroll())},saveMarkers:function(){this._clearSaved();this.saveActiveComponent()||this.marker.insert()},restoreMarkers:function(){this.editor.saveScroll();this.restoreActiveComponent()||this.marker.restore();this._clearSaved();this.editor.restoreScroll()},_getNextNode:function(n){if(n.hasChildNodes())return n.firstChild;while(n&&!n.nextSibling)n=n.parentNode;return n?n.nextSibling:null},_getNodesComponent:function(n){var i=this.getCurrent(),t=this.inspector.parse(i);return t.isFigcaption()?[t.getFigcaption()]:[n]},_getRangeSelectedNodes:function(){var t=[],i=this.getRange(),n=i.startContainer,f=i.startContainer,r=i.endContainer,u=this.editor.getElement();if(f===u.get()&&this.isAll())t=this.utils.getChildNodes(u);else if(n==r)t=[n];else{while(n&&n!=r)t.push(n=this._getNextNode(n));for(n=i.startContainer;n&&n!=i.commonAncestorContainer;)t.unshift(n),n=n.parentNode}return t},_isInNodesArray:function(n,t){return n.indexOf(t)!==-1},_filterEditor:function(n){for(var r,i=[],t=0;t<n.length;t++)r=this.inspector.parse(n[t]),r.isInEditor()&&i.push(n[t]);return i},_filterServicesNodes:function(t){for(var r,u,f=[],i=0;i<t.length;i++)r=n.dom(t[i]),u=!1,t[i]&&t[i].nodeType===3&&this.utils.isEmpty(t[i])&&(u=!0),(r.hasClass("redactor-script-tag")||r.hasClass("redactor-component-caret")||r.hasClass("redactor-selection-marker")||r.hasClass("non-editable"))&&(u=!0),u||f.push(t[i]);return f},_filterNodesTexts:function(n,t){for(var u,f,r=[],i=0;i<n.length;i++)(n[i].nodeType===3||t.keepbr&&n[i].tagName==="BR")&&(u=this.getInline(n[i]),f=u&&t&&t.inline===!1,f||r.push(n[i]));return r},_filterNodesElements:function(n){for(var i=[],t=0;t<n.length;t++)n[t].nodeType!==3&&i.push(n[t]);return i},_filterNodesByTags:function(n,t,i){for(var f,u=[],r=0;r<n.length;r++)i&&n[r].nodeType===3?u.push(n[r]):n[r].nodeType!==3&&(f=n[r].tagName.toLowerCase(),t.indexOf(f.toLowerCase())!==-1&&u.push(n[r]));return u},_filterBlocksFirst:function(t){for(var u=[],i=0;i<t.length;i++){var f=n.dom(t[i]),r=f.parent().get(),e=f.parent().hasClass("redactor-in"),o=r&&(r.tagName==="TD"||r.tagName==="TH");(e||o)&&u.push(t[i])}return u},_filterInlinesInside:function(n){for(var i=[],t=0;t<n.length;t++)window.getSelection().containsNode(n[t],!0)&&i.push(n[t]);return i},_isTextSelected:function(n,t){var i=this.utils.removeInvisibleChars(n.textContent);return t===i||i.search(t)!==-1||t.search(new RegExp("^"+i))!==-1||t.search(new RegExp(i+"$"))!==-1},_isInlineNode:function(n){var t=this.inspector.parse(n);return this.inspector.isInlineTag(n.tagName)&&t.isInEditor()},_clearSaved:function(){this.saved=!1;this.savedComponent=!1;this.savedElement=!1}});n.add("service","element",{init:function(n){this.app=n;this.rootElement=n.rootElement;this.$element={};this.type="inline"},start:function(){this._build();this._buildType()},isType:function(n){return n===this.type},getType:function(){return this.type},getElement:function(){return this.$element},_build:function(){this.$element=n.dom(this.rootElement)},_buildType:function(){var n=this.$element.get().tagName;this.type=n==="TEXTAREA"?"textarea":this.type;this.type=n==="DIV"?"div":this.type;this.type=this.opts.inline?"inline":this.type}});n.add("service","editor",{init:function(n){this.app=n;this.scrolltop=!1;this.pasting=!1},start:function(){this._build()},focus:function(){this.isFocus()||this._isContenteditableFocus()||(this.saveScroll(),this.$editor.focus(),this.restoreScroll())},startFocus:function(){this.caret.setStart(this.getFirstNode())},endFocus:function(){this.caret.setEnd(this.getLastNode())},isPasting:function(){return this.pasting},enablePasting:function(){this.pasting=!0},disablePasting:function(){this.pasting=!1},saveScroll:function(){this.scrolltop=this._getScrollTarget().scrollTop()},restoreScroll:function(){this.scrolltop!==!1&&(this._getScrollTarget().scrollTop(this.scrolltop),this.scrolltop=!1)},disableNonEditables:function(){this.$noneditables=this.$editor.find("[contenteditable=false]");this.$noneditables.attr("contenteditable",!0)},enableNonEditables:function(){this.$noneditables&&setTimeout(function(){this.$noneditables.attr("contenteditable",!1)}.bind(this),1)},getFirstNode:function(){return this.$editor.contents()[0]},getLastNode:function(){var n=this.$editor.contents();return n[n.length-1]},isSourceMode:function(){var n=this.source.getElement();return n.hasClass("redactor-source-open")},isEditor:function(t){var i=n.dom(t).get();return i===this.$editor.get()},isEmpty:function(n){return this.utils.isEmptyHtml(this.$editor.html(),!1,n)},isFocus:function(){var t=n.dom(document.activeElement),i=this.$editor.find(".redactor-component-active").length!==0;return i||t.closest(".redactor-in-"+this.uuid).length!==0},setEmpty:function(){this.$editor.html(this.opts.emptyHtml)},getElement:function(){return this.$editor},_build:function(){var t=this.element.getElement(),i=this.element.isType("textarea")?"<div>":t.get();this.$editor=n.dom(i)},_getScrollTarget:function(){return this.opts.scrollTarget?n.dom(this.opts.scrollTarget):this.$doc},_isContenteditableFocus:function(){var t=this.selection.getBlock(),i=t?n.dom(t).closest("[contenteditable=true]").not(".redactor-in"):[];return i.length!==0}});n.add("service","container",{init:function(n){this.app=n},start:function(){this._build()},getElement:function(){return this.$container},_build:function(){var t=this.element.isType("inline")?"<span>":"<div>";this.$container=n.dom(t)}});n.add("service","source",{init:function(n){this.app=n;this.$source={};this.content=""},start:function(){this._build();this._buildName();this._buildStartedContent()},getElement:function(){return this.$source},getCode:function(){return this.$source.val()},getName:function(){return this.$source.attr("name")},getStartedContent:function(){return this.content},setCode:function(n){return this.insertion.set(n,!0,!1)},isNameGenerated:function(){return this.name},_build:function(){var t=this.element.getElement(),i=this.element.isType("textarea"),r=i?t.get():"<textarea>";this.$source=n.dom(r)},_buildName:function(){var n=this.element.getElement();this.name=n.attr("name");this.$source.attr("name",this.name?this.name:"content-"+this.uuid)},_buildStartedContent:function(){var n=this.element.getElement(),t=this.element.isType("textarea")?n.val():n.html();this.content=t.trim()}});n.add("service","statusbar",{init:function(n){this.app=n;this.$statusbar={};this.items=[]},start:function(){this.$statusbar=n.dom("<ul>");this.$statusbar.attr("dir",this.opts.direction)},add:function(n,t){return this.update(n,t)},update:function(t,i){var r;return typeof this.items[t]!="undefined"?r=this.items[t]:(r=n.dom("<li>"),this.$statusbar.append(r),this.items[t]=r),r.html(i)},get:function(n){return this.items[n]?this.items[n]:!1},remove:function(n){this.items[n]&&(this.items[n].remove(),delete this.items[n])},getItems:function(){return this.items},removeItems:function(){this.items={};this.$statusbar.html("")},getElement:function(){return this.$statusbar}});n.add("service","toolbar",{init:function(n){this.app=n;this.dropdownOpened=!1;this.buttonsObservers={}},start:function(){this.is()&&(this.opts.activeButtons=this.opts.activeButtonsAdd?this._extendActiveButtons():this.opts.activeButtons,this.create())},stopObservers:function(){this.buttonsObservers={}},create:function(){this.$wrapper=n.dom("<div>");this.$toolbar=n.dom("<div>")},observe:function(){var n,r,t,i;if(this.is()){this.setButtonsInactive();for(t in this.buttonsObservers)r=this.buttonsObservers[t],n=this.getButton(t),this.app.broadcast("button."+r+".observe",n);var u=this.opts.activeButtons,f=this.selection.getInlinesAllSelected(),e=this._inlinesToTags(f);for(i in u)e.indexOf(i)!==-1&&(n=this.getButton(u[i]),n.setActive())}},is:function(){return!(!this.opts.toolbar||this.detector.isMobile()&&this.opts.air)},isAir:function(){return this.is()?this.$toolbar.hasClass("redactor-air"):!1},isFixed:function(){return this.is()?this.$toolbar.hasClass("redactor-toolbar-fixed"):!1},isContextBar:function(){var n=this.$body.find("#redactor-context-toolbar-"+this.uuid);return n.hasClass("open")},isTarget:function(){return this.opts.toolbarFixedTarget!==document},getElement:function(){return this.$toolbar},getWrapper:function(){return this.$wrapper},getDropdown:function(){return this.dropdownOpened},getTargetElement:function(){return n.dom(this.opts.toolbarFixedTarget)},getButton:function(n){var t=this._findButton(".re-"+n);return t.length!==0?t.dataget("data-button-instance"):!1},getButtonByIndex:function(n){var t=this.$toolbar.find(".re-button").eq(n);return t.length!==0?t.dataget("data-button-instance"):!1},getButtons:function(){var t=[];return this._findButtons().each(function(i){var r=n.dom(i);t.push(r.dataget("data-button-instance"))}),t},getButtonsKeys:function(){var t=[];return this._findButtons().each(function(i){var r=n.dom(i);t.push(r.attr("data-re-name"))}),t},addButton:function(t,i,r,u,f){var e,o;return r=r||"end",e=n.create("toolbar.button",this.app,t,i),i.observe&&(this.opts.activeButtonsObservers[t]={observe:i.observe,button:e}),f!==!0&&(o=this.opts.buttons.indexOf(t),o===0?r="first":o!==-1&&(u=this.getButtonByIndex(o-1),u&&(r="after"))),this.is()&&(r==="first"?this.$toolbar.prepend(e):r==="after"?u.after(e):r==="before"?u.before(e):this.$toolbar.append(e)),e},addButtonFirst:function(n,t){return this.addButton(n,t,"first")},addButtonAfter:function(n,t,i){var r=this.getButton(n);return r?this.addButton(t,i,"after",r):this.addButton(t,i)},addButtonBefore:function(n,t,i){var r=this.getButton(n);return r?this.addButton(t,i,"before",r):this.addButton(t,i)},addButtonObserver:function(n,t){this.buttonsObservers[n]=t},setDropdown:function(n){this.dropdownOpened=n},setButtonsInactive:function(){for(var t=this.getButtons(),n=0;n<t.length;n++)t[n].setInactive()},setButtonsActive:function(){for(var t=this.getButtons(),n=0;n<t.length;n++)t[n].setActive()},disableButtons:function(){for(var t=this.getButtons(),n=0;n<t.length;n++)t[n].disable()},enableButtons:function(){for(var t=this.getButtons(),n=0;n<t.length;n++)t[n].enable()},_findButton:function(t){return this.is()?this.$toolbar.find(t):n.dom()},_findButtons:function(){return this.is()?this.$toolbar.find(".re-button"):n.dom()},_extendActiveButtons:function(){return n.extend({},this.opts.activeButtons,this.opts.activeButtonsAdd)},_inlinesToTags:function(n){for(var i=[],t=0;t<n.length;t++)i.push(n[t].tagName.toLowerCase());return i}});n.add("class","toolbar.button",{mixins:["dom"],init:function(n,t,i){this.app=n;this.opts=n.opts;this.lang=n.lang;this.$body=n.$body;this.toolbar=n.toolbar;this.detector=n.detector;this.obj=i;this.name=t;this.dropdown=!1;this.tooltip=!1;this._init()},isActive:function(){return this.hasClass("redactor-button-active")},isDisabled:function(){return this.hasClass("redactor-button-disabled")},hasIcon:function(){return this.obj.icon&&!this.opts.buttonsTextLabeled},setDropdown:function(t){this.obj.dropdown=t;this.obj.message=!1;this.dropdown=n.create("toolbar.dropdown",this.app,this.name,this.obj.dropdown);this.attr("data-dropdown",!0)},setMessage:function(n,t){this.obj.message=n;this.obj.args=t;this.obj.dropdown=!1},setApi:function(n,t){this.obj.api=n;this.obj.args=t;this.obj.dropdown=!1},setTitle:function(n){this.obj.title=this.lang.parse(n);this.obj.tooltip=this.obj.title;this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip});this.attr("data-re-icon")||this.html(this.obj.title)},setTooltip:function(n){this.obj.tooltip=this.lang.parse(n);this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip})},setIcon:function(t){this.opts.buttonsTextLabeled||(this.obj.icon=!0,this.$icon=n.dom(t),this.html(""),this.append(this.$icon),this.attr("data-re-icon",!0),this.addClass("re-button-icon"),this.setTooltip(this.obj.title),this._buildTooltip())},setActive:function(){this.addClass("redactor-button-active")},setInactive:function(){this.removeClass("redactor-button-active")},hideTooltip:function(){this.$body.find(".re-button-tooltip").remove()},getDropdown:function(){return this.dropdown},disable:function(){this.addClass("redactor-button-disabled")},enable:function(){this.removeClass("redactor-button-disabled")},toggle:function(n){(n&&n.preventDefault(),this.isDisabled())||(this.obj.dropdown?this.dropdown.toggle(n):this.obj.api?this.app.api(this.obj.api,this.obj.args,this.name):this.obj.message&&this.app.broadcast(this.obj.message,this.obj.args,this.name),this.hideTooltip())},_init:function(){this._parseTitle();this._parseTooltip();this._build();this._buildCallback();this._buildAttributes();this._buildObserver();this.hasIcon()?(this._buildIcon(),this._buildTooltip()):this.html(this.obj.title)},_parseTooltip:function(){this.obj.tooltip=this.obj.tooltip?this.lang.parse(this.obj.tooltip):this.obj.title},_parseTitle:function(){this.obj.title=this.lang.parse(this.obj.title)},_build:function(){this.parse("<a>");this.addClass("re-button re-"+this.name);this.attr("data-re-name",this.name);this.dataset("data-button-instance",this);this.obj.dropdown&&this.setDropdown(this.obj.dropdown)},_buildCallback:function(){this.on("click",this.toggle.bind(this))},_buildAttributes:function(){var n={href:"#",alt:this.obj.tooltip,rel:this.name,role:"button","aria-label":this.obj.tooltip,tabindex:"-1"};this.attr(n)},_buildObserver:function(){typeof this.obj.observe!="undefined"&&this.toolbar.addButtonObserver(this.name,this.obj.observe)},_buildIcon:function(){var t=this.obj.icon,i=/(<([^>]+)>)/ig.test(t);this.$icon=i?n.dom(t):n.dom("<i>");i||this.$icon.addClass("re-icon-"+this.name);this.append(this.$icon);this.attr("data-re-icon",!0);this.addClass("re-button-icon")},_buildTooltip:function(){this.detector.isDesktop()&&(this.tooltip=n.create("toolbar.button.tooltip",this.app,this))}});n.add("class","toolbar.button.tooltip",{mixins:["dom"],init:function(n,t){this.app=n;this.opts=n.opts;this.$body=n.$body;this.toolbar=n.toolbar;this.$button=t;this.created=!1;this._init()},open:function(){if(!this.$button.hasClass("redactor-button-disabled")&&!this.$button.hasClass("redactor-button-active")){this.created=!0;this.parse("<span>");this.addClass("re-button-tooltip");this.$body.append(this);this.html(this.$button.attr("alt"));var n=this.$button.offset(),t=this.$button.height(),i=this.$button.width();this.css({top:n.top+t+4+"px",left:n.left+i/2-this.width()/2+"px",position:"absolute"});this.show()}},close:function(){this.created&&!this.$button.hasClass("redactor-button-disabled")&&(this.remove(),this.created=!1)},_init:function(){this.$button.on("mouseover",this.open.bind(this));this.$button.on("mouseout",this.close.bind(this))}});n.add("class","toolbar.dropdown",{mixins:["dom"],init:function(n,t,i){this.app=n;this.uuid=n.uuid;this.opts=n.opts;this.$win=n.$win;this.$doc=n.$doc;this.$body=n.$body;this.animate=n.animate;this.toolbar=n.toolbar;this.name=t;this.started=!1;this.items=i;this.$items=[]},toggle:function(n){this.started||this._build();this.isOpened()&&this.isActive()?this.close(!1):this.open(n)},isOpened:function(){var n=this.$body.find(".redactor-dropdown-"+this.uuid+".open");return n.length!==0&&n.attr("data-re-name")===this.name},isActive:function(){var n=this.$body.find("#redactor-dropdown-"+this.uuid+"-"+this.name+".open");return n.length!==0},getName:function(){return this.attr("data-re-name")},getItem:function(n){return this.$items[n]},getItemsByClass:function(n){var t=[];for(var i in this.$items)this.$items[i].hasClass(n)&&t.push(this.$items[i]);return t},open:function(n){this._closeAll();this.$btn=this.toolbar.getButton(this.name);this.app.broadcast("dropdown.open",n,this,this.$btn);this.toolbar.setDropdown(this);this.show();this.removeClass("redactor-animate-hide");this.addClass("open");this._observe();this.$btn.hideTooltip();this.$btn.setActive();this.$doc.on("keyup.redactor.dropdown-"+this.uuid,this._handleKeyboard.bind(this));this.$doc.on("click.redactor.dropdown-"+this.uuid+" touchstart.redactor.dropdown-"+this.uuid,this.close.bind(this));this.updatePosition();this.app.broadcast("dropdown.opened",n,this,this.$btn)},close:function(t,i){if(t){var r=n.dom(t.target);if(this._isButton(t)||r.hasClass("redactor-dropdown-not-close")||r.hasClass("redactor-dropdown-item-disabled")){t.preventDefault();return}}this.app.broadcast("dropdown.close",this,this.$btn);this.toolbar.setDropdown(!1);this.$btn.setInactive();i===!1?this._close():this.animate.start(this,"fadeOut",this._close.bind(this))},updatePosition:function(){var t=this.toolbar.isFixed(),n=this.$btn.offset();n.top=t?this.$btn.position().top:n.top;var u=this.$btn.height(),f=this.$btn.width(),e=t?"fixed":"absolute",i=n.left+0,r=parseFloat(this.css("width")),o=this.$win.width()<i+r?r-f:0;this.css({position:e,top:n.top+u+2+"px",left:i-o+"px"})},_build:function(){this.parse("<div>");this.attr("dir",this.opts.direction);this.attr("id","redactor-dropdown-"+this.uuid+"-"+this.name);this.attr("data-re-name",this.name);this.addClass("redactor-dropdown redactor-dropdown-"+this.uuid+" redactor-dropdown-"+this.name);this.dataset("data-dropdown-instance",this);var n=this.items.dom||typeof this.items=="string";n?this._buildDom():this._buildItems();this.$body.append(this);this.started=!0},_buildDom:function(){this.html("").append(n.dom(this.items))},_buildItems:function(){var t,r,i;this.items=this.name==="format"?this._buildFormattingItems():this.items;for(t in this.items)r=this.items[t],t==="observe"?this.attr("data-observe",this.items[t]):(i=n.create("toolbar.dropdown.item",this.app,t,r,this),this.$items[t]=i,this.append(i))},_buildFormattingItems:function(){for(var n in this.items)this.opts.formatting.indexOf(n)===-1&&delete this.items[n];if(this.opts.formattingHide)for(n in this.items)this.opts.formattingHide.indexOf(n)!==-1&&delete this.items[n];if(this.opts.formattingAdd)for(n in this.opts.formattingAdd)this.items[n]=this.opts.formattingAdd[n];return this.items},_handleKeyboard:function(n){n.which===27&&this.close()},_isButton:function(t){var i=n.dom(t.target),r=i.closest(".re-button");return r.get()===this.$btn.get()},_close:function(){this.$btn.setInactive();this.$doc.off(".redactor.dropdown-"+this.uuid);this.removeClass("open");this.addClass("redactor-animate-hide");this.app.broadcast("dropdown.closed",this,this.$btn)},_closeAll:function(){this.$body.find(".redactor-dropdown-"+this.uuid+".open").each(function(t){var i=n.dom(t),r=i.dataget("data-dropdown-instance");r._close()})},_observe:function(){var n=this.attr("data-observe");n&&this.app.broadcast("dropdown."+n+".observe",this)}});n.add("class","toolbar.dropdown.item",{mixins:["dom"],init:function(n,t,i,r){this.app=n;this.lang=n.lang;this.dropdown=r;this.name=t;this.obj=i;this._init()},setTitle:function(n){this.$span.html(n)},getTitle:function(){return this.$span.html()},enable:function(){this.removeClass("redactor-dropdown-item-disabled")},disable:function(){this.addClass("redactor-dropdown-item-disabled")},toggle:function(n){(n&&n.preventDefault(),this.hasClass("redactor-dropdown-item-disabled"))||(this.obj.message?this.app.broadcast(this.obj.message,this.obj.args,this.name):this.obj.api&&this.app.api(this.obj.api,this.obj.args,this.name))},_init:function(){this.parse("<a>");this.attr("href","#");this.addClass("redactor-dropdown-item-"+this.name);this.obj.classname&&this.addClass(this.obj.classname);this.attr("data-re-name",this.name);this.on("click",this.toggle.bind(this));this.$span=n.dom("<span>");this.append(this.$span);this.setTitle(this.lang.parse(this.obj.title))}});n.add("service","cleaner",{init:function(n){this.app=n;this.opts=n.opts;this.storedComponents=[];this.storedImages=[];this.storedLinks=[];this.deniedTags=["font","html","head","link","title","body","meta","applet"];this.convertRules={};this.unconvertRules={};this.reComments=/<!--[\s\S]*?-->/g;this.reSpacedEmpty=/^(||\s||<br\s?\/?>||&nbsp;)$/i;this.reScriptTag=/<script(.*?[^>]?)>([\w\W]*?)<\/script>/gi},addConvertRules:function(n,t){this.convertRules[n]=t},addUnconvertRules:function(n,t){this.unconvertRules[n]=t},input:function(t,i){t=this.encodePreCode(t);t=t.replace(/\$/g,"&#36;");t=t.replace(/&amp;/g,"&");var r=n.create("cleaner.figure",this.app);return t=r.convert(t,this.convertRules),t=this.storeComponents(t),t=this.replaceTags(t,this.opts.replaceTags),t=this._setSpanAttr(t),t=this._setStyleCache(t),t=this.removeTags(t,this.deniedTags),t=this.opts.removeScript?this._removeScriptTag(t):this._replaceScriptTag(t),t=this.opts.removeComments?this.removeComments(t):t,t=this._isSpacedEmpty(t)?this.opts.emptyHtml:t,t=this.restoreComponents(t),t=this._cleanWrapped(t),i?this.paragraphize(t):t},output:function(t,i){if((t=this.removeInvisibleSpaces(t),this._isSpacedEmpty(t))||this._isParagraphEmpty(t))return"";t=this.removeServiceTagsAndAttrs(t,i);t=this.storeComponents(t);t=this.removeSpanWithoutAttributes(t);t=this.removeFirstBlockBreaklineInHtml(t);t=this.opts.removeScript?t:this._unreplaceScriptTag(t);t=this.opts.preClass?this._setPreClass(t):t;t=this.opts.linkNofollow?this._setLinkNofollow(t):t;t=this.opts.removeNewLines?this.cleanNewLines(t):t;t=this.restoreComponents(t);var r=n.create("cleaner.figure",this.app);return t=r.unconvert(t,this.unconvertRules),t=this.removeEmptyAttributes(t,["style","class","rel","alt","title"]),t=this.cleanSpacesInPre(t),t=this.tidy(t),t.replace(/&amp;/g,"&")},paste:function(t){var f,r,e,o,s;if(t=this.storeComponents(t),f=this.deniedTags.concat(["iframe"]),t=this.removeTags(t,f),t=t.replace(new RegExp("<!doctype([\\s\\S]+?)>","gi"),""),t=t.replace(new RegExp("<style([\\s\\S]+?)<\/style>","gi"),""),t=t.replace(new RegExp("<\/p><br /><p","gi"),"<\/p><p"),r=this._isHtmlMsWord(t),t=this._cleanGDocs(t),t=r?this._cleanMsWord(t):t,!this.opts.pasteClean)return this.restoreComponents(t);if(this.opts.pastePlainText)return t=this.restoreComponents(t),this.pastePlainText(t);e=this.opts.pasteBlockTags.concat(this.opts.pasteInlineTags);t=this.removeTagsExcept(t,e);t=this.opts.pasteLinks?t:this.removeTags(t,["a"]);t=this.opts.pasteImages?t:this.removeTags(t,["img"]);var i=this.utils.buildWrapper(t),u=i.find("*"),h=this.opts.pasteKeepStyle.length!==0?","+this.opts.pasteKeepStyle.join(","):"";return u.not("[data-redactor-style-cache]"+h).removeAttr("style"),o=this.opts.pasteKeepClass.length!==0?","+this.opts.pasteKeepClass.join(","):"",u.not("[data-redactor-style-cache]"+o).removeAttr("class"),s=this.opts.pasteKeepAttrs.length!==0?","+this.opts.pasteKeepAttrs.join(","):"",u.not("img, a, [data-redactor-style-cache]"+s).each(function(n){while(n.attributes.length>0)n.removeAttribute(n.attributes[0].name)}),this.opts.pasteLinks&&this.opts.pasteLinkTarget!==!1&&i.find("a").attr("target",this.opts.pasteLinkTarget),i.find("[data-redactor-style-cache]").each(function(n){var t=n.getAttribute("data-redactor-style-cache");n.setAttribute("style",t)}),i.find("span").each(function(t){t.attributes.length===0&&n.dom(t).unwrap()}),i.find(this.opts.inlineTags.join(",")).each(function(t){t.attributes.length===0&&this.utils.isEmptyHtml(t.innerHTML)&&n.dom(t).unwrap()}.bind(this)),i.find("ul, ol").each(function(t){var i=t.previousSibling,r;i&&i.tagName==="LI"&&(r=n.dom(i),r.find("p").unwrap(),r.append(t))}),t=this.utils.getWrapperHtml(i),t=t.replace(/<li><p>/gi,"<li>"),t=t.replace(/<\/p><\/li>/gi,"<\/li>"),t=t.replace(/<p>&nbsp;<\/p>/gi,"<p><\/p>"),t=t.replace(/<p><br\s?\/?><\/p>/gi,"<p><\/p>"),r&&(t=t.replace(/<p><\/p>/gi,""),t=t.replace(/<p>\s<\/p>/gi,"")),this.restoreComponents(t)},pastePlainText:function(n){return n=this.opts.pasteLinks?this.storeLinks(n):n,n=this.opts.pasteImages?this.storeImages(n):n,n=this.getPlainText(n),n=this._replaceNlToBr(n),n=this.opts.pasteLinks?this.restoreLinks(n):n,this.opts.pasteImages?this.restoreImages(n):n},tidy:function(n){return n},paragraphize:function(t){var i=n.create("cleaner.paragraphize",this.app);return i.convert(t)},getFlatText:function(t){var i=n.dom("<div>");return t.nodeType||t.dom?i.append(t):(t=t.toString(),t=t.trim(),i.html(t)),t=i.get().textContent||i.get().innerText||"",t===undefined?"":t},getPlainText:function(n){n=n.replace(/<!--[\s\S]*?-->/gi,"");n=n.replace(/<style[\s\S]*?style>/gi,"");n=n.replace(/<p><\/p>/g,"");n=n.replace(/<\/div>|<\/li>|<\/td>/gi,"\n");n=n.replace(/<\/p>/gi,"\n\n");n=n.replace(/<\/H[1-6]>/gi,"\n\n");var t=document.createElement("div");return t.innerHTML=n,n=t.textContent||t.innerText,n.trim()},replaceTags:function(n,t){if(t){var r=this,u=Object.keys(t),i=this.utils.buildWrapper(n);i.find(u.join(",")).each(function(n){r.utils.replaceToTag(n,t[n.tagName.toLowerCase()])});n=this.utils.getWrapperHtml(i)}return n},replaceNbspToSpaces:function(n){return n.replace("&nbsp;"," ")},replaceBlocksToBr:function(n){return n.replace(/<\/div>|<\/li>|<\/td>|<\/p>|<\/H[1-6]>/gi,"<br>")},cleanNewLines:function(n){return n.replace(/\r?\n/g,"")},cleanSpacesInPre:function(n){return n.replace("&nbsp;&nbsp;&nbsp;&nbsp;","    ")},removeInvisibleSpaces:function(n){return n=this.utils.removeInvisibleChars(n),n=n.replace(/&#x200b;/gi,""),n.replace(/&#65279;/gi,"")},removeNl:function(n){return n=n.replace(/\n/g," "),n.replace(/\s+/g,"s")},removeBrAtEnd:function(n){return n=n.replace(/<br\s?\/?>$/gi," "),n.replace(/<br\s?\/?><li/gi,"<li")},removeTags:function(n,t){var i=t?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,r=t?function(n,i){return t.indexOf(i.toLowerCase())===-1?n:""}:"";return n.replace(i,r)},removeTagsExcept:function(n,t){if(t===undefined)return n.replace(/(<([^>]+)>)/gi,"");return n.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(n,i){return t.indexOf(i.toLowerCase())===-1?"":n})},removeComments:function(n){return n.replace(this.reComments,"")},removeServiceTagsAndAttrs:function(t,i){var r=this.utils.buildWrapper(t),u=this;return i!==!1&&r.find(".redactor-selection-marker").each(function(t){var i=n.dom(t),r=u.utils.removeInvisibleChars(i.text());return r===""?i.remove():i.unwrap()}),r.find("[data-redactor-style-cache]").removeAttr("data-redactor-style-cache"),this.utils.getWrapperHtml(r)},removeSpanWithoutAttributes:function(t){var i=this.utils.buildWrapper(t);return i.find("span").removeAttr("data-redactor-span data-redactor-style-cache").each(function(t){t.attributes.length===0&&n.dom(t).unwrap()}),this.utils.getWrapperHtml(i)},removeFirstBlockBreaklineInHtml:function(n){return n.replace(new RegExp("<\/li><br\\s?/?>","gi"),"<\/li>")},removeEmptyAttributes:function(n,t){for(var r=this.utils.buildWrapper(n),i=0;i<t.length;i++)r.find("["+t[i]+'=""]').removeAttr(t[i]);return this.utils.getWrapperHtml(r)},encodeHtml:function(n){return n=n.replace(/<br\s?\/?>/g,"\n"),n=n.replace(/&nbsp;/g," "),n=n.replace(/Ã¢â¬Â/g,'"'),n=n.replace(/Ã¢â¬Å/g,'"'),n=n.replace(/Ã¢â¬Ë/g,"'"),n=n.replace(/Ã¢â¬â¢/g,"'"),n=this.encodeEntities(n),n=n.replace(/\$/g,"&#36;"),this.opts.preSpaces&&(n=n.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" "))),n},encodePreCode:function(n){var r=n.match(new RegExp("<code(.*?)>(.*?)<pre(.*?)>(.*?)<\/pre>(.*?)<\/code>","gi")),i,u,t;if(r!==null)for(i=0;i<r.length;i++)u=r[i].match(new RegExp("<pre(.*?)>([\\w\\W]*?)<\/pre>","i")),n=n.replace(u[0],this.encodeEntities(u[0]));return t=this.utils.buildWrapper(n),t.find("code code").replaceWith(this._encodeOuter.bind(this)),t.find("code pre").replaceWith(this._encodeOuter.bind(this)),t.find("pre pre").replaceWith(this._encodeOuter.bind(this)),t.find("code, pre").each(this._encodePreCodeLine.bind(this)),n=this.utils.getWrapperHtml(t),this._decodeMarkers(n)},encodeEntities:function(n){return n=this.decodeEntities(n),n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},encodePhpCode:function(n){return n=n.replace("<?php","&lt;?php"),n=n.replace("<?","&lt;?"),n.replace("?>","?&gt;")},decodeEntities:function(n){return String(n).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},storeComponents:function(n){var t=this.utils.getElementsFromHtml(n,"figure","table");return this._storeMatched(n,t,"Components","figure")},restoreComponents:function(n){return this._restoreMatched(n,"Components","figure")},storeLinks:function(n){var t=this.utils.getElementsFromHtml(n,"a");return this._storeMatched(n,t,"Links","a")},storeImages:function(n){var t=this.utils.getElementsFromHtml(n,"img");return this._storeMatched(n,t,"Images","img")},restoreLinks:function(n){return this._restoreMatched(n,"Links","a")},restoreImages:function(n){return this._restoreMatched(n,"Images","img")},_cleanWrapped:function(n){return n.replace(new RegExp("<p><figure([\\w\\W]*?)<\/figure><\/p>","gi"),"<figure$1<\/figure>")},_cleanGDocs:function(n){return n=n.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2"),n=n.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3"),n=n.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2<\/i><\/b>"),n=n.replace(/<span[^>]*(font-style: italic; font-weight: 700|font-weight: 700; font-style: italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2<\/i><\/b>"),n=n.replace(/<span[^>]*font-style: italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1<\/i>"),n=n.replace(/<span[^>]*font-weight: bold[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1<\/b>"),n.replace(/<span[^>]*font-weight: 700[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1<\/b>")},_cleanMsWord:function(t){var i,f,u,r,e;for(t=t.replace(/<!--[\s\S]+?-->/gi,""),t=t.replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,""),t=t.replace(/<(\/?)s>/gi,"<$1strike>"),t=t.replace(/&nbsp;/gi," "),t=t.replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(n,t){return t.length>0?t.replace(/./," ").slice(Math.floor(t.length/2)).split("").join("Â "):""}),i=this.utils.buildWrapper(t),i.find("p").each(function(t){var i=n.dom(t),u=i.attr("style"),r=/mso-list:\w+ \w+([0-9]+)/.exec(u);r&&i.data("_listLevel",parseInt(r[1],10))}),this._parseWordLists(i),i.find("[style]").removeAttr("style"),i.find("[align]").removeAttr("align"),i.find("[name]").removeAttr("name"),i.find("span").unwrap(),i.find("[class^='Mso']").removeAttr("class"),i.find("a").filter(function(n){return!n.hasAttribute("href")}).unwrap(),t=this.utils.getWrapperHtml(i),t=t.replace(/<p[^>]*><\/p>/gi,""),t=t.trim(),t=t.replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,"/$1>\n<$2"),f="",u=t.split(/\n/),r=0;r<u.length;r++)e=u[r]!==""&&u[r].search(/>$/)===-1?" ":"\n",f+=u[r]+e;return f},_parseWordLists:function(t){var i=0,r=null;t.find("p").each(function(t){var u=n.dom(t),f=u.data("_listLevel"),o,e,s,h,l,c;if(f!==null){if(o=u.text(),e="<ul><\/ul>",/^\s*\w+\./.test(o)&&(s=/([0-9])\./.exec(o),s?(h=parseInt(s[1],10),e=h>1?'<ol start="'+h+'"><\/ol>':"<ol><\/ol>"):e="<ol><\/ol>"),f>i&&(i===0?(u.before(e),r=u.prev()):(l=n.dom(e),r.append(l))),f<i)for(c=0;c<i-f;c++)r=r.parent();u.find("span").first().unwrap();r.append("<li>"+u.html()+"<\/li>");u.remove();i=f}else i=0})},_isSpacedEmpty:function(n){return n.search(this.reSpacedEmpty)!==-1},_isParagraphEmpty:function(n){return n.search(/^<p><\/p>$/i)!==-1},_isHtmlMsWord:function(n){return n.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)},_setSpanAttr:function(n){var t=this.utils.buildWrapper(n);return t.find("span").attr("data-redactor-span",!0),this.utils.getWrapperHtml(t)},_setStyleCache:function(t){var i=this.utils.buildWrapper(t);return i.find("[style]").each(function(t){var i=n.dom(t);i.attr("data-redactor-style-cache",i.attr("style"))}),this.utils.getWrapperHtml(i)},_setPreClass:function(n){var t=this.utils.buildWrapper(n);return t.find("pre").addClass(this.opts.preClass),this.utils.getWrapperHtml(t)},_setLinkNofollow:function(n){var t=this.utils.buildWrapper(n);return t.find("a").attr("rel","nofollow"),this.utils.getWrapperHtml(t)},_replaceScriptTag:function(n){return n.replace(this.reScriptTag,'<pre class="redactor-script-tag" $1>$2<\/pre>')},_unreplaceScriptTag:function(n){return n.replace(/<pre class="redactor-script-tag"(.*?[^>]?)>([\w\W]*?)<\/pre>/gi,"<script$1>$2<\/script>")},_replaceNlToBr:function(n){return n.replace(/\n/g,"<br />")},_removeScriptTag:function(n){return n.replace(this.reScriptTag,"")},_storeMatched:function(n,t,i,r){if(this["stored"+i]=[],t)for(var u=0;u<t.length;u++)this["stored"+i][u]=t[u],n=n.replace(t[u],"####"+r+u+"####");return n},_restoreMatched:function(n,t,i){if(this["stored"+t])for(var r=0;r<this["stored"+t].length;r++)n=n.replace("####"+i+r+"####",this["stored"+t][r]);return n},_decodeMarkers:function(n){return n.replace(/&lt;span\sid="selection-marker-(start|end)"\sclass="redactor-selection-marker"&gt;(.*?[^>]?)&lt;\/span&gt;/g,'<span id="selection-marker-$1" class="redactor-selection-marker">Ã¢â¬â¹<\/span>')},_encodeOuter:function(n){return this.encodeEntities(n.outerHTML)},_encodePreCodeLine:function(n){var i=n.firstChild,t;n.tagName=="PRE"&&i&&i.tagName==="CODE"||(t=this.decodeEntities(n.innerHTML),t=t.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,"\n"),t=this.opts.preSpaces?t.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" ")):t,n.textContent=t)}});n.add("class","cleaner.figure",{init:function(n){this.app=n;this.opts=n.opts;this.utils=n.utils},convert:function(n,t){var i=this.utils.buildWrapper(n);return i.find("img").each(this._convertImage.bind(this)),i.find("hr").each(this._convertLine.bind(this)),i.find("iframe").each(this._convertIframe.bind(this)),i.find("table").each(this._convertTable.bind(this)),i.find("form").each(this._convertForm.bind(this)),i.find("figure pre").each(this._convertCode.bind(this)),i.find("[data-redactor-type=variable]").addClass("redactor-component"),i.find("figure").not(".redactor-component, .redactor-figure-code").each(this._convertWidget.bind(this)),i.find("figure pre").each(this._setContenteditableCode.bind(this)),i.find(".redactor-component, .non-editable").attr("contenteditable",!1),i.find("figcaption, td, th").attr("contenteditable",!0),i.find(".redactor-component, figcaption").attr("tabindex","-1"),this._acceptExtraRules(i,t),this.utils.getWrapperHtml(i)},unconvert:function(n,t){var i=this.utils.buildWrapper(n);return i.find("th, td, figcaption, figure, pre, code, .redactor-component").removeAttr("contenteditable tabindex"),i.find("figure").removeClass("redactor-component redactor-component-active redactor-uploaded-figure"),i.find("[data-redactor-type=variable]").removeClass("redactor-component"),i.find("figure[data-redactor-type=line]").unwrap(),i.find("figure[data-redactor-type=widget]").each(this._unconvertWidget.bind(this)),i.find("figure[data-redactor-type=form]").each(this._unconvertForm.bind(this)),i.find("figure[data-redactor-type=table]").each(this._unconvertTable.bind(this)),i.find("figure[data-redactor-type=image]").removeAttr("rel").each(this._unconvertImages.bind(this)),i.find("img").removeAttr("data-redactor-type").removeClass("redactor-component"),i.find(".non-editable").removeAttr("contenteditable"),i.find("figure").each(this._removeTypes.bind(this)),i.find("span.redactor-component-caret").remove(),this.opts.breakline&&i.find('[data-redactor-tag="br"]').each(function(n){n.lastChild&&n.lastChild.tagName!=="BR"&&n.appendChild(document.createElement("br"))}).unwrap(),this._acceptExtraRules(i,t),n=this.utils.getWrapperHtml(i),n.replace(/<br\s?\/?>$/,"")},_convertImage:function(t){var r=n.dom(t);if(!this._isNonEditable(r)){r.attr("data-image")||r.attr("data-image",this.utils.getRandomId());var u=r.closest("a"),i=r.closest("figure"),f=i.children().not("a, img, br, figcaption").length===0;f&&(i.length===0?i=u.length!==0?u.wrap("<figure>"):r.wrap("<figure>"):i.hasClass("redactor-uploaded-figure")?i.removeClass("redactor-uploaded-figure"):i.addClass("redactor-keep-figure"),this._setFigure(i,"image"))}},_convertTable:function(n){if(!this._isNonEditable(n)){var t=this._wrapFigure(n);this._setFigure(t,"table")}},_convertLine:function(n){if(!this._isNonEditable(n)){var t=this._wrapFigure(n);this._setFigure(t,"line")}},_convertForm:function(n){if(!this._isNonEditable(n)){var t=this.utils.replaceToTag(n,"figure");this._setFigure(t,"form")}},_convertIframe:function(n){if(!this._isNonEditable(n)){var t=n.getAttribute("src"),i=t&&(t.match(this.opts.regex.youtube)||t.match(this.opts.regex.vimeo)),r=this._wrapFigure(n);i&&this._setFigure(r,"video")}},_convertCode:function(n){if(!this._isNonEditable(n)){var t=this._wrapFigure(n);this._setFigure(t,"code")}},_convertWidget:function(t){if(!this._isNonEditable(t)){var i=n.dom(t);i.addClass("redactor-component");i.attr("data-redactor-type","widget");i.attr("data-widget-code",encodeURI(t.innerHTML.trim()))}},_unconvertForm:function(n){this.utils.replaceToTag(n,"form")},_unconvertTable:function(t){var i=n.dom(t);i.unwrap()},_unconvertWidget:function(t){var i=n.dom(t);i.html(decodeURI(i.attr("data-widget-code")));i.removeAttr("data-widget-code")},_unconvertImages:function(t){var i=n.dom(t);i.removeClass("redactor-component");var u=i.closest("li").length!==0,f=i.closest("table").length!==0,e=i.find("figcaption").length!==0,r=i.attr("style"),o=!(r===null||r===""),s=i.attr("class")!=="";!u&&(!f||e||o||s)||i.unwrap()},_removeTypes:function(t){var i=n.dom(t),r=i.attr("data-redactor-type"),u;r&&["image","widget","line","video","code","form","table"].indexOf(r)!==-1&&i.removeAttr("data-redactor-type");i.hasClass("redactor-keep-figure")?i.removeClass("redactor-keep-figure"):this.opts.imageFigure===!1&&(u=i.find("figcaption").length!==0,u||i.unwrap())},_wrapFigure:function(t){var i=n.dom(t),r=i.closest("figure");return r.length===0?i.wrap("<figure>"):r},_setFigure:function(n,t){n.addClass("redactor-component");n.attr("data-redactor-type",t)},_setContenteditableCode:function(t){if(!this._isNonEditable(t)){var i=n.dom(t),r=i.children("code").first(),u=r.length!==0?r:i;u.attr("contenteditable",!0).attr("tabindex","-1")}},_acceptExtraRules:function(n,t){for(var i in t)typeof t[i]=="function"&&t[i](n)},_isNonEditable:function(t){return n.dom(t).closest(".non-editable").length!==0}});n.add("class","cleaner.paragraphize",{init:function(n){this.app=n;this.opts=n.opts;this.utils=n.utils;this.element=n.element;this.stored=[];this.remStart="#####replace";this.remEnd="#####";this.paragraphizeTags=["table","div","pre","form","ul","ol","h1","h2","h3","h4","h5","h6","dl","blockquote","figcaption","address","section","header","footer","aside","article","object","style","script","iframe","select","input","textarea","button","option","map","area","math","hr","fieldset","legend","hgroup","nav","figure","details","menu","summary","p"]},convert:function(n){var t=this._isConverted(n);return t===!0?this._convert(n):t},_convert:function(n){var t=this.opts.breakline?"sdivtag":this.opts.markup;return n=this._storeTags(n),n=n.trim(),this.opts.breakline?(n=n.replace(new RegExp("\\n#####","gi"),"xnonbreakmarkerz#####"),n=n.replace(new RegExp("#####\\n\\n","gi"),"#####\nxnonbreakmarkerz"),n=n.replace(new RegExp("#####\\n","gi"),"#####xnonbreakmarkerz"),n=n.replace(/<br\s?\/?>\n/gi,"<br>"),n=n.replace(/\n/g,"<br>"),n=n.replace(/xnonbreakmarkerz/gi,"\n")):n=n.replace(/[\n]+/g,"\n"),n=this._trimEmptyLines(n),n=this.opts.breakline?n:n.replace(/<br\s?\/?>\n/gi,"xbreakmarkerz\n"),n=n.replace(/(?:\r\n|\r|\n)/g,"xparagraphmarkerz"),n=n.replace(/xparagraphmarkerz/gi,"<\/"+t+">\n<"+t+">"),n=this.opts.breakline?n:n.replace(/xbreakmarkerz/gi,"<br>"),n="<"+t+">"+n+"<\/"+t+">",n=n.replace(new RegExp("<"+t+">#####","gi"),"#####"),n=n.replace(new RegExp("#####<\/"+t+">","gi"),"#####"),n=this._restoreTags(n),n=this.opts.breakline?n:n.replace(new RegExp("<"+t+"><br\\s?/?><\/"+t+">","gi"),"<"+t+"><\/"+t+">"),n=n.replace(new RegExp("<sdivtag>","gi"),'<div data-redactor-tag="br">'),n.replace(new RegExp("sdivtag","gi"),"div")},_storeTags:function(t){var i=this,r=this.utils.buildWrapper(t);return this.opts.breakline&&r.find("p").each(function(t){var i=n.dom(t),r=i.closest("figure[data-redactor-type=widget],figure[data-redactor-type=form],.non-editable").length===0;r&&(i.append("<br><br>"),i.unwrap())}),r.find(this.paragraphizeTags.join(", ")).each(function(n,t){var r=document.createTextNode("\n"+i.remStart+t+i.remEnd+"\n");i.stored.push(n.outerHTML);n.parentNode.replaceChild(r,n)}),this.utils.getWrapperHtml(r)},_restoreTags:function(n){for(var t=0;t<this.stored.length;t++)this.stored[t]=this.stored[t].replace(/\$/g,"&#36;"),n=n.replace(this.remStart+t+this.remEnd,this.stored[t]);return n},_trimEmptyLines:function(n){for(var r="",i=n.split("\n"),t=0;t<i.length;t++)i[t].trim()!==""&&(r+=i[t]+"\n");return r.replace(/\n$/,"")},_isConverted:function(n){return this._isDisabled(n)?n:this._isEmptyHtml(n)?this.opts.emptyHtml:!0},_isDisabled:function(){return this.opts.paragraphize===!1||this.element.isType("inline")},_isEmptyHtml:function(n){return n===""||n==="<p><\/p>"||n==="<div><\/div>"}});n.add("service","detector",{init:function(n){this.app=n;this.userAgent=navigator.userAgent.toLowerCase()},isWebkit:function(){return/webkit/.test(this.userAgent)},isFirefox:function(){return this.userAgent.indexOf("firefox")>-1},isIe:function(n){if(document.documentMode||/Edge/.test(navigator.userAgent))return"edge";var t;return t=RegExp("msie"+(isNaN(n)?"":"\\s"+n),"i").test(navigator.userAgent),t||(t=!!navigator.userAgent.match(/Trident.*rv[ :]*11\./)),t},isMobile:function(){return/(iPhone|iPod|Android)/.test(navigator.userAgent)},isDesktop:function(){return!/(iPhone|iPod|iPad|Android)/.test(navigator.userAgent)},isIpad:function(){return/iPad/.test(navigator.userAgent)}});n.add("service","offset",{init:function(n){this.app=n},get:function(t,i){var u={start:0,end:0},f=this.utils.getNode(t);if(!f)return!1;var o=this.editor.isEditor(f),s=o?!0:this.selection.isIn(f),r=this.selection.getRange();if(o||s){if(this.selection.is()&&s){var c=n.dom(r.startContainer),h=c.hasClass("redactor-component")?r.startOffset:0,e=r.cloneRange();e.selectNodeContents(f);e.setEnd(r.startContainer,r.startOffset);u.start=this._getString(e,i).length-h;u.end=u.start+this._getString(r,i).length+h}}else u=!1;return u},set:function(n,t){var i,f,o;if(!this._setComponentOffset(t)&&(this.component.clearActive(),i=this.utils.getNode(t),i)){var s=this.size(i),r=0,u=document.createRange();n.end=n.end>s?s:n.end;u.setStart(i,0);u.collapse(!0);for(var h=[i],e=!1,c=!1;!c&&(i=h.pop());)if(i.nodeType==3)f=r+i.length,!e&&!this._isFigcaptionNext(i)&&n.start>=r&&n.start<=f&&(u.setStart(i,n.start-r),e=!0),e&&n.end>=r&&n.end<=f&&(u.setEnd(i,n.end-r),c=!0),r=f;else for(o=i.childNodes.length;o--;)h.push(i.childNodes[o]);this.selection.setRange(u)}},size:function(n,t){var r=this.utils.getNode(n),u,i;return r?(u=document.createRange(),i=u.cloneRange(),i.selectNodeContents(r),this._getString(i,t).length):0},_getString:function(n,t){var i=n.toString();return i=this.editor.isEmpty()?i.replace(/\uFEFF/g,""):i,t?i.trim():i},_setComponentOffset:function(n){return this.component.isNonEditable(n)?this.component.setActive(n):!1},_isFigcaptionNext:function(n){var t=n.nextSibling;return n.nodeValue.trim()===""&&t&&t.tagName==="FIGCAPTION"}});n.add("service","inspector",{init:function(n){this.app=n},parse:function(t){return n.create("inspector.parser",this.app,this,t)},isText:function(t){if(typeof t=="string"&&!/^\s*<(\w+|!)[^>]*>/.test(t))return!0;var i=n.dom(t).get();return i&&i.nodeType===3},isInlineTag:function(n,t){var i=this._extendTags(this.opts.inlineTags,t);return this._isTag(n)&&i.indexOf(n.toLowerCase())!==-1},isBlockTag:function(n,t){var i=this._extendTags(this.opts.blockTags,t);return this._isTag(n)&&i.indexOf(n.toLowerCase())!==-1},isTableCellTag:function(n){return["td","th"].indexOf(n.toLowerCase())!==-1},isHeadingTag:function(n){return["h1","h2","h3","h4","h5","h6"].indexOf(n.toLowerCase())!==-1},_isTag:function(n){return n!==undefined&&n},_extendTags:function(n,t){if(n=n.concat(n),t)for(var i=0;i<t.length;i++)n.push(t[i]);return n}});n.add("class","inspector.parser",{init:function(t,i,r){this.app=t;this.uuid=t.uuid;this.opts=t.opts;this.utils=t.utils;this.editor=t.editor;this.selection=t.selection;this.inspector=i;this.el=r;this.$el=n.dom(this.el);this.node=this.$el.get();this.$component=this.$el.closest(".redactor-component",".redactor-in")},isEditor:function(){return this.node===this.editor.getElement().get()},isInEditor:function(){return this.$el.parents(".redactor-in-"+this.uuid).length!==0},isComponent:function(){return this.$component.length!==0},isComponentType:function(n){return this.getComponentType()===n},isComponentActive:function(){return this.isComponent()&&this.$component.hasClass("redactor-component-active")},isComponentEditable:function(){var n=this.getComponentType();return this.isComponent()&&["code","table"].indexOf(n)!==-1},isFigcaption:function(){return this.getFigcaption()},isPre:function(){return this.getPre()},isCode:function(){var n=this.$el.closest("code"),t=n.parent("pre");return n.length!==0&&t.length===0},isList:function(){return this.getList()},isFirstListItem:function(){return this._getLastOrFirstListItem("first")},isLastListItem:function(){return this._getLastOrFirstListItem("last")},isFirstTableCell:function(){return this._getLastOrFirstTableCell("first")},isLastTableCell:function(){return this._getLastOrFirstTableCell("last")},isTable:function(){return this.isComponentType("table")||this.getTable()},isHeading:function(){return this.getHeading()},isBlockquote:function(){return this.getBlockquote()},isDl:function(){return this.getDl()},isParagraph:function(){return this.getParagraph()},isLink:function(){return this.getLink()},isFile:function(){return this.getFile()},isText:function(){return this.inspector.isText(this.el)},isInline:function(){var n=this.opts.inlineTags;return this.isElement()?n.indexOf(this.node.tagName.toLowerCase())!==-1:!1},isBlock:function(){var n=this.opts.blockTags;return this.isElement()?n.indexOf(this.node.tagName.toLowerCase())!==-1:!1},isElement:function(){return this.node&&this.node.nodeType&&this.node.nodeType!==3},hasParent:function(n){return this.$el.closest(n.join(",")).length!==0},getNode:function(){return this.node},getTag:function(){return this.isElement()?this.node.tagName.toLowerCase():!1},getComponent:function(){return this.isComponent()?this.$component.get():!1},getComponentType:function(){return this.isComponent()?this.$component.attr("data-redactor-type"):!1},getFirstNode:function(){return this.utils.getFirstNode(this.node)},getLastNode:function(){return this.utils.getLastNode(this.node)},getFirstElement:function(){return this.utils.getFirstElement(this.node)},getLastElement:function(){return this.utils.getLastElement(this.node)},getFigcaption:function(){return this._getClosestNode("figcaption")},getPre:function(){return this._getClosestNode("pre")},getCode:function(){return this._getClosestNode("code")},getList:function(){return this._getClosestNode("ul, ol")},getParentList:function(){return this._getClosestUpNode("ul, ol")},getListItem:function(){return this._getClosestNode("li")},getTable:function(){return this.getComponentType("table")?this.$component.find("table").get():this._getClosestNode("table")},getTableCell:function(){var n=this.$el.closest("td, th");return n.length!==0?n.get():!1},getComponentCodeElement:function(){return this.isComponentType("code")?this.$component.find("pre code, pre").last().get():!1},getImageElement:function(){return this.isComponentType("image")?this.$component.find("img").get():!1},getParagraph:function(){return this._getClosestNode("p")},getHeading:function(){return this._getClosestNode("h1, h2, h3, h4, h5, h6")},getDl:function(){return this._getClosestNode("dl")},getBlockquote:function(){return this._getClosestNode("blockquote")},getLink:function(){var t=this.isComponent()&&!this.isFigcaption(),i=this.isComponentType("table"),n;return i||!t?(n=this._getClosestElement("a"),n&&!n.attr("data-file")?n.get():!1):!1},getFile:function(){var t=this.isComponent(),i=this.isComponentType("table"),n;return i||!t?(n=this._getClosestElement("a"),n&&n.attr("data-file")?n.get():!1):!1},findFirstNode:function(n){return this.$el.find(n).first().get()},findLastNode:function(n){return this.$el.find(n).last().get()},_getLastOrFirstListItem:function(t){var r=this.getList(),u=this.getTag(),i;return r&&u==="li"&&(i=n.dom(r).find("li")[t]().get(),i&&this.node===i)?!0:!1},_getLastOrFirstTableCell:function(t){var r=this.getTable(),u=this.getTag(),i;return r&&(u==="td"||u==="th")&&(i=n.dom(r).find("td, th")[t]().get(),i&&this.node===i)?!0:!1},_getClosestUpNode:function(n){var t=this.$el.parents(n,".redactor-in").last();return t.length!==0?t.get():!1},_getClosestNode:function(n){var t=this.$el.closest(n,".redactor-in");return t.length!==0?t.get():!1},_getClosestElement:function(n){var t=this.$el.closest(n,".redactor-in");return t.length!==0?t:!1}});n.add("service","marker",{init:function(n){this.app=n},build:function(n,t){var i=document.createElement("span");return i.id="selection-marker-"+this._getPos(n),i.className="redactor-selection-marker",i.innerHTML=this.opts.markerChar,t?i.outerHTML:i},buildHtml:function(n){return this.build(n,!0)},insert:function(n){var r,t;if(this.remove(),r=n!=="both"&&(n==="start"||this.selection.isCollapsed()),this.selection.is()||this.editor.focus(),t=this.selection.getRange(),t){var u=this.build("start"),f=this.build("end"),i=t.cloneRange();return r||(i.collapse(!1),i.insertNode(f)),i.setStart(t.startContainer,t.startOffset),i.collapse(!0),i.insertNode(u),t.setStartAfter(u),r||t.setEndBefore(f),this.selection.setRange(t),u}},find:function(n,t){var r=this.editor.getElement(),i=(t||r).find("span#selection-marker-"+this._getPos(n));return i.length!==0?i.get():!1},restore:function(){var i=this.find("start"),r=this.find("end"),n=this.selection.getRange(),u,t;n&&this.selection.is()||(this.editor.focus(),n=document.createRange());i&&(u=r?r.previousSibling:!1,t=i.nextSibling,t=t&&t.nodeType===3&&t.textContent.replace(/[\n\t]/g,"")===""?!1:t,r?t&&t.id==="selection-marker-end"?this._restoreInject(n,i):u&&t?(n.selectNodeContents(u),n.collapse(!1),n.setStart(t,0)):u&&!t?(n.selectNodeContents(u),n.collapse(!1),n.setStartAfter(i)):(n.setStartAfter(i),n.setEndBefore(r)):t?(n.selectNodeContents(t),n.collapse(!0)):this._restoreInject(n,i),this.selection.setRange(n),i&&i.parentNode.removeChild(i),r&&r.parentNode.removeChild(r))},remove:function(){var n=this.find("start"),t=this.find("end");n&&n.parentNode.removeChild(n);t&&t.parentNode.removeChild(t)},_getPos:function(n){return n===undefined?"start":n},_restoreInject:function(t,i){var r=this.utils.createInvisibleChar();n.dom(i).after(r);t.selectNodeContents(r);t.collapse(!1)}});n.add("service","component",{init:function(n){this.app=n;this.activeClass="redactor-component-active"},create:function(t,i){return n.create(t+".component",this.app,i)},build:function(t){var u=n.dom(t),i,r=u.attr("data-redactor-type");return r&&(i=this.create(r,t)),i?i:t},remove:function(t,i){var r=n.dom(t).closest(".redactor-component"),f=r.attr("data-redactor-type"),s=r.parent(),h=this.inspector.parse(s),e=this.utils.findSiblings(r,"prev"),o=this.utils.findSiblings(r,"next"),c=this.app.broadcast(f+".delete",r),u;c!==!1&&(r.remove(),this.app.broadcast(f+".deleted",r),this.app.broadcast("contextbar.close"),this.app.broadcast("imageresizer.stop"),i!==!1&&(u=h.getTableCell(),u&&this.utils.isEmptyHtml(u.innerHTML)?this.caret.setStart(u):o?this.caret.setStart(o):e?this.caret.setEnd(e):this.editor.startFocus()),this.editor.isEmpty()&&(this.editor.setEmpty(),this.editor.startFocus(),this.app.broadcast("empty")))},isNonEditable:function(n){var t=this.inspector.parse(n);return t.isComponent()&&!t.isComponentEditable()},isActive:function(t){var i,r;return t?(r=this.inspector.parse(t),i=n.dom(r.getComponent()),i.hasClass(this.activeClass)):(i=this._find(),i.length!==0)},getActive:function(n){var t=this._find();return t.length!==0?n?t:t.get():!1},setActive:function(t){var i;this.clearActive();this.editor.focus();var u=this.inspector.parse(t),f=u.getComponent(),r=n.dom(f);u.isFigcaption()||(i=r.find(".redactor-component-caret"),i.length===0&&(i=this._buildCaret(),r.prepend(i)),this.caret.setAtStart(i.get()));r.addClass(this.activeClass)},clearActive:function(){var n=this._find();n.removeClass(this.activeClass);n.find(".redactor-component-caret").remove();this.app.broadcast("imageresizer.stop")},setOnEvent:function(n,t){this.clearActive();var i=this.inspector.parse(n.target);i.isFigcaption()||i.isComponentEditable()||i.isComponent()&&(this.setActive(n.target),t!==!0&&n.preventDefault())},executeScripts:function(){for(var i,r,u=this.editor.getElement(),t=u.find("[data-redactor-type]").find("script").getAll(),n=0;n<t.length;n++)t[n].src!==""?(i=t[n].src,this.$doc.find('head script[src="'+i+'"]').remove(),r=document.createElement("script"),r.src=i,document.getElementsByTagName("head")[0].appendChild(r)):eval(t[n].innerHTML)},_find:function(){return this.editor.getElement().find("."+this.activeClass)},_buildCaret:function(){var t=n.dom("<span>");return t.addClass("redactor-component-caret"),t.attr("contenteditable",!0),t}});n.add("service","insertion",{init:function(n){this.app=n},set:function(n,t,i){n=t!==!1?this.cleaner.input(n):n;n=t!==!1?this.cleaner.paragraphize(n):n;var r=this.editor.getElement();return r.html(n),i!==!1&&this.editor.endFocus(),n},insertNode:function(n,t){this.editor.focus();var i=this.utils.isFragment(n)?n:this.utils.createFragment(n);return this._collapseSelection(),this._insertFragment(i),this._setCaret(t,i),this._sendNodes(i.nodes)},insertBreakLine:function(){return this.insertNode(document.createElement("br"),"after")},insertNewline:function(){return this.insertNode(document.createTextNode("\n"),"after")},insertText:function(n){return this.insertHtml(this.cleaner.getFlatText(n))},insertChar:function(n){return this.insertNode(n,"after")},insertRaw:function(n){return this.insertHtml(n,!1)},insertPoint:function(n){var t,i,f=this.marker.build("start"),u=!1,e=n.clientX,o=n.clientY,r,s;return document.caretPositionFromPoint?(r=document.caretPositionFromPoint(e,o),s=document.getSelection(),i=this.inspector.parse(r.offsetNode),i.isInEditor()&&(t=s.getRangeAt(0),t.setStart(r.offsetNode,r.offset),t.collapse(!0),t.insertNode(f),u=!0)):document.caretRangeFromPoint&&(t=document.caretRangeFromPoint(e,o),i=this.inspector.parse(t.startContainer),i.isInEditor()&&(t.insertNode(f),u=!0)),u},insertToPoint:function(t,i,r){var f=r===!0?!0:this.insertPoint(t),u;return f||(u=this.editor.getLastNode(),n.dom(u).after(this.marker.build("start"))),this.component.clearActive(),this.selection.restoreMarkers(),this.insertHtml(i)},insertToOffset:function(n,t){return this.offset.set({start:n,end:n}),this.insertHtml(t)},insertHtml:function(t,i){var r,s,l;if(this.opts.input){if(r=this.utils.parseHtml(t),this.selection.isAll())return this._insertToAllSelected(r);this.selection.is()||this.editor.startFocus();var a=this.selection.isCollapsed(),h=this.selection.isText(),e=this.selection.getCurrent(),f=this.inspector.parse(e);this._collapseSelection();r=this._getCleanedInput(r,f,i);var c=this._isFigure(r.html),v=this._isComponentSpan(r.html),y=this.inspector.isText(r.html),u,o;if(this.editor.isEmpty())return this._insertToEmptyEditor(r.html);if(f.isComponent()&&!f.isComponentEditable())return this._insertToWidget(e,f,r.html);if(v)return this.insertNode(r.nodes,"end");if(!c||h||f.isList()){if(f.isCode())return this._insertToCode(r,e,i);if(f.isPre())return this._insertToPre(r,i);if(f.isHeading()||f.isFigcaption())return r.html=i!==!1?this.cleaner.removeTagsExcept(r.html,["a"]):r.html,r.html=i!==!1?this.cleaner.replaceNbspToSpaces(r.html):r.html,u=this.utils.createFragment(r.html),this.insertNode(u,"end");if(y)return!h&&this.opts.markup!=="br"&&this._hasBlocksAndImages(r.nodes)?(r.html=i!==!1?this.cleaner.paragraphize(r.html):r.html,u=this.utils.createFragment(r.html),this.utils.splitNode(e,u),this.caret.setEnd(u.last),this._sendNodes(u.nodes)):this.insertNode(r.nodes,"end");if(a||c){if(f.isInline()&&!this._isPlainHtml(r.html))return this._insertToInline(e,r);if(f.isBlockquote()||f.isDl())return o=this.opts.inlineTags,o.concat(["br"]),r.html=i!==!1?this.cleaner.replaceBlocksToBr(r.html):r.html,r.html=i!==!1?this.cleaner.removeTagsExcept(r.html,o):r.html,u=this.utils.createFragment(r.html),this.insertNode(u,"end");if(f.isParagraph())return this._isPlainHtml(r.html)?this.insertNode(r.nodes,"end"):(r.html=i!==!1?this.cleaner.paragraphize(r.html):r.html,u=this.utils.createFragment(r.html),this.utils.splitNode(e,u),this.caret.setEnd(u.last),this._sendNodes(u.nodes));if(f.isList()&&(o=this.opts.inlineTags,o=o.concat(["br","li","ul","ol","img"]),r.html=i!==!1?this.cleaner.replaceBlocksToBr(r.html):r.html,r.html=i!==!1?this.cleaner.removeTagsExcept(r.html,o):r.html,r.html=i!==!1?this.cleaner.removeBrAtEnd(r.html):r.html,u=this.utils.createFragment(r.html),r.nodes=u.nodes,this._containsTags(r.html,["ul","ol","li"])))return s=this.selection.getElement(e),s&&s.tagName==="LI"&&this.caret.isStart(s)?(r.nodes=n.dom(u.nodes).unwrap("ul, ol").getAll(),n.dom(s).before(r.nodes),l=r.nodes[r.nodes.length-1],this.caret.setEnd(l),this._sendNodes(r.nodes)):this._isPlainHtml(r.html)?this.insertNode(u,"end"):(u=this._buildList(r,s,u),this.utils.splitNode(e,u,!0),this.caret.setEnd(u.last),this._sendNodes(u.nodes))}else return r.html=i!==!1?this.cleaner.paragraphize(r.html):r.html,u=this.utils.createFragment(r.html),this.insertNode(u,"end")}else return f.isInline()?this._insertToInline(e,r):(u=this.utils.createFragment(r.html),this.utils.splitNode(e,u),this.caret.setEnd(u.last),this._sendNodes(u.nodes));return this.insertNode(r.nodes,"end")}},_insertToAllSelected:function(n){var t=this.set(n.html),i=this.utils.parseHtml(t);return this._sendNodes(i.nodes)},_insertToEmptyEditor:function(n){n=this.cleaner.paragraphize(n);var i=this.utils.createFragment(n),t=this.editor.getElement();return t.html(""),t.append(i.frag),this.caret.setEnd(t),this._sendNodes(i.nodes)},_insertToInline:function(n,t){var i=this.utils.createFragment(t.html);return this.utils.splitNode(n,i,!1,!0),this.caret.setEnd(i.last),this._sendNodes(i.nodes)},_insertToCode:function(n,t,i){n.html=i!==!1?this.cleaner.encodeHtml(n.html):n.html;n.html=i!==!1?this.cleaner.removeNl(n.html):n.html;var r=this.utils.createFragment(n.html),u=this.insertNode(r,"end");return this.utils.normalizeTextNodes(t),u},_insertToPre:function(n,t){n.html=t!==!1?this.cleaner.encodeHtml(n.html):n.html;var i=this.utils.createFragment(n.html);return this.insertNode(i,"end")},_insertToWidget:function(t,i,r){r=this._isComponentSpan(r)?r:this.cleaner.paragraphize(r);var u=this.utils.createFragment(r),e=i.getComponent(),f=n.dom(e);return f.after(u.frag),f.remove(),this.caret.setEnd(u.last),this._sendNodes(u.nodes)},_insertFragment:function(n){var i=this.selection.getRange(),t;i&&(this.selection.isCollapsed()?(t=i.startContainer,t.nodeType!==3&&t.tagName==="BR"&&(this.caret.setAfter(t),t.parentNode.removeChild(t))):i.deleteContents(),i.insertNode(n.frag))},_sendNodes:function(n){for(var t,r,i=0;i<n.length;i++)t=n[i],r=t.nodeType!==3&&typeof t.getAttribute=="function"?t.getAttribute("data-redactor-type"):!1,r&&this.app.broadcast(r+".inserted",this.component.build(t));return this.app.broadcast("inserted",n),this.component.executeScripts(),n},_setCaret:function(n,t){var i=this._isLastInline(t);n?(n=i&&n==="end"?"after":n,this.caret["set"+this.utils.ucfirst(n)](t.last)):n!==!1&&i&&this.caret.setAfter(t.last)},_isLastInline:function(n){if(n.last){var t=this.inspector.parse(n.last);return t.isInline()}return!1},_getCleanedInput:function(n,t,i){var r=t.isCode()||t.isPre();return n.html=!r&&i!==!1?this.cleaner.input(n.html):n.html,!r&&i!==!1?this.utils.parseHtml(n.html):n},_getContainer:function(t){return n.dom(this.utils.createTmpContainer(t))},_buildList:function(t,i,r){var e=t.nodes,u=e[0];if(u&&u.nodeType!==3&&u.tagName==="li"){var o=n.dom(i),s=o.get().tagName.toLowerCase(),f=n.dom("<"+s+" />");return f.append(r.nodes),this.utils.createFragment(f.get().outerHTML)}return r},_containsTags:function(n,t){return this._getContainer(n).find(t.join(",")).length!==0},_collapseSelection:function(){},_hasFigureOrTable:function(n){return this._getContainer(n).find("figure, table").length!==0},_hasBlocks:function(n){return this._getContainer(n).find(this.opts.blockTags.join(",")).length!==0},_hasBlocksAndImages:function(n){return this._getContainer(n).find(this.opts.blockTags.join(",")+",img").length!==0},_isPlainHtml:function(n){return this._getContainer(n).find(this.opts.blockTags.join(",")+", img").length===0},_isFigure:function(t){if(this._isHtmlString(t))return n.dom(t).closest("figure").length!==0},_isComponentSpan:function(t){if(this._isHtmlString(t))return n.dom(t).closest("span.redactor-component").length!==0},_isHtmlString:function(n){return!(typeof n=="string"&&!/^\s*<(\w+|!)[^>]*>/.test(n))}});n.add("service","block",{mixins:["formatter"],init:function(n){this.app=n},format:function(n){return this.type=n.type?n.type:"set",this.tag=typeof n=="string"?n:n.tag,this.tag=this._prepareTag(this.tag),this.tag=this.tag.toLowerCase(),typeof n=="string"?this.args=!1:this.buildArgs(n),this._format()},getBlocks:function(n){return this.selection.getBlocks({tags:n||this._getTags(),first:!0})},getElements:function(t){var i=this.selection.getBlock();return!this.selection.isCollapsed()&&i&&(i.tagName==="TD"||i.tagName==="TH")?this._wrapInsideTable("div"):n.dom(this.getBlocks(t))},clearFormat:function(n){this.selection.save();var t=this.getElements(n||this._getTags());return t.each(function(n){while(n.attributes.length>0)n.removeAttribute(n.attributes[0].name)}),this.selection.restore(),t.getAll()},_format:function(){var o;this.selection.save();var r=this.getBlocks(),s=this.selection.getBlock(),t=[],u,f,i,e;if(r.length===1&&r[0].tagName==="DIV"){if(u=this._getTextNodesData(),!u||u.nodes.length===0)return t=this._replaceBlocks(r),t=this._sendNodes(t),setTimeout(function(){this.selection.restore()}.bind(this),0),t;for(f=this._getReplacedTag("set"),i=n.dom("<"+f+">"),e=u.last.nextSibling,e&&e.tagName==="BR"&&n.dom(e).remove(),o=0;o<u.nodes.length;o++)i.append(u.nodes[o]);return this.utils.splitNode(r[0],[i.get()]),t=this._sendNodes([i.get()]),this.utils.isEmptyHtml(i.html())?this.caret.setStart(i):setTimeout(function(){this.selection.restore()}.bind(this),0),t}return r.length>0?(t=this._replaceBlocks(r),t=this._sendNodes(t),setTimeout(function(){this.selection.restore()}.bind(this),0),t):!this.selection.isCollapsed()&&s&&(s.tagName==="TD"||s.tagName==="TH")?(f=this._getReplacedTag("set"),i=this._wrapInsideTable(f),this.selection.setAll(i),this._sendNodes([i.get()])):void 0},_wrapInsideTable:function(t){var f=this._getTextNodesData(),i=n.dom("<"+t+">"),r,u;for(n.dom(f.first).before(i),r=0;r<f.nodes.length;r++)i.append(f.nodes[r]);return u=i.get().nextSibling,u&&u.tagName==="BR"&&n.dom(u).remove(),i},_prepareTag:function(n){return typeof n=="undefined"?this.opts.markup:n},_sendNodes:function(n){return n.length>0&&(n=this.applyArgs(n,!1),n=this._combinePre(n),n=this._cleanBlocks(n)),n},_getTags:function(){return["div","p","blockquote","pre","h1","h2","h3","h4","h5","h6"]},_replaceBlocks:function(n){for(var r,i=[],u=this._isToggleFormatType(n)?"toggle":"set",f=this._getReplacedTag(u),t=0;t<n.length;t++)r=this.utils.replaceToTag(n[t],f),i.push(r.get());return i},_getReplacedTag:function(n){var t=n==="toggle"?this.opts.markup:this.tag;return this.opts.breakline&&t==="p"?"div":t},_getTextNodesData:function(){var t=this.selection.getNodes({textnodes:!0,keepbr:!0}),r;if(t.length===0)return!1;for(var f=t[0],u=t[t.length-1],n=u,i=!1;!i;)r=this.selection.getInline(n),n=r?r.nextSibling:n.nextSibling,n?n.nodeType!==3&&(n.tagName==="BR"||this.inspector.isBlockTag(n.tagName))?i=!0:t.push(n):i=!0;return{nodes:t,first:f,last:u}},_isToggleFormatType:function(n){for(var i=0,r=n.length,t=0;t<r;t++)n[t]&&this.tag===n[t].tagName.toLowerCase()&&i++;return i===r},_combinePre:function(t){for(var r,u=[],i=0;i<t.length;i++){if(r=t[i].nextElementSibling,r&&t[i].tagName==="PRE"&&r.tagName==="PRE"){var f=n.dom(t[i]),e=n.dom(r),o=document.createTextNode("\n");f.append(o);f.append(e);e.unwrap("pre")}u.push(t[i])}return u},_cleanBlocks:function(t){for(var u,r,f=["h1","h2","h3","h4","h5","h6"],e=this.opts.inlineTags,i=0;i<t.length;i++)u=t[i].tagName.toLowerCase(),r=n.dom(t[i]),f.indexOf(u)!==-1?r.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker").unwrap():u==="pre"&&r.find(e.join(",")).not(".redactor-selection-marker").unwrap(),this.opts.breakline&&u==="div"?r.attr("data-redactor-tag","br"):r.removeAttr("data-redactor-tag"),this.utils.normalizeTextNodes(t[i]);return t}});n.add("service","inline",{mixins:["formatter"],init:function(n){this.app=n},format:function(n){if(!this._isFormat())return[];this.type=n.type?n.type:"set";this.tag=typeof n=="string"?n:n.tag;this.tag=this.tag.toLowerCase();this.tag=this.arrangeTag(this.tag);typeof n=="string"?this.args=!1:this.buildArgs(n);return this.selection.isCollapsed()?this.formatCollapsed():this.formatUncollapsed()},_isFormat:function(){var t=this.selection.getCurrent(),n=this.inspector.parse(t),i=n.isComponent()&&!n.isComponentType("table")&&!n.isFigcaption();return!t||n.isPre()||n.isCode()||i?!1:!0},arrangeTag:function(n){var t=this.opts.replaceTags;for(var i in t)n===i&&(n=t[i]);return n},formatCollapsed:function(){var t=[],i=this.selection.getInlineFirst(),e=this.selection.getInlines({all:!0}),s=n.dom(i),f,r,u,h,l,y,p,a,c,v,o;if(i)if(l=this.inspector.parse(i),y=this.utils.isEmptyHtml(i.innerHTML),y)i.tagName.toLowerCase()===this.tag?this.hasSameArgs(i)?(this.caret.setAfter(i),s.remove(),p=this.selection.getElement(),this.utils.normalizeTextNodes(p)):this.tag==="span"?(t=this.applyArgs([i],!1),this.caret.setStart(i)):t=this.insertInline(t):l.hasParent([this.tag])?(f=s.closest(this.tag),r=f.get(),this.hasSameArgs(r)?(f.unwrap(),this.caret.setStart(i)):t=this.insertInline(t)):t=this.insertInline(t);else if(i.tagName.toLowerCase()===this.tag)this.hasSameArgs(i)?(h=this.utils.extractHtmlFromCaret(i),u=n.dom("<"+this.tag+" />"),u=this.utils.cloneAttributes(i,u),s.after(u.append(h)),this.caret.setAfter(i)):t=this.insertInline(t);else if(l.hasParent([this.tag]))if(f=s.closest(this.tag),r=f.get(),this.hasSameArgs(r)){for(h=this.utils.extractHtmlFromCaret(r,r),u=n.dom("<"+this.tag+" />"),u=this.utils.cloneAttributes(r,u),v=0,e=e.reverse(),o=0;o<e.length;o++)e[o]!==r&&(c=n.dom("<"+e[o].tagName.toLowerCase()+">"),v===0?a=c:a.append(c),v++);f.after(u.append(h));f.after(a);this.caret.setStart(c)}else t=this.insertInline(t);else t=this.insertInline(t);else t=this.insertInline(t);return t},insertInline:function(n){var t=document.createElement(this.tag);return n=this.insertion.insertNode(t,"start"),this.applyArgs(n,!1)},hasSameArgs:function(t){var h,i,r,o,s;if(t.attributes.length===0&&this.args===!1)return!0;if(h=!0,this.args){i=0;for(r in this.args){var u=n.dom(t),y=this.args[r],f=this.utils.toParams(y),c=u.attr(r);if(y)if(r==="style"){f=f.trim().replace(/;$/,"");var w=this.utils.styleToObj(u.attr("style")),e=f.split(";"),l=0;for(o=0;o<e.length;o++){var p=e[o].split(":"),a=p[0].trim(),v=p[1].trim();a.search(/color/)!==-1?(s=u.css(a),s&&(s===v||this.utils.rgb2hex(s)===v)&&l++):u.css(a)===v&&l++}l===e.length&&Object.keys(w).length===e.length&&i++}else c===f&&i++;else c&&c!==""||i++}h=i===Object.keys(this.args).length}return h},formatUncollapsed:function(){var t=this.selection.getInlines({all:!0,inside:!0}),n;return this.selection.save(),this._convertTags("u"),this._convertTags("del"),this._convertToStrike(t),this.selection.restore(),document.execCommand("strikethrough"),this._clearDecoration(),this.selection.save(),n=this._revertToInlines(),n=this.applyArgs(n,!1),this.selection.restore(),this._clearEmptyStyle(),this._normalizeBlocks(n)},_convertTags:function(n){if(this.tag!==n){var t=this.editor.getElement();t.find(n).each(function(t){var i=this.utils.replaceToTag(t,"span");i.addClass("redactor-convertable-"+n)}.bind(this))}},_revertTags:function(n){var t=this.editor.getElement();t.find("span.redactor-convertable-"+n).each(function(t){var i=this.utils.replaceToTag(t,n);i.removeClass("redactor-convertable-"+n);this.utils.removeEmptyAttr(i,"class")&&i.removeAttr("class")}.bind(this))},_convertToStrike:function(t){for(var f=this.selection.getText().replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),i=0;i<t.length;i++){var e=this.arrangeTag(t[i].tagName.toLowerCase()),r=t[i],u=n.dom(r),o=this.hasSameArgs(r);e===this.tag&&(this.tag==="span"&&this._isTextSelected(r,f)?u.addClass("redactor-convertable-apply"):o?this._replaceToStrike(u):this.tag==="span"&&u.addClass("redactor-unconvertable-apply"))}},_replaceToStrike:function(t){t.replaceWith(function(){return n.dom("<strike>").append(t.contents())})},_revertToInlines:function(){var i=[],t=this.editor.getElement();return this.tag!=="u"&&t.find("u").unwrap(),t.find("span.redactor-convertable-apply").each(function(t){var r=n.dom(t);r.find("strike").unwrap();this._forceRemoveClass(r,"redactor-convertable-apply");i.push(t)}.bind(this)),t.find("span.redactor-unconvertable-apply").each(function(t){var i=n.dom(t);this._forceRemoveClass(i,"redactor-unconvertable-apply")}.bind(this)),t.find("strike").each(function(n){var t=this.utils.replaceToTag(n,this.tag);i.push(t.get())}.bind(this)),this._revertTags("u"),this._revertTags("del"),i},_normalizeBlocks:function(t){var f=this.opts.inlineTags,r=this.selection.getBlocks(),i,u;if(r)for(i=0;i<r.length;i++)r[i].tagName==="PRE"&&(u=n.dom(r[i]),u.find(f.join(",")).not(".redactor-selection-marker").each(function(i){t.indexOf(i)!==-1&&(t=this.utils.removeFromArrayByValue(t,i));n.dom(i).unwrap()}.bind(this)));return t},_clearDecoration:function(){var t=this.editor.getElement();t.find(this.opts.inlineTags.join(",")).each(function(t){if(t.style.textDecoration==="line-through"||t.style.textDecorationLine==="line-through"){var i=n.dom(t);i.css("textDecorationLine","");i.css("textDecoration","");i.wrap("<strike>")}})},_clearEmptyStyle:function(){for(var t,i,r=this.getInlines(),n=0;n<r.length;n++)if(this._clearEmptyStyleAttr(r[n]),t=r[n].childNodes,t)for(i=0;i<t.length;i++)this._clearEmptyStyleAttr(t[i])},_clearEmptyStyleAttr:function(n){n.nodeType!==3&&this.utils.removeEmptyAttr(n,"style")&&(n.removeAttribute("style"),n.removeAttribute("data-redactor-style-cache"))},_forceRemoveClass:function(n,t){n.removeClass(t);this.utils.removeEmptyAttr(n,"class")&&n.removeAttr("class")},_isTextSelected:function(n,t){var i=this.utils.removeInvisibleChars(n.textContent);return t===i||t.search(new RegExp("^"+this.utils.escapeRegExp(i)+"$"))!==-1},getInlines:function(n){return n?this.selection.getInlines({tags:n,all:!0}):this.selection.getInlines({all:!0})},getElements:function(t){return n.dom(this.getInlines(t))},clearFormat:function(){var i,t,r,u;for(this.selection.save(),i=this.selection.getInlines({all:!0}),t=0;t<i.length;t++)r=n.dom(i[t]),u=this.selection.getInline(i[t]),u&&r.unwrap();this.selection.restore()}});n.add("service","autoparser",{init:function(n){this.app=n},observe:function(){var i=this.editor.getElement(),t=i.find(".redactor-autoparser-object").each(function(t){var i=n.dom(t);i.removeClass("redactor-autoparser-object");i.attr("class")===""&&i.removeAttr("class")});t.length>0&&t.each(function(t){var i,r=!1,u=t.tagName;u==="A"?i="link":u==="IMG"?i="image":u==="IFRAME"&&(i="video");i&&(r=n.create(i+".component",this.app,t),this.app.broadcast(i+".inserted",r),this.app.broadcast("autoparse",i,r))}.bind(this))},format:function(n,t){this._isKey(t)&&this._format()},parse:function(n){var i=["figure","pre","code","a","iframe","img","i","em","span"],v=["img","i","em","span"],e=[],h=0,c,r,u,f,l,a,o,s,t;for(n=this.cleaner.encodePreCode(n),t=0;t<i.length;t++)if(c=v.indexOf(i[t])!==-1?"<"+i[t]+"[^>]*>":"<"+i[t]+"([\\w\\W]*?)<\/"+i[t]+">",r=n.match(new RegExp(c,"gi")),r!==null)for(u=0;u<r.length;u++)n=n.replace(r[u],"#####replaceparse"+h+"#####"),e.push(r[u]),h++;if(this.opts.autoparseImages&&n.match(this.opts.regex.imageurl))for(f=n.match(this.opts.regex.imageurl),t=0;t<f.length;t++)n=n.replace(f[t],'<img class="redactor-autoparser-object" src="'+f[t]+'">');for(this.opts.autoparseVideo&&(n.match(this.opts.regex.youtube)||n.match(this.opts.regex.vimeo))&&(l='<iframe width="500" height="281" src="',a='" frameborder="0" allowfullscreen><\/iframe>',n.match(this.opts.regex.youtube)?(o="//www.youtube.com/embed/$1",s=this.opts.regex.youtube):n.match(this.opts.regex.vimeo)&&(o="//player.vimeo.com/video/$2",s=this.opts.regex.vimeo),n=n.replace(s,l+o+a)),this.opts.autoparseLinks&&n.match(this.opts.regex.url)&&(n=this._formatLinks(n)),t=0;t<e.length;t++)n=n.replace("#####replaceparse"+t+"#####",e[t]);return n},_isKey:function(n){return n===this.keycodes.ENTER||n===this.keycodes.SPACE},_format:function(){var h=this.selection.getParent(),b=n.dom(h),k=h&&b.closest("figure, pre, code, img, a, iframe").length!==0,f,c,t,r,a,v,o,s,y,p,i,w;if(!k&&this.selection.isCollapsed()){f=this.utils.createInvisibleChar();c=this.selection.getRange();c.insertNode(f);var u=this.selection.getCurrent(),d=this.inspector.parse(u),g=n.dom(u);if(f.parentNode.removeChild(f),u&&u.nodeType===3){if(t=u.textContent,this.opts.autoparseImages&&t.match(this._convertToRegExp(this.opts.regex.imageurl))){var nt=d.isList(),l=t.match(this.opts.regex.imageurl),tt=nt?undefined:"<figure><img><\/figure>",e=this.component.create("image",tt);e.setSrc(l[0]);e.addClass("redactor-autoparser-object");t=t.replace(l[0],e.get().outerHTML);r="image"}else this.opts.autoparseVideo&&(t.match(this._convertToRegExp(this.opts.regex.youtube))||t.match(this._convertToRegExp(this.opts.regex.vimeo)))?(a='<iframe width="500" height="281" src="',v='" frameborder="0" allowfullscreen><\/iframe>',t.match(this.opts.regex.youtube)?(o="//www.youtube.com/embed/$1",s=this.opts.regex.youtube):t.match(this.opts.regex.vimeo)&&(o="//player.vimeo.com/video/$2",s=this.opts.regex.vimeo),y=this.component.create("video",a+o+v),t=t.replace(s,y.get().outerHTML),r="video"):this.opts.autoparseLinks&&t.match(this._convertToRegExp(this.opts.regex.url))&&(t=this._formatLinks(t),r="link");r&&(g.replaceWith(t),p=this.editor.getElement(),i=p.find(".redactor-autoparser-object").removeClass("redactor-autoparser-object"),i=r==="link"?n.create("link.component",this.app,i):i,r==="link"?(this.caret.setAfter(i),this.app.broadcast("link.inserted",i)):(this.caret.setAfter(i),w=i.clone(),i.remove(),i=this.insertion.insertHtml(w),i=this.component.build(i)),this.app.broadcast("autoparse",r,i))}}},_formatLinks:function(n){for(var o,s,f,e=n.match(this.opts.regex.url),r={},u=0;u<e.length;u++){var i=e[u],t=i,h=i.match(/(https?|ftp):\/\//i)!==null?"":"http://",c=["/","&","="].indexOf(i.slice(-1))!==-1?"":"\\b",l=this.opts.pasteLinkTarget!==!1?' target="'+this.opts.pasteLinkTarget+'"':"";t=t.length>this.opts.linkSize?t.substring(0,this.opts.linkSize)+"...":t;t=t.search("%")===-1?decodeURIComponent(t):t;o="("+i.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+c+")";s=' class="redactor-autoparser-object"';r[o]='<a href="'+h+i.trim()+'"'+l+s+">"+t.trim()+"<\/a>"}for(f in r)n=n.replace(new RegExp(f,"g"),r[f]);return n},_convertToRegExp:function(n){return new RegExp(String(n).replace(/^\//,"").replace(/\/ig$/,"").replace(/\/gi$/,"")+"$","gi")}});n.add("service","storage",{init:function(n){this.app=n;this.data=[]},observeImages:function(){var n=this.editor.getElement(),t=n.find("[data-image]");t.each(this._addImage.bind(this))},observeFiles:function(){var n=this.editor.getElement(),t=n.find("[data-file]");t.each(this._addFile.bind(this))},setStatus:function(n,t){this.data[n].status=t},getChanges:function(){var r=this.editor.getElement(),t,n,i;for(t in this.data)n=this.data[t],i=r.find("[data-"+n.type+'="'+n.id+'"]'),this.setStatus(n.id,i.length===0?!1:!0);return this.data},add:function(t,i){var r=n.dom(i),u=r.attr("data-"+t);this.data[u]={type:t,status:!0,node:r.get(),id:r.attr("data-"+t)}},_addImage:function(n){this.add("image",n)},_addFile:function(n){this.add("file",n)}});n.add("service","utils",{init:function(n){this.app=n},isEmpty:function(t){var i=!1;return t=n.dom(t).get(),t&&(i=t.nodeType===3?t.textContent.trim().replace(/\n/,"")==="":t.innerHTML===""),i},isEmptyHtml:function(n,t,i){return n=this.removeInvisibleChars(n),n=n.replace(/&nbsp;/gi,""),n=n.replace(/<\/?br\s?\/?>/g,t?"br":""),n=n.replace(/\s/g,""),n=n.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,""),n=n.replace(/^<div>[^\W\w\D\d]*?<\/div>$/i,""),i&&(n=n.replace(/<ul(.*?[^>])>$/i,"ul"),n=n.replace(/<ol(.*?[^>])>$/i,"ol")),n=n.replace(/<hr(.*?[^>])>$/i,"hr"),n=n.replace(/<iframe(.*?[^>])>$/i,"iframe"),n=n.replace(/<source(.*?[^>])>$/i,"source"),n=n.replace(/<[^\/>][^>]*><\/[^>]+>/gi,""),n=n.replace(/<[^\/>][^>]*><\/[^>]+>/gi,""),n=n.trim(),n===""},trimSpaces:function(n){return this.removeInvisibleChars(n.trim())},createInvisibleChar:function(){return document.createTextNode(this.opts.markerChar)},searchInvisibleChars:function(n){return n.search(/^[\u200B-\u200D\uFEFF]$/g)},removeInvisibleChars:function(n){return n.replace(/[\u200B-\u200D\uFEFF]/g,"")},buildWrapper:function(t){return n.dom("<div>").html(t)},getWrapperHtml:function(n){var t=n.html();return n.remove(),t},createTmpContainer:function(t){var i=n.dom("<div>");return typeof t=="string"?i.html(t):i.append(n.dom(t).clone(!0)),i.get()},createFragment:function(n){for(var s=this.createTmpContainer(n),i=document.createDocumentFragment(),r,u,f,e=[],o=0,t;r=s.firstChild;)o++,t=i.appendChild(r),o===1&&(u=t),e.push(t),f=t;return{frag:i,first:u,last:f,nodes:e}},isFragment:function(n){return typeof n=="object"&&n.frag},parseHtml:function(n){var t=this.createTmpContainer(n);return{html:t.innerHTML,nodes:t.childNodes}},splitNode:function(t,i,r,u){var e,f,c,s,o;if(i=this.isFragment(i)?i.frag:i,e=u?this.inspector.isInlineTag(t.tagName)?t:this.selection.getInline(t):this.inspector.isBlockTag(t.tagName)?t:this.selection.getBlock(t),f=n.dom(e),!u&&this.isEmptyHtml(e.innerHTML,!0))return f.after(i),f.remove(),i;var l=f.get().tagName.toLowerCase(),a=this.caret.isEnd(e),h=this.caret.isStart(e);return a||h||(c=this.extractHtmlFromCaret(u),s=n.dom("<"+l+" />"),s=this.cloneAttributes(e,s),f.after(s.append(c))),h?f.before(i):r?f.append(i):(i=f.after(i),o=f.html(),o=this.removeInvisibleChars(o),o=o.replace(/&nbsp;/gi,""),o===""&&f.remove(),i)},extractHtmlFromCaret:function(n,t){var i=this.selection.getRange(),r;if(i&&(t=t?t:n?this.selection.getInline():this.selection.getBlock(),t))return r=i.cloneRange(),r.selectNodeContents(t),r.setStart(i.endContainer,i.endOffset),r.extractContents()},createMarkup:function(t){var i=document.createElement(this.opts.markup),r;this.opts.breakline&&i.setAttribute("data-redactor-tag","br");r=n.dom(t);r.after(i);this.caret.setStart(i)},getNode:function(t){var i=n.dom(t).get(),r=this.editor.getElement().get();return typeof t=="undefined"?r:i?i:!1},findSiblings:function(t,i){for(t=n.dom(t).get(),i=i==="next"?"nextSibling":"previousSibling";t=t[i];)if((t.nodeType!==3||t.textContent.trim()!=="")&&t.tagName!=="BR")return t;return!1},getElementsFromHtml:function(n,t,i){var r=document.createElement("div"),u,f;return r.innerHTML=n,u=r.querySelectorAll(t),f=function(n,t){var r,i;if(typeof this.length=="number"&&typeof n=="function"){if(r=[],typeof this=="object")for(i=0;i<this.length;i++)if(i in this)r[i]=n.call(t||this,this[i],i,this);else return;return r}},f.call(u,function(n){var t=n.getAttribute("data-redactor-type");if(!i||!t||t!==i)return n.outerHTML})},getChildNodes:function(t,i,r){var u,e,f,o;if(t=t&&t.nodeType&&t.nodeType===11?t:n.dom(t).get(),u=t.childNodes,e=[],u)for(f=0;f<u.length;f++){if(r===!0&&u[f].nodeType===3)continue;else if(u[f].nodeType===3&&this.isEmpty(u[f]))continue;e.push(u[f]);i!==!1&&(o=this.getChildNodes(u[f],r),o.length>0&&(e=e.concat(o)))}return e},getChildElements:function(n){return this.getChildNodes(n,!0,!0)},getFirstNode:function(n){return this._getFirst(this.getChildNodes(n,!1))},getLastNode:function(n){return this._getLast(this.getChildNodes(n,!1))},getFirstElement:function(n){return this._getFirst(this.getChildNodes(n,!1,!0))},getLastElement:function(n){return this._getLast(this.getChildNodes(n,!1,!0))},replaceToTag:function(t,i){var r=n.dom(t);return r.replaceWith(function(t){var f=n.dom("<"+i+">").append(n.dom(t).contents()),u,r;if(t.attributes)for(u=t.attributes,r=0;r<u.length;r++)f.attr(u[r].nodeName,u[r].value);return f})},ucfirst:function(n){return n.charAt(0).toUpperCase()+n.slice(1)},removeFromArrayByValue:function(n,t){for(var i=arguments,r=i.length,u;r>1&&n.length;)for(t=i[--r];(u=n.indexOf(t))!==-1;)n.splice(u,1);return n},removeEmptyAttr:function(t,i){var r=n.dom(t);return typeof r.attr(i)=="undefined"||r.attr(i)===null?!0:r.attr(i)===""?(r.removeAttr(i),!0):!1},cloneAttributes:function(t,i){var r,u,f;for(t=n.dom(t).get(),i=n.dom(i),r=t.attributes,u=r.length;u--;)f=r[u],i.attr(f.name,f.value);return i},toParams:function(n){var i=Object.keys(n),r,t,u;if(!i.length)return"";for(r="",t=0;t<i.length;t++)u=i[t],r+=u+":"+n[u]+";";return r},styleToObj:function(n){var u={},i,t,r;if(n)for(i=n.replace(/;$/,"").split(";"),t=0;t<i.length;t++)r=i[t].split(":"),u[r[0].trim()]=r[1].trim();return u},checkProperty:function(n){for(var i=arguments[1]&&Array.isArray(arguments[1])?arguments[1]:[].slice.call(arguments,1),t=0;t<i.length;t++){if(!n||typeof n[i[t]]=="undefined")return!1;n=n[i[t]]}return n},extendData:function(t,i){var r,u;for(r in i)r==="elements"?(u=n.dom(i[r]),u.each(function(i){var r=n.dom(i),u,f,e;if(i.tagName==="FORM"){u=r.serialize(!0);for(f in u)t=this._setData(t,f,u[f])}else e=r.attr("name")?r.attr("name"):r.attr("id"),t=this._setData(t,e,r.val())}.bind(this))):t=this._setData(t,r,i[r]);return t},_setData:function(n,t,i){return n instanceof FormData?n.append(t,i):n[t]=i,n},normalizeTextNodes:function(t){t=n.dom(t).get();t&&t.normalize()},isRgb:function(n){return n.search(/^rgb/i)===0},rgb2hex:function(n){return n=n.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i),n&&n.length===4?"#"+("0"+parseInt(n[1],10).toString(16)).slice(-2)+("0"+parseInt(n[2],10).toString(16)).slice(-2)+("0"+parseInt(n[3],10).toString(16)).slice(-2):""},hex2long:function(n){return n.search(/^#/)!==-1&&n.length===4&&(n="#"+n[1]+n[1]+n[2]+n[2]+n[3]+n[3]),n},escapeRegExp:function(n){return n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},getRandomId:function(){for(var n="",t="abcdefghijklmnopqrstuvwxyz0123456789",i=0;i<12;i++)n+=t.charAt(Math.floor(Math.random()*t.length));return n},_getFirst:function(n){return n.length!==0?n[0]:!1},_getLast:function(n){return n.length!==0?n[n.length-1]:!1}});n.add("service","progress",{init:function(n){this.app=n;this.$box=null;this.$bar=null},show:function(){this._is()||this._build();this.$box.show()},hide:function(){this._is()&&this.animate.start(this.$box,"fadeOut",this._destroy.bind(this))},update:function(n){this.show();this.$bar.css("width",n+"%")},_is:function(){return this.$box!==null},_build:function(){this.$bar=n.dom("<span />");this.$box=n.dom('<div id="redactor-progress" />');this.$box.append(this.$bar);this.$body.append(this.$box)},_destroy:function(){this._is()&&this.$box.remove();this.$box=null;this.$bar=null}});n.add("module","starter",{init:function(n){this.app=n;this.opts=n.opts;this.plugin=n.plugin;this.module=n.module},onstart:function(){this._startStop("start",this.app,["element","container","source","editor","statusbar","toolbar"]);this._startStop("start",this.module,["element","container","source","editor","statusbar","contextbar","input"])},onstop:function(){this._startStop("stop",this.module,["observer","element","container","source","editor","contextbar"])},onenable:function(){var n=this.opts.plugins;this._startStop("start",this.module,["observer","toolbar"]);this._startStop("start",this.plugin,n)},ondisable:function(){var n=this.opts.plugins;this._startStop("stop",this.module,["observer","toolbar"]);this._startStop("stop",this.plugin,n)},_startStop:function(n,t,i){for(var r=0;r<i.length;r++)typeof t[i[r]]!="undefined"&&this.app.callInstanceMethod(t[i[r]],n)}});n.add("module","element",{init:function(t){this.app=t;this.uuid=t.uuid;this.opts=t.opts;this.namespace=t.namespace;this.element=t.element;this.rootOpts=n.extend({},!0,n.options,t.rootOpts)},start:function(){this._build();this._buildModes();this._buildMarkup()},stop:function(){var n=this.element.getElement();n.removeData(this.namespace+"-uuid")},_build:function(){var n=this.element.getElement();n.data(this.namespace+"-uuid",this.uuid)},_buildModes:function(){var n=this.element.getType();n==="inline"&&this._redefineOptions(this.opts.modes.inline);n==="div"&&this._redefineOptions(this.opts.modes.original);n!=="inline"&&(this._isRootOption("styles")&&this.rootOpts.styles&&(this.opts.styles=!0),this._isRootOption("source")&&!this.rootOpts.source&&(this.opts.showSource=!1))},_buildMarkup:function(){var n=this.element.getType();n==="inline"?this.opts.emptyHtml="":this.opts.breakline?(this.opts.markup="div",this.opts.emptyHtml='<div data-redactor-tag="br">'+this.opts.markerChar+"<\/div>"):this.opts.emptyHtml="<"+this.opts.markup+"><\/"+this.opts.markup+">"},_redefineOptions:function(n){for(var t in n)this.opts[t]=n[t]},_isRootOption:function(){return typeof this.rootOpts.styles!="undefined"}});n.add("module","editor",{init:function(n){this.app=n;this.uuid=n.uuid;this.opts=n.opts;this.editor=n.editor;this.source=n.source;this.element=n.element;this.component=n.component;this.container=n.container;this.inspector=n.inspector;this.autoparser=n.autoparser;this.placeholder=!1;this.events=!1},onenable:function(){this.enable()},ondisable:function(){this.disable()},onenablefocus:function(){this._enableFocus()},oncontextmenu:function(n){this.component.setOnEvent(n,!0)},onclick:function(n){this.component.setOnEvent(n)},onkeyup:function(n){var t=this.inspector.parse(n.target);t.isComponent()||this.component.clearActive()},onenablereadonly:function(){this._enableReadOnly()},ondisablereadonly:function(){this._disableReadOnly()},onautoparseobserve:function(){this.autoparser.observe()},onplaceholder:{build:function(){this._buildPlaceholder()},toggle:function(){this._togglePlacehodler()}},start:function(){this._build();this._buildEvents();this._buildOptions();this._buildAccesibility()},stop:function(){var n=this.editor.getElement(),t=this.container.getElement(),i=["redactor-in","redactor-in-"+this.uuid,"redactor-structure","redactor-placeholder",this.opts.stylesClass];n.removeAttr("spellcheck");n.removeAttr("dir");n.removeAttr("contenteditable");n.removeAttr("placeholder");n.removeAttr("data-gramm_editor");n.removeClass(i.join(" "));t.removeClass("redactor-focus redactor-blur redactor-over redactor-styles-on redactor-styles-off redactor-toolbar-on redactor-text-labeled-on redactor-source-view");this._destroyEvents();n.get().classList.length===0&&n.removeAttr("class")},enable:function(){var n=this.editor.getElement(),t=this.container.getElement();n.addClass("redactor-in redactor-in-"+this.uuid);n.attr({contenteditable:!0});this.opts.structure&&n.addClass("redactor-structure");!this.opts.toolbar||this.opts.air||this.opts.toolbarExternal||t.addClass("redactor-toolbar-on");this._disableBrowsersEditing()},disable:function(){var n=this.editor.getElement(),t=this.container.getElement();n.removeClass("redactor-in redactor-in-"+this.uuid);n.removeClass("redactor-structure");n.removeAttr("contenteditable");t.addClass("redactor-toolbar-on")},_build:function(){var t=this.editor.getElement(),i=this.element.getElement(),n=this.container.getElement();n.addClass("redactor-blur");this.opts.grammarly||t.attr("data-gramm_editor",!1);this.opts.styles?(t.addClass(this.opts.stylesClass),n.addClass("redactor-styles-on")):n.addClass("redactor-styles-off");this.opts.buttonsTextLabeled&&n.addClass("redactor-text-labeled-on");this.element.isType("textarea")&&i.before(t)},_buildEvents:function(){this.events=n.create("editor.events",this.app)},_buildOptions:function(){var n=this.editor.getElement();n.attr("dir",this.opts.direction);this.opts.tabindex&&n.attr("tabindex",this.opts.tabindex);this.opts.minHeight&&n.css("min-height",this.opts.minHeight);this.opts.maxHeight&&n.css("max-height",this.opts.maxHeight);this.opts.maxWidth&&n.css({"max-width":this.opts.maxWidth,margin:"auto"})},_buildAccesibility:function(){var n=this.editor.getElement();n.attr({"aria-labelledby":"redactor-voice-"+this.uuid,role:"presentation"})},_buildPlaceholder:function(){this.placeholder=n.create("editor.placeholder",this.app)},_enableFocus:function(){this.opts.showSource?this._enableFocusSource():this._enableFocusEditor()},_enableFocusSource:function(){var n=this.source.getElement();this.opts.focus?(n.focus(),n.get().setSelectionRange(0,0)):this.opts.focusEnd&&n.focus()},_enableFocusEditor:function(){this.opts.focus?setTimeout(this.editor.startFocus.bind(this.editor),100):this.opts.focusEnd&&setTimeout(this.editor.endFocus.bind(this.editor),100)},_togglePlacehodler:function(){this.placeholder&&this.placeholder.toggle()},_disableBrowsersEditing:function(){try{document.execCommand("enableObjectResizing",!1,!1);document.execCommand("enableInlineTableEditing",!1,!1);document.execCommand("AutoUrlDetect",!1,!1);var t=this.editor.getElement(),n=t.get();n.addEventListener?n.addEventListener("mscontrolselect",function(n){n.preventDefault()}):n.attachEvent("oncontrolselect",function(n){n.returnValue=!1})}catch(i){}},_destroyEvents:function(){this.events&&this.events.destroy()},_enableReadOnly:function(){var n=this.editor.getElement();this._getEditables(n).removeAttr("contenteditable");n.removeAttr("contenteditable");n.addClass("redactor-read-only");this.events&&this.events.destroy()},_disableReadOnly:function(){var n=this.editor.getElement();this._getEditables(n).attr({contenteditable:!0});n.removeClass("redactor-read-only");n.attr({contenteditable:!0});this._buildEvents()},_getEditables:function(n){return n.find("figcaption, td, th")}});n.add("class","editor.placeholder",{init:function(n){this.app=n;this.opts=n.opts;this.editor=n.editor;this.element=n.element;this.build()},build:function(){var n=this.element.getElement(),i=this.editor.getElement(),t;(this.opts.placeholder!==!1||n.attr("placeholder"))&&(t=this.opts.placeholder!==!1?this.opts.placeholder:n.attr("placeholder"),i.attr("placeholder",t),this.toggle())},toggle:function(){return this.editor.isEmpty(!0)?this.show():this.hide()},show:function(){var n=this.editor.getElement();n.addClass("redactor-placeholder")},hide:function(){var n=this.editor.getElement();n.removeClass("redactor-placeholder")}});n.add("class","editor.events",{init:function(n){this.app=n;this.opts=n.opts;this.$doc=n.$doc;this.uuid=n.uuid;this.editor=n.editor;this.cleaner=n.cleaner;this.container=n.container;this.insertion=n.insertion;this.inspector=n.inspector;this.selection=n.selection;this.component=n.component;this.blurNamespace=".redactor-blur."+this.uuid;this.eventsList=["paste","click","contextmenu","keydown","keyup","mouseup","touchstart","cut","copy","dragenter","dragstart","drop","dragover","dragleave"];this._init()},destroy:function(){var n=this.editor.getElement();n.off(".redactor-focus");this.$doc.off("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace);this._loop("off")},focus:function(n){var t=this.container.getElement();this.editor.isPasting()||t.hasClass("redactor-focus")||(t.addClass("redactor-focus"),t.removeClass("redactor-blur"),this.app.broadcast("observe",n),this.app.broadcast("focus",n),this.isFocused=!0,this.isBlured=!1)},blur:function(t){var i=this.container.getElement(),r=n.dom(t.target),u=[".redactor-in-"+this.uuid,".redactor-toolbar",".redactor-dropdown",".redactor-context-toolbar","#redactor-modal-box","#redactor-image-resizer"];(this.app.broadcast("originalblur",t),this.app.stopBlur)||this.app.isStarted()&&!this.editor.isPasting()&&r.closest(u.join(",")).length===0&&(this.isBlured||i.hasClass("redactor-blur")||(i.removeClass("redactor-focus"),i.addClass("redactor-blur"),this.app.broadcast("blur",t),this.isFocused=!1,this.isBlured=!0))},cut:function(n){var t=this.selection.getCurrent(),i=this.inspector.parse(t);this.app.broadcast("state",n);this.component.isNonEditable(t)&&(this._passSelectionToClipboard(n,i,!0),n.preventDefault())},copy:function(n){var t=this.selection.getCurrent(),i=this.inspector.parse(t);this.app.broadcast("state",n);this.component.isNonEditable(t)&&(this._passSelectionToClipboard(n,i,!1),n.preventDefault())},drop:function(t){var u,f,r,i;if(t=t.originalEvent||t,t.stopPropagation(),this._removeOverClass(),this.app.isDragComponentInside()){u=n.dom(this.app.getDragComponentInside());f=u.clone(!0);this.insertion.insertToPoint(t,f);u.remove();this.app.setDragComponentInside(!1);this.app.broadcast("state",t);this.app.broadcast("drop",t);this.app.broadcast("image.observe",t);t.preventDefault();return}if(this.app.isDragInside()&&this.opts.input){this.insertion.insertPoint(t);var o=t.dataTransfer,s=o.getData("text/html"),e=this.selection.getRange();if(e)for(r=this.selection.getBlocks(),e.deleteContents(),i=0;i<r.length;i++)r[i].innerHTML===""&&n.dom(r[i]).remove();n.create("input.paste",this.app,t,!0,s,!0);this.app.broadcast("state",t);this.app.broadcast("drop",t);this.app.setDragInside(!1);t.preventDefault();return}this.app.broadcast("state",t);this.app.broadcast("paste",t,t.dataTransfer);this.app.broadcast("drop",t)},dragenter:function(n){n.preventDefault()},dragstart:function(n){this.app.setDragComponentInside(!1);this.app.setDragInside(!1);var t=this.inspector.parse(n.target);!t.isComponent()||t.isComponentEditable()||t.isFigcaption()?this.selection.is()&&!this.selection.isCollapsed()&&(this.app.setDragInside(!0),this._setDragData(n)):this.app.setDragComponentInside(t.getComponent());this.app.broadcast("dragstart",n)},dragover:function(n){this.app.broadcast("dragover",n)},dragleave:function(n){this.app.broadcast("dragleave",n)},paste:function(n){this.app.broadcast("paste",n)},contextmenu:function(n){this.editor.disableNonEditables();setTimeout(function(){this.editor.enableNonEditables();this.app.broadcast("contextmenu",n)}.bind(this),0)},click:function(n){if(n.detail===3){n.preventDefault();var i=this.selection.getBlock(),t=document.createRange();t.selectNodeContents(i);this.selection.setRange(t)}this.app.broadcast("state",n);this.app.broadcast("click",n)},keydown:function(n){this.app.broadcast("state",n);var t=this.app.broadcast("keydown",n);if(t===!1)return n.preventDefault()},keyup:function(n){this.app.broadcast("observe",n);this.app.broadcast("keyup",n)},mouseup:function(n){this.app.broadcast("observe",n);this.app.broadcast("state",n)},touchstart:function(n){this.app.broadcast("observe",n);this.app.broadcast("state",n)},_init:function(){var n=this.editor.getElement();n.on("focus.redactor-focus click.redactor-focus",this.focus.bind(this));this.$doc.on("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace,this.blur.bind(this));this._loop("on")},_removeOverClass:function(){var n=this.editor.getElement();n.removeClass("over")},_loop:function(n){for(var i,r,u=this.editor.getElement(),t=0;t<this.eventsList.length;t++)i=this.eventsList[t]+".redactor-events",r=this.eventsList[t],u[n](i,this[r].bind(this))},_passSelectionToClipboard:function(t,i,r){var e=t.clipboardData,o=i.getComponent(),s=n.dom(o),u=s.clone(),f;u.find(".redactor-component-caret").remove();u.removeClass("redactor-component-active");u.removeAttr("contenteditable");u.removeAttr("tabindex");f=u.get().outerHTML;r&&this.component.remove(o);e.setData("text/html",f);e.setData("text/plain",f.toString().replace(/\n$/,""))},_setDragData:function(n){n=n.originalEvent||n;var t=n.dataTransfer;t.effectAllowed="move";t.setData("text/Html",this.selection.getHtml())}});n.add("module","container",{init:function(n){this.app=n;this.uuid=n.uuid;this.opts=n.opts;this.lang=n.lang;this.element=n.element;this.container=n.container},start:function(){this._build();this._buildAccesibility()},stop:function(){var n=this.element.getElement(),t=this.container.getElement();t.after(n);t.remove();n.show()},_build:function(){var t=this.element.getElement(),n=this.container.getElement();n.addClass("redactor-box");n.attr("dir",this.opts.direction);this.element.isType("inline")&&n.addClass("redactor-inline");t.after(n);n.append(t)},_buildAccesibility:function(){var i=this.container.getElement(),t=n.dom("<span />");t.addClass("redactor-voice-label");t.attr({id:"redactor-voice-"+this.uuid,"aria-hidden":!1});t.html(this.lang.get("accessibility-help-label"));i.prepend(t)}});n.add("module","source",{init:function(n){this.app=n;this.uuid=n.uuid;this.opts=n.opts;this.utils=n.utils;this.element=n.element;this.source=n.source;this.editor=n.editor;this.toolbar=n.toolbar;this.cleaner=n.cleaner;this.component=n.component;this.container=n.container;this.autoparser=n.autoparser;this.selection=n.selection;this.syncedHtml=""},onstartcode:function(){var n=this.source.getStartedContent(),r=this.editor.getElement(),u=this.source.getElement(),t,i;this.opts.autoparse&&this.opts.autoparseStart&&(n=this.autoparser.parse(n));t=this.cleaner.input(n,!0,!0);i=this.cleaner.output(t);r.html(t);u.val(i);this.syncedHtml=i;this.app.broadcast("placeholder.build");this.app.broadcast("autoparseobserve");this.component.executeScripts()},onstartcodeshow:function(){this.show()},ontrytosync:function(){this.sync()},start:function(){this._build();this._buildClasses()},stop:function(){var t=this.element.getElement(),n=this.source.getElement();t.removeClass("redactor-source redactor-source-open");n.off("input.redactor-source");n.removeAttr("data-gramm_editor");n.get().classList.length===0&&n.removeAttr("class");this.source.isNameGenerated()||t.removeAttr("name");this.element.isType("textarea")||n.remove()},getCode:function(){return this.source.getCode()},toggle:function(){if(this.opts.source){var n=this.source.getElement();return n.hasClass("redactor-source-open")?this.hide():this.show()}},show:function(){var u,i,e;if(this.opts.source){var f=this.editor.getElement(),t=this.source.getElement(),o=this.container.getElement(),r=t.val();this.app.isStarted()&&(r=this.app.broadcast("source.open",r));u=n.create("source.selection",this.app);i=u.insertMarkersToEditor();i=this.cleaner.output(i,!1);i=i.trim();e=f.height();f.hide();t.height(e);t.val(r.trim());t.show();t.addClass("redactor-source-open");t.on("input.redactor-source-events",this._onChangedSource.bind(this));t.on("keydown.redactor-source-events",this._onTabKey.bind(this));t.on("focus.redactor-source-events",this._onFocus.bind(this));o.addClass("redactor-source-view");u.setSelectionOffsetSource(i);setTimeout(function(){this._disableButtons();this._setActiveSourceButton()}.bind(this),100);this.app.isStarted()&&this.app.broadcast("source.opened")}},hide:function(){if(this.opts.source){var u=this.editor.getElement(),i=this.source.getElement(),f=this.container.getElement(),t=i.val(),r=n.create("source.selection",this.app);t=r.insertMarkersToSource(t);t=this.cleaner.input(t,!0);t=this.utils.isEmptyHtml(t)?this.opts.emptyHtml:t;t=this.app.broadcast("source.close",t);this._enableButtons();this._setInactiveSourceButton();i.hide();i.removeClass("redactor-source-open");i.off(".redactor-source-events");u.show();u.html(t);f.removeClass("redactor-source-view");setTimeout(function(){r.isOffset()?this.selection.restoreMarkers():r.isOffsetEnd()?this.editor.endFocus():this.editor.startFocus();this.component.executeScripts()}.bind(this),0);this.app.broadcast("source.closed")}},sync:function(){var t=this,i=this.editor.getElement(),n=i.html();n=this.app.broadcast("syncBefore",n);n=this.cleaner.output(n);this._isSync(n)&&(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){t._syncing(n)},200))},_build:function(){var n=this.source.getElement(),t=this.element.getElement();n.hide();this.opts.grammarly||n.attr("data-gramm_editor",!1);this.element.isType("textarea")||t.after(n)},_buildClasses:function(){var n=this.source.getElement();n.addClass("redactor-source")},_syncing:function(n){n=this.app.broadcast("syncing",n);var t=this.source.getElement();t.val(n);this.app.broadcast("synced",n);this.app.broadcast("changed",n)},_isSync:function(n){return this.syncedHtml!==n?(this.syncedHtml=n,!0):!1},_onChangedSource:function(){var t=this.source.getElement(),n=t.val();this.app.broadcast("changed",n);this.app.broadcast("source.changed",n)},_onTabKey:function(n){if(n.keyCode!==9)return!0;n.preventDefault();var t=this.source.getElement(),i=t.get(),r=i.selectionStart;t.val(t.val().substring(0,r)+"    "+t.val().substring(i.selectionEnd));i.selectionStart=i.selectionEnd=r+4},_onFocus:function(){this.app.broadcast("sourcefocus")},_disableButtons:function(){this.toolbar.disableButtons()},_enableButtons:function(){this.toolbar.enableButtons()},_setActiveSourceButton:function(){var n=this.toolbar.getButton("html");n.enable();n.setActive()},_setInactiveSourceButton:function(){var n=this.toolbar.getButton("html");n.setInactive()}});n.add("class","source.selection",{init:function(n){this.app=n;this.utils=n.utils;this.source=n.source;this.editor=n.editor;this.marker=n.marker;this.component=n.component;this.selection=n.selection;this.markersOffset=!1;this.markersOffsetEnd=!1},insertMarkersToEditor:function(){var r=this.editor.getElement(),u=this.marker.build("start"),f=this.marker.build("end"),i=this.component.getActive(),t;return i?(this.marker.remove(),t=n.dom(i),t.after(f),t.after(u)):window.getSelection&&this.selection.is()&&this.marker.insert("both"),this._getHtmlAndRemoveMarkers(r)},setSelectionOffsetSource:function(n){var t=0,i=0,r=this.source.getElement(),f,u;n!==""&&(f=this.utils.removeInvisibleChars(this.marker.buildHtml("start")),u=this.utils.removeInvisibleChars(this.marker.buildHtml("end")),t=this._strpos(n,f),i=this._strpos(n,u)-u.toString().length-2,t===!1&&(t=0,i=0));r.get().setSelectionRange(t,i);r.get().scrollTop=0;setTimeout(function(){r.focus()}.bind(this),0)},isOffset:function(){return this.markersOffset},isOffsetEnd:function(){return this.markersOffsetEnd},insertMarkersToSource:function(n){var r=this.source.getElement(),u=this.marker.buildHtml("start"),e=this.marker.buildHtml("end"),f=u.toString().length,t=this._enlargeOffset(n,r.get().selectionStart),i=this._enlargeOffset(n,r.get().selectionEnd),o=n.length;return t===o?this.markersOffsetEnd=!0:t!==0&&i!==0?(this.markersOffset=!0,n=n.substr(0,t)+u+n.substr(t),n=n.substr(0,i+f)+e+n.substr(i+f)):this.markersOffset=!1,n},_getHtmlAndRemoveMarkers:function(n){var t=n.html();return n.find(".redactor-selection-marker").remove(),t},_strpos:function(n,t,i){var r=n.indexOf(t,i);return r>=0?r:!1},_enlargeOffset:function(n,t){var u=n.length,r=0,i;if(n[t]===">")r++;else for(i=t;i<=u;i++)if(r++,n[i]===">")break;else if(n[i]==="<"||i===u){r=0;break}return t+r}});n.add("module","observer",{init:function(n){this.app=n;this.editor=n.editor;this.observerUnit=!1},start:function(){if(window.MutationObserver){var t=this.editor.getElement(),n=t.get();this.observerUnit=this._build(n);this.observerUnit.observe(n,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0})}},stop:function(){this.observerUnit&&this.observerUnit.disconnect()},_build:function(n){var t=this;return new MutationObserver(function(i){i.forEach(function(i){t._iterate(i,n)})})},_iterate:function(n,t){this.app.isReadOnly()||n.type==="attributes"&&n.target===t||(this.app.broadcast("observe"),this.app.broadcast("trytosync"),this.app.broadcast("placeholder.toggle"))}});n.add("module","clicktoedit",{init:function(n){this.app=n;this.opts=n.opts;this.source=n.source;this.editor=n.editor;this.container=n.container;this.selection=n.selection},onstartclicktoedit:function(){this.start()},onenablereadonly:function(){this._isEnabled()||this.stop()},ondisablereadonly:function(){this._isEnabled()||this.start()},onstop:function(){this.stop()},start:function(){this._build()},stop:function(){this.buttonSave&&this.buttonSave.stop();this.buttonCancel&&this.buttonCancel.stop();this._destroy();this.app.broadcast("disable")},enable:function(){var n,t;this.app.broadcast("clickStart");n=this.editor.isEmpty();n||this.selection.saveMarkers();this._setFocus();this._destroy();this.app.broadcast("enable");this.buttonSave.enable();this.buttonCancel.enable();n||this.selection.restoreMarkers();n&&this.editor.focus();t=this.container.getElement();t.addClass("redactor-clicktoedit-enabled")},save:function(n){n&&n.preventDefault();var t=this.source.getCode();this.app.broadcast("disable");this.app.broadcast("clickSave",t);this.app.broadcast("clickStop");this._build()},cancel:function(n){n&&n.preventDefault();var t=this.saved,i=this.editor.getElement();i.html(t);this.saved="";this.app.broadcast("disable");this.app.broadcast("clickCancel",t);this.app.broadcast("clickStop");this._build()},_build:function(){this.buttonSave=n.create("clicktoedit.button","save",this.app,this);this.buttonCancel=n.create("clicktoedit.button","cancel",this.app,this);this.buttonSave.stop();this.buttonCancel.stop();var i=this.editor.getElement(),t=this.container.getElement();i.on("click.redactor-click-to-edit mouseup.redactor-click-to-edit",this.enable.bind(this));t.addClass("redactor-over");t.removeClass("redactor-clicktoedit-enabled")},_isEnabled:function(){return this.container.getElement().hasClass("redactor-clicktoedit-enabled")},_destroy:function(){var n=this.editor.getElement(),t=this.container.getElement();n.off(".redactor-click-to-edit");t.removeClass("redactor-over redactor-clicktoedit-enabled")},_setFocus:function(){this.saved=this.source.getCode();this.buttonSave.start();this.buttonCancel.start()}});n.add("class","clicktoedit.button",{init:function(n,t,i){this.app=t;this.opts=t.opts;this.toolbar=t.toolbar;this.context=i;this.type=n;this.name=n==="save"?"clickToSave":"clickToCancel";this.objected=!1;this.enabled=!1;this.namespace=".redactor-click-to-edit";this._build()},enable:function(){if(this.objected){var n=this.opts[this.name];n.api="module.clicktoedit."+this.type;this.toolbar.addButton(this.type,n);this.enabled=!0}},start:function(){if(!this.objected){this.$button.off(this.namespace);this.$button.show();this.$button.on("click"+this.namespace,this.context[this.type].bind(this.context))}},stop:function(){!this.objected&&this.enabled&&this.$button.hide()},_build:function(){this.objected=typeof this.opts[this.name]=="object";this.objected||(this.$button=n.dom(this.opts[this.name]),this.enabled=!0)}});n.add("module","statusbar",{init:function(n){this.app=n;this.opts=n.opts;this.element=n.element;this.statusbar=n.statusbar;this.container=n.container},start:function(){if(!this.element.isType("inline")){var n=this.statusbar.getElement(),t=this.container.getElement();n.addClass("redactor-statusbar");t.append(n)}}});n.add("module","contextbar",{init:function(n){this.app=n;this.opts=n.opts;this.uuid=n.uuid;this.$win=n.$win;this.$doc=n.$doc;this.$body=n.$body;this.editor=n.editor;this.toolbar=n.toolbar;this.detector=n.detector;this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body},onenablereadonly:function(){this.stop()},ondisablereadonly:function(){this.start()},oncontextbar:{close:function(){this.close()}},start:function(){if(this.opts.toolbarContext){var n=this.editor.getElement();this._build();n.on("click.redactor-context mouseup.redactor-context",this.open.bind(this))}},stop:function(){var n=this.editor.getElement();n.off(".redactor-context");this.$doc.off(".redactor-context");this.$win.off(".redactor-context");this.$contextbar&&this.$contextbar.remove()},is:function(){return this.$contextbar&&this.$contextbar.hasClass("open")},set:function(t,i,r,u){var e,f,o;this.$contextbar.html("");this.$el=n.dom(i);for(e in r)f=n.create("contextbar.button",this.app,r[e]),f.html()!==""&&this.$contextbar.append(f);o=this._buildPosition(t,this.$el,u);this.$contextbar.css(o);this.$contextbar.show();this.$contextbar.addClass("open");this.$doc.on("click.redactor-context mouseup.redactor-context",this.close.bind(this));this.$win.on("resize.redactor-context",this.close.bind(this))},open:function(n){setTimeout(function(){this.app.broadcast("contextbar",n,this)}.bind(this),0)},close:function(t){if(this.$contextbar){if(t){var i=n.dom(t.target);if(this.$el&&i.closest(this.$el).length!==0)return}this.$contextbar.hide();this.$contextbar.removeClass("open");this.$doc.off(".redactor.context")}},_build:function(){this.$contextbar=n.dom("<div>");this.$contextbar.attr("id","redactor-context-toolbar-"+this.uuid);this.$contextbar.attr("dir",this.opts.direction);this.$contextbar.addClass("redactor-context-toolbar");this.$contextbar.hide();this.$target.append(this.$contextbar)},_buildPosition:function(n,t,i){var u,r,f=this.toolbar.isTarget(),e=f?t.position():t.offset(),s=t.width(),l=t.height(),o=this.$contextbar.width(),h=this.$contextbar.height(),a=f?this.$target.scrollTop()+this.$doc.scrollTop():this.$doc.scrollTop(),c=this.$target.offset(),v=f?c.left:0,y=f?c.top:0;return i?i==="top"?(u=e.top-h,r=e.left+s/2-o/2):i==="bottom"&&(u=e.top+l,r=e.left+s/2-o/2):(u=n.clientY+a-h,r=n.clientX-o/2),r<0&&(r=0),{top:u-y+"px",left:r-v+"px"}}});n.add("class","contextbar.button",{mixins:["dom"],init:function(n,t){this.app=n;this.obj=t;this._init()},_init:function(){this.parse("<a>");this.attr("href","#");this._buildTitle();this._buildMessage()},_buildTitle:function(){this.html(this.obj.title)},_buildMessage:function(){if(typeof this.obj.message!="undefined"||typeof this.obj.api!="undefined")this.on("click",this._toggle.bind(this))},_toggle:function(n){n.preventDefault();this.obj.message?this.app.broadcast(this.obj.message,this.obj.args):this.obj.api&&this.app.api(this.obj.api,this.obj.args)}});n.add("module","toolbar",{init:function(n){this.app=n;this.opts=n.opts;this.utils=n.utils;this.toolbar=n.toolbar;this.buttons=[];this.toolbarModule=!1},onsource:{open:function(){!this.toolbar.isAir()&&this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},opened:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.createSourceHelper()},close:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.destroySourceHelper()},closed:function(){this.toolbar.is()&&this.opts.air&&this.toolbarModule.openSelected()}},onobserve:function(){this.toolbar.is()&&this.toolbar.observe()},onfocus:function(){this._setExternalOnFocus()},onsourcefocus:function(){this._setExternalOnFocus()},onempty:function(){this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},onenablereadonly:function(){this.toolbar.isAir()&&this.toolbarModule.close()},start:function(){this.toolbar.is()&&(this._buildButtons(),this._initToolbar(),this._initButtons())},stop:function(){this.toolbarModule&&this.toolbarModule.stop()},_buildButtons:function(){this.buttons=this.opts.buttons.concat();this._buildImageButton();this._buildFileButton();this._buildSourceButton();this._buildAdditionalButtons();this._buildHiddenButtons()},_buildImageButton:function(){this.opts.imageUpload||this.utils.removeFromArrayByValue(this.buttons,"image")},_buildFileButton:function(){this.opts.fileUpload||this.utils.removeFromArrayByValue(this.buttons,"file")},_buildSourceButton:function(){this.opts.source||this.utils.removeFromArrayByValue(this.buttons,"html")},_buildAdditionalButtons:function(){var i,t,n;if(this.opts.buttonsAdd.length!==0&&(this.opts.buttonsAdd=this._removeExistButtons(this.opts.buttonsAdd),this.buttons=this.buttons.concat(this.opts.buttonsAdd)),this.opts.buttonsAddFirst.length!==0&&(this.opts.buttonsAddFirst=this._removeExistButtons(this.opts.buttonsAddFirst),this.buttons.unshift(this.opts.buttonsAddFirst)),this.opts.buttonsAddAfter!==!1)for(i=this.buttons.indexOf(this.opts.buttonsAddAfter.after)+1,t=this.opts.buttonsAddAfter.buttons,n=0;n<t.length;n++)this.buttons.splice(i+n,0,t[n]);if(this.opts.buttonsAddBefore!==!1)for(i=this.buttons.indexOf(this.opts.buttonsAddBefore.before)+1,t=this.opts.buttonsAddBefore.buttons,n=0;n<t.length;n++)this.buttons.splice(i-(1-n),0,t[n])},_buildHiddenButtons:function(){var t,n;if(this.opts.buttonsHide.length!==0)for(t=this.opts.buttonsHide,n=0;n<t.length;n++)this.utils.removeFromArrayByValue(this.buttons,t[n])},_removeExistButtons:function(n){for(var t=0;t<n.length;t++)this.opts.buttons.indexOf(n[t])!==-1&&this.utils.removeFromArrayByValue(n,n[t]);return n},_setExternalOnFocus:function(){!this.opts.air&&this.opts.toolbarExternal&&this.toolbarModule.setExternal()},_initToolbar:function(){this.toolbarModule=this.opts.air?n.create("toolbar.air",this.app):n.create("toolbar.standard",this.app)},_initButtons:function(){for(var i,t=0;t<this.buttons.length;t++)i=this.buttons[t],n.buttons[i]&&this.toolbar.addButton(i,n.buttons[i],!1,!1,!0)}});n.add("class","toolbar.air",{init:function(n){this.app=n;this.$doc=n.$doc;this.$win=n.$win;this.utils=n.utils;this.editor=n.editor;this.animate=n.animate;this.toolbar=n.toolbar;this.container=n.container;this.inspector=n.inspector;this.selection=n.selection;this.clicks=0;this._init()},stop:function(){var t=this.toolbar.getWrapper(),n;t.remove();n=this.editor.getElement();n.off(".redactor-air-trigger");this.$doc.off(".redactor-air");this.$doc.off(".redactor-air-trigger");this.toolbar.stopObservers()},createSourceHelper:function(){this.$airHelper=n.dom("<span>");this.$airHelper.addClass("redactor-air-helper");this.$airHelper.html('<i class="re-icon-html"><\/i>');this.$airHelper.on("click",function(n){n.preventDefault();this.app.api("module.source.hide")}.bind(this));var t=this.container.getElement();t.append(this.$airHelper)},destroySourceHelper:function(){this.$airHelper&&this.$airHelper.remove()},openSelected:function(){setTimeout(function(){this._isSelection()&&this._open(!1)}.bind(this),0)},close:function(){this.$doc.off(".redactor-air");var n=this.toolbar.getElement();n.removeClass("open");n.hide()},_init:function(){this.toolbar.create();var n=this.toolbar.getWrapper(),t=this.toolbar.getElement(),i=this.editor.getElement(),r=this.container.getElement();n.addClass("redactor-toolbar-wrapper-air");t.addClass("redactor-air");t.hide();n.append(t);r.prepend(n);this.openSelected();this.$doc.on("mouseup.redactor-air-trigger",this._open.bind(this));i.on("keyup.redactor-air-trigger",this._openCmd.bind(this))},_isSelection:function(){return this.selection.is()&&!this.selection.isCollapsed()},_isOpened:function(){var n=this.toolbar.getElement();return n.hasClass("open")},_open:function(t){var f=t?t.target:!1,i=t?n.dom(t.target):!1,r=this.inspector.parse(f),e=r.isComponent()&&!r.isComponentType("table"),o=r.isFigcaption(),s=i&&i.closest(".redactor-modal").length!==0,h=t&&i.closest(".re-button").length!==0,c=t&&i.closest(".redactor-dropdown").length!==0,u;c||h||s||o||e||this.toolbar.isContextBar()||!this._isSelection()||(u=this.selection.getPosition(),setTimeout(function(){this.app.isReadOnly()||this._isSelection()&&this._doOpen(u)}.bind(this),1))},_openCmd:function(){if(this.selection.isAll()){var t=this.toolbar.getElement(),n=this.selection.getPosition();n.top=n.top<20?0:n.top-t.height();n.height=0;this._doOpen(n)}},_doOpen:function(n){var r=this.toolbar.getWrapper(),t=this.toolbar.getElement(),u=this.container.getElement(),i=u.offset();r.css({left:n.left-i.left-0+"px",top:n.top-i.top+n.height+this.$doc.scrollTop()+"px"});this.app.broadcast("airOpen");t.addClass("open");t.show();this.$doc.on("click.redactor-air",this._close.bind(this));this.$doc.on("keydown.redactor-air",this._close.bind(this));this.app.broadcast("airOpened")},_close:function(t){var i=t?n.dom(t.target):!1,r=t&&i.closest("[data-dropdown], .redactor-dropdown-not-close").length!==0,u=!r&&t&&i.closest(".re-button").length!==0;(u||!r&&this._isOpened())&&(this.app.broadcast("airClose"),this.close(),this.app.broadcast("airClosed"))}});n.add("class","toolbar.fixed",{init:function(n){this.app=n;this.opts=n.opts;this.$doc=n.$doc;this.$win=n.$win;this.editor=n.editor;this.toolbar=n.toolbar;this.detector=n.detector;this.container=n.container;this._init()},stop:function(){this.$fixedTarget.off(".redactor-toolbar");this.$win.off(".redactor-toolbar")},reset:function(){var t=this.toolbar.getElement(),i=this.toolbar.getWrapper(),n;i.css("height","");t.removeClass("redactor-toolbar-fixed");t.css({position:"",top:"",left:"",width:""});n=this.toolbar.getDropdown();n&&n.updatePosition()},_init:function(){if(this.$fixedTarget=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$win,this._doFixed(),this.toolbar.isTarget()){this.$win.on("scroll.redactor-toolbar",this._doFixed.bind(this));this.$win.on("resize.redactor-toolbar",this._doFixed.bind(this))}this.$fixedTarget.on("scroll.redactor-toolbar",this._doFixed.bind(this));this.$fixedTarget.on("resize.redactor-toolbar",this._doFixed.bind(this))},_doFixed:function(){var h=this.editor.getElement(),t=this.container.getElement(),n=this.toolbar.getElement(),c=this.toolbar.getWrapper(),l=t.parents().filter(function(n){return getComputedStyle(n,null).display==="none"?n:!1}),e,o,s,f;if(l.length===0&&(e=h.height()<100,o=this.editor.isEmpty(),!e&&!o&&!this.editor.isSourceMode())){var a=n.height(),v=t.offset(),i=v.top,y=i+t.height()-(60+this.opts.toolbarFixedTopOffset),r=this.$fixedTarget.scrollTop(),u=this.toolbar.isTarget()?this.$fixedTarget.offset().top-this.$win.scrollTop():0;r>i&&r<y?(s=this.detector.isDesktop()?"fixed":"absolute",u=this.detector.isDesktop()?u:r-i+this.opts.toolbarFixedTopOffset,this.detector.isMobile()&&(this.fixedScrollTimeout&&clearTimeout(this.fixedScrollTimeout),n.hide(),this.fixedScrollTimeout=setTimeout(function(){n.show()},250)),c.height(a),n.addClass("redactor-toolbar-fixed"),n.css({position:s,top:u+this.opts.toolbarFixedTopOffset+"px",width:t.width()+"px"}),f=this.toolbar.getDropdown(),f&&f.updatePosition(),this.app.broadcast("toolbar.fixed")):(this.reset(),this.app.broadcast("toolbar.unfixed"))}}});n.add("class","toolbar.standard",{init:function(n){this.app=n;this.opts=n.opts;this.uuid=n.uuid;this.toolbar=n.toolbar;this.container=n.container;this.isExternalMultiple=!1;this.toolbarFixed=!1;this._init()},stop:function(){var n=this.toolbar.getWrapper();n.remove();this.toolbarFixed&&this.toolbarFixed.stop();this.opts.toolbarExternal&&this._findToolbars();this.toolbar.stopObservers()},setExternal:function(){if(this._findToolbars(),this.isExternalMultiple){this.$toolbars.hide();var n=this.$external.find(".redactor-toolbar-external-"+this.uuid);n.show()}},resetPosition:function(){this.toolbarFixed&&this.toolbarFixed.reset()},_init:function(){if(this._build(),this.opts.toolbarExternal)this._buildExternal();else{this._buildFixed();var n=this.toolbar.getElement();n.show()}},_build:function(){var n,t,i;this.toolbar.create();n=this.toolbar.getWrapper();t=this.toolbar.getElement();n.addClass("redactor-toolbar-wrapper");t.addClass("redactor-toolbar");t.hide();n.append(t);this.opts.toolbarExternal||(i=this.container.getElement(),i.prepend(n))},_buildExternal:function(){if(this._initExternal(),this._findToolbars(),this.isExternalMultiple)this._hideToolbarsExceptFirst();else{var n=this.toolbar.getElement();n.show()}},_buildFixed:function(){this.opts.toolbarFixed&&(this.toolbarFixed=n.create("toolbar.fixed",this.app))},_initExternal:function(){var t=this.toolbar.getElement(),i=this.toolbar.getElement();t.addClass("redactor-toolbar-external redactor-toolbar-external-"+this.uuid);this.$external=n.dom(this.opts.toolbarExternal);this.$external.append(i)},_findToolbars:function(){this.$toolbars=this.$external.find(".redactor-toolbar-external");this.isExternalMultiple=this.$toolbars.length>1},_hideToolbarsExceptFirst:function(){this.$toolbars.hide();var n=this.$toolbars.first();n.show()}});n.add("module","line",{init:function(n){this.app=n;this.lang=n.lang;this.component=n.component;this.inspector=n.inspector;this.insertion=n.insertion},oncontextbar:function(n,t){var r=this.inspector.parse(n.target),i,u;r.isComponentType("line")&&(i=r.getComponent(),u={remove:{title:this.lang.get("delete"),api:"module.line.remove",args:i}},t.set(n,i,u,"bottom"))},insert:function(){var n=this.component.create("line");this.insertion.insertRaw(n)},remove:function(n){this.component.remove(n)}});n.add("class","line.component",{mixins:["dom","component"],init:function(n,t){return this.app=n,t&&t.cmnt!==undefined?t:this._init(t)},_init:function(t){var f,r,u,i;typeof t!="undefined"&&(u=n.dom(t),i=u.get(),i.tagName==="HR"?r=i:i.tagName==="FIGURE"&&(f=i,r=u.find("hr").get()));this._buildWrapper(f);this._buildElement(r);this._initWrapper()},_buildElement:function(t){t?this.$element=n.dom(t):(this.$element=n.dom("<hr>"),this.append(this.$element))},_buildWrapper:function(n){n=n||"<figure>";this.parse(n)},_initWrapper:function(){this.addClass("redactor-component");this.attr({"data-redactor-type":"line",tabindex:"-1",contenteditable:!1})}});n.add("module","link",{modals:{link:'<form action="">                 <div class="form-item">                     <label for="modal-link-url">URL <span class="req">*<\/span><\/label>                     <input type="text" id="modal-link-url" name="url">                 <\/div>                 <div class="form-item">                     <label for="modal-link-text">## text ##<\/label>                     <input type="text" id="modal-link-text" name="text">                 <\/div>                 <div class="form-item form-item-title">                     <label for="modal-link-title">## title ##<\/label>                     <input type="text" id="modal-link-title" name="title">                 <\/div>                 <div class="form-item form-item-target">                     <label class="checkbox">                         <input type="checkbox" name="target"> ## link-in-new-tab ##                     <\/label>                 <\/div>             <\/form>'},init:function(n){this.app=n;this.opts=n.opts;this.lang=n.lang;this.utils=n.utils;this.inline=n.inline;this.editor=n.editor;this.inspector=n.inspector;this.insertion=n.insertion;this.selection=n.selection;this.isCurrentLink=!1;this.currentText=!1},onmodal:{link:{open:function(n,t){this._setFormData(t,n)},opened:function(n,t){this._setFormFocus(t)},update:function(n,t){var i=t.getData();this._validateData(t,i)&&this._update(i)},insert:function(n,t){var i=t.getData();this._validateData(t,i)&&this._insert(i)},unlink:function(){this._unlink()}}},onbutton:{link:{observe:function(n){this._observeButton(n)}}},ondropdown:{link:{observe:function(n){this._observeUnlink(n);this._observeEdit(n)}}},oncontextbar:function(t,i){var s=this._getCurrent(),u=this.inspector.parse(s),o;if(u.isLink()){var f=u.getLink(),h=n.dom(f),r=n.dom("<a>"),e=h.attr("href");r.text(this._truncateText(e));r.attr("href",e);r.attr("target","_blank");o={link:{title:r},edit:{title:this.lang.get("edit"),api:"module.link.open"},unlink:{title:this.lang.get("unlink"),api:"module.link.unlink"}};i.set(t,f,o,"bottom")}},open:function(){this.$link=this._buildCurrent();this.app.api("module.modal.build",this._getModalData())},insert:function(n){this._insert(n)},update:function(n){this._update(n)},unlink:function(){this._unlink()},_observeButton:function(n){var i=this.selection.getCurrent(),t=this.inspector.parse(i);t.isPre()||t.isCode()?n.disable():n.enable()},_observeUnlink:function(n){var t=n.getItem("unlink"),i=this._getLinks();i.length===0?t.disable():t.enable()},_observeEdit:function(n){var t=this._getCurrent(),i=n.getItem("link"),r=this.inspector.parse(t),u=r.isLink()?this.lang.get("link-edit"):this.lang.get("link-insert");i.setTitle(u)},_unlink:function(){var i,r,u,t,f;for(this.app.api("module.modal.close"),i=[],r=this._getLinks(),this.selection.save(),t=0;t<r.length;t++)u=n.create("link.component",this.app,r[t]),i.push(this.selection.getElement(r[t])),u.unwrap(),this.app.broadcast("link.deleted",u);for(this.selection.restore(),t=0;t<i.length;t++)f=i[t]?i[t]:this.editor.getElement(),this.utils.normalizeTextNodes(f);this._resetCurrent()},_update:function(n){this.app.api("module.modal.close");var t=this._getLinks();this._setLinkData(t,n,"updated");this._resetCurrent()},_insert:function(n){this.app.api("module.modal.close");var t=this._getLinks();this._insertSingle(t,n)||(this._removeInSelection(t),this._insertMultiple(n));this._resetCurrent()},_removeInSelection:function(t){var i,r,u;for(this.selection.save(),i=0;i<t.length;i++)r=n.create("link.component",this.app,t[i]),u=r.clone(),r.unwrap(),this.app.broadcast("link.deleted",u);this.selection.restore()},_insertMultiple:function(n){var t=this.selection.getRange(),i;t&&this._isCurrentTextChanged(n)&&this._deleteContents(t);i=this.inline.format({tag:"a"});this._setLinkData(i,n,"inserted")},_insertSingle:function(t,i){var u=this.selection.getInline(),r;return t.length===1&&t[0].textContext===this.selection.getText()||u&&u.tagName==="A"?(r=n.create("link.component",this.app,t[0]),r.setData(i),this.selection.setAll(r),this.app.broadcast("link.inserted",r),!0):!1},_setLinkData:function(t,i,r){var o,f,e,u;for(i.text=i.text.trim()===""?this._truncateText(i.url):i.text,o=!this.currentText||this.currentText!==i.text,this.selection.save(),f=0;f<t.length;f++)e=n.create("link.component",this.app,t[f]),u={},i.text&&o&&(u.text=i.text),i.url&&(u.url=i.url),i.title!==undefined&&(u.title=i.title),i.target!==undefined&&(u.target=i.target),e.setData(u),this.app.broadcast("link."+r,e);setTimeout(this.selection.restore.bind(this.selection),0)},_deleteContents:function(n){var u=this.selection.getHtml(),f=this.utils.parseHtml(u),t=f.nodes[0],i,r;t&&t.nodeType!==3?(i=t.tagName.toLowerCase(),r=document.createElement(i),this.insertion.insertNode(r,"start")):n.deleteContents()},_getModalData:function(){var n;return n=this._isLink()?{update:{title:this.lang.get("save")},unlink:{title:this.lang.get("unlink"),type:"danger"},cancel:{title:this.lang.get("cancel")}}:{insert:{title:this.lang.get("insert")},cancel:{title:this.lang.get("cancel")}},{name:"link",title:this._isLink()?this.lang.get("link-edit"):this.lang.get("link-insert"),handle:this._isLink()?"update":"insert",commands:n}},_isLink:function(){return this.currentLink},_isCurrentTextChanged:function(n){return this.currentText&&this.currentText!==n.text},_buildCurrent:function(){var u=this._getCurrent(),i=this.inspector.parse(u),t,r;return i.isLink()?(this.currentLink=!0,t=i.getLink(),t=n.create("link.component",this.app,t)):(this.currentLink=!1,t=n.create("link.component",this.app),r={text:this.selection.getText()},t.setData(r)),t},_getCurrent:function(){return this.selection.getInlinesAllSelected({tags:["a"]})[0]},_getLinks:function(){for(var r,t=this.selection.getInlines({all:!0,tags:["a"]}),i=[],n=0;n<t.length;n++)r=this.inspector.parse(t[n]),r.isLink()&&i.push(t[n]);return i},_resetCurrent:function(){this.isCurrentLink=!1;this.currentText=!1},_truncateText:function(n){return n.length>this.opts.linkSize?n.substring(0,this.opts.linkSize)+"...":n},_validateData:function(n,t){return t.url.trim()===""?n.setError("url"):!0},_setFormFocus:function(n){n.getField("url").focus()},_setFormData:function(n,t){var i=this.$link.getData(),r={url:i.url,text:i.text,title:i.title,target:this.opts.linkTarget||i.target};this.opts.linkNewTab||t.find(".form-item-target").hide();this.opts.linkTitle||t.find(".form-item-title").hide();n.setData(r);this.currentText=n.getField("text").val()}});n.add("class","link.component",{mixins:["dom","component"],init:function(n,t){return this.app=n,this.opts=n.opts,this.reUrl=/^(?:(?:(?:https?|ftp):)?\/\/)?(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[/?#]\S*)?$/i,t&&t.cmnt!==undefined?t:this._init(t)},setData:function(n){for(var t in n)this._set(t,n[t])},getData:function(){for(var t=["url","text","target","title"],i={},n=0;n<t.length;n++)i[t[n]]=this._get(t[n]);return i},_init:function(t){var i=n.dom(t);t===undefined?this.parse("<a>"):this.parse(i)},_set:function(n,t){this["_set_"+n](t)},_get:function(n){return this["_get_"+n]()},_get_target:function(){return this.attr("target")?this.attr("target"):!1},_get_url:function(){return this.attr("href")},_get_title:function(){return this.attr("title")},_get_text:function(){return this._getContext().text()},_getContext:function(){return this._findDeepestChild(this).element},_set_target:function(n){n===!1?this.removeAttr("target"):n&&this.attr("target",n===!0?"_blank":n)},_set_text:function(n){this._getContext().html(n)},_set_title:function(n){n&&n!==""?this.attr("title",n):this.removeAttr("title")},_set_url:function(n){this.opts.linkValidation&&(n=this._cleanUrl(n),this._isMailto(n)?n="mailto:"+n.replace("mailto:",""):this._isUrl(n)&&n.search(/^(ftp|https?)/i)===-1&&(n="http://"+n.replace(/(ftp|https?):\/\//i,"")));this.attr("href",n)},_isMailto:function(n){return n.search("@")!==-1&&/(ftp|https?):\/\//i.test(n)===!1},_isUrl:function(n){return this.reUrl.test(n)},_cleanUrl:function(n){return n.trim().replace(/[^\W\w\D\d+&\'@#/%?=~_|!:,.;\(\)]/gi,"")},_findDeepestChild:function(t){var i={depth:0,element:t};return t.children().each(function(r){var f=n.dom(r),u;r.outerHTML===t.html()&&(u=this._findDeepestChild(f),u.depth+1>i.depth&&(i={depth:1+u.depth,element:u.element}))}.bind(this)),i}});n.add("module","modal",{init:function(n){this.app=n;this.lang=n.lang;this.$doc=n.$doc;this.$win=n.$win;this.$body=n.$body;this.animate=n.animate;this.detector=n.detector;this.selection=n.selection;this.$box=!1;this.$modal=!1;this.defaults={name:!1,url:!1,title:!1,width:"600px",height:!1,handle:!1,commands:!1}},build:function(n){this._open(n)},close:function(){this._close()},stop:function(){this.$box&&(this.$box.remove(),this.$box=!1,this.$modal=!1,this.$doc.off(".redactor.modal"),this.$win.off(".redactor.modal"));this.$overlay&&this.$overlay.remove()},resize:function(){this.$modal.setWidth(this.p.width);this.$modal.updatePosition()},_isOpened:function(){return this.$modal&&this.$modal.hasClass("open")},_open:function(n){this._buildDefaults(n);this.p.url?this._openUrl():this._openTemplate()},_openUrl:function(){n.ajax.post({url:this.p.url,success:this._doOpen.bind(this)})},_openTemplate:function(){if(typeof n.modals[this.p.name]!="undefined"){var t=this.lang.parse(n.modals[this.p.name]);this._doOpen(t)}},_doOpen:function(n){this.stop();this.selection.save();this.detector.isDesktop()||document.activeElement.blur();this._createModal(n);this._buildModalBox();this._buildOverlay();this._buildModal();this._buildModalForm();this._buildModalCommands();this._broadcast("open");this.$modal.updatePosition();this._buildModalTabs();this.animate.start(this.$box,"fadeIn",this._opened.bind(this));this.animate.start(this.$overlay,"fadeIn")},_opened:function(){this.$modal.addClass("open");this.$box.on("mousedown.redactor.modal",this._close.bind(this));this.$doc.on("keyup.redactor.modal",this._handleEscape.bind(this));this.$win.on("resize.redactor.modal",this.resize.bind(this));this.$modal.getBody().find("input[type=text],input[type=url],input[type=email]").on("keydown.redactor.modal",this._handleEnter.bind(this));window.jQuery&&jQuery(document).off("focusin.modal");this._broadcast("opened")},_close:function(n){if(this.$box&&this._isOpened()){if(n){if(!this._needToClose(n.target))return;n.stopPropagation();n.preventDefault()}this.selection.restore();this._broadcast("close");this.animate.start(this.$box,"fadeOut",this._closed.bind(this));this.animate.start(this.$overlay,"fadeOut")}},_closed:function(){this.$modal.removeClass("open");this.$box.off(".redactor.modal");this.$doc.off(".redactor.modal");this.$win.off(".redactor.modal");this._broadcast("closed")},_createModal:function(t){this.$modal=n.create("modal.element",this.app,t)},_broadcast:function(n){this.app.broadcast("modal."+n,this.$modal,this.$modalForm);this.app.broadcast("modal."+this.p.name+"."+n,this.$modal,this.$modalForm)},_buildDefaults:function(t){this.p=n.extend({},this.defaults,t)},_buildModalBox:function(){this.$box=n.dom("<div>");this.$box.attr("id","redactor-modal");this.$box.addClass("redactor-animate-hide");this.$box.html("");this.$body.append(this.$box)},_buildOverlay:function(){this.$overlay=n.dom("#redactor-overlay");this.$overlay.length===0&&(this.$overlay=n.dom("<div>"),this.$overlay.attr("id","redactor-overlay"),this.$overlay.addClass("redactor-animate-hide"),this.$body.prepend(this.$overlay))},_buildModal:function(){this.$box.append(this.$modal);this.$modal.setTitle(this.p.title);this.$modal.setHeight(this.p.height);this.$modal.setWidth(this.p.width)},_buildModalCommands:function(){var r,u,i,t;if(this.p.commands){r=this.p.commands;u=this.$modal.getFooter();for(i in r){t=n.dom("<button>");t.html(r[i].title);t.attr("data-command",i);i==="cancel"&&(t.attr("data-action","close"),t.addClass("redactor-button-unstyled"));typeof r[i].type!="undefined"&&r[i].type==="danger"&&t.addClass("redactor-button-danger");t.on("click",this._handleCommand.bind(this));u.append(t)}}},_buildModalTabs:function(){var i=this.$modal.getBody(),r=i.find(".redactor-modal-tab"),t=i.find(".redactor-modal-tabs");r.length>1&&(t=t.length===0?n.dom("<div>"):t.html(""),t.addClass("redactor-modal-tabs"),r.each(function(i,r){var f=n.dom(i),u=n.dom("<a>");u.attr("href","#");u.attr("rel",r);u.text(f.attr("data-title"));u.on("click",this._showTab.bind(this));r===0&&u.addClass("active");t.append(u)}.bind(this)),i.prepend(t))},_buildModalForm:function(){this.$modalForm=n.create("modal.form",this.app,this.$modal.getForm())},_showTab:function(t){t.preventDefault();var i=n.dom(t.target),f=i.attr("rel"),r=this.$modal.getBody(),u=r.find(".redactor-modal-tab");u.hide();u.eq(f).show();r.find(".redactor-modal-tabs a").removeClass("active");i.addClass("active")},_needToClose:function(t){var i=n.dom(t);return i.attr("data-action")==="close"||this.$modal.isCloseNode(t)||i.closest(".redactor-modal").length===0?!0:!1},_handleCommand:function(t){var r=n.dom(t.target).closest("button"),i=r.attr("data-command");i!=="cancel"&&t.preventDefault();this._broadcast(i)},_handleEnter:function(n){n.which===13&&this.p.handle&&(n.preventDefault(),this._broadcast(this.p.handle))},_handleEscape:function(n){n.which===27&&this._close()}});n.add("class","modal.element",{mixins:["dom"],init:function(n,t){this.app=n;this.opts=n.opts;this.$win=n.$win;this._init(t)},getForm:function(){return this.find("form")},getHeader:function(){return this.$modalHeader},getBody:function(){return this.$modalBody},getFooter:function(){return this.$modalFooter},setTitle:function(n){n&&this.$modalHeader.html(n)},setWidth:function(n){n=parseInt(n)>=this.$win.width()?"96%":n;this.css("max-width",n)},setHeight:function(n){n!==!1&&this.$modalBody.css("height",n)},updatePosition:function(){var r=this.width();this.css({left:"50%","margin-left":"-"+r/2+"px"});var n=this.$win.height(),t=this.height(),i=n/2-t/2;t<n&&i!==0&&this.css("margin-top",i+"px")},isCloseNode:function(n){return n===this.$modalClose.get()},_init:function(n){this._build();this._buildClose();this._buildHeader();this._buildBody();this._buildFooter();this._buildTemplate(n)},_build:function(){this.parse("<div>");this.addClass("redactor-modal");this.attr("dir",this.opts.direction)},_buildClose:function(){this.$modalClose=n.dom("<span>");this.$modalClose.addClass("redactor-close");this.append(this.$modalClose)},_buildHeader:function(){this.$modalHeader=n.dom("<div>");this.$modalHeader.addClass("redactor-modal-header");this.append(this.$modalHeader)},_buildBody:function(){this.$modalBody=n.dom("<div>");this.$modalBody.addClass("redactor-modal-body");this.append(this.$modalBody)},_buildFooter:function(){this.$modalFooter=n.dom("<div>");this.$modalFooter.addClass("redactor-modal-footer");this.append(this.$modalFooter)},_buildTemplate:function(n){this.$modalBody.html(n)}});n.add("class","modal.form",{mixins:["dom"],init:function(n,t){this.app=n;this.build(t)},build:function(n){this.parse(n)},getData:function(){var t={};return this.find("[name]").each(function(i){var r=n.dom(i);t[r.attr("name")]=r.val()}),t},setData:function(t){this.find("[name]").each(function(i){var u=n.dom(i),r=u.attr("name");t.hasOwnProperty(r)&&(i.type&&i.type==="checkbox"?i.checked=t[r]:u.val(t[r]))})},getField:function(n){return this.find("[name="+n+"]")},setError:function(n){var t=this.getField(n);t.addClass("error");t.one(this._getFieldEventName(t.get()),this._clearError);return!1},_clearError:function(){return n.dom(this).removeClass("error")},_getFieldEventName:function(n){return n.tagName==="SELECT"||n.type==="checkbox"||n.type==="radio"?"change":"keyup"}});n.add("module","block",{init:function(n){this.app=n;this.block=n.block},format:function(n){var t=this.block.format(n);this.app.broadcast("format","block",t)},clearformat:function(){this.block.clearFormat()},clearstyle:function(){this.block.clearStyle()},clearclass:function(){this.block.clearClass()},clearattr:function(){this.block.clearAttr()},add:function(n,t){this.block.add(n,t)},toggle:function(n,t){this.block.toggle(n,t)},set:function(n,t){this.block.set(n,t)},remove:function(n,t){this.block.remove(n,t)}});n.add("module","inline",{init:function(n){this.app=n;this.inline=n.inline},format:function(n){var t=this.inline.format(n);this.app.broadcast("format","inline",t)},clearformat:function(){this.inline.clearFormat()},clearstyle:function(){this.inline.clearStyle()},clearclass:function(){this.inline.clearClass()},clearattr:function(){this.inline.clearAttr()},add:function(n,t){this.inline.add(n,t)},toggle:function(n,t){this.inline.toggle(n,t)},set:function(n,t){this.inline.set(n,t)},remove:function(n,t){this.inline.remove(n,t)}});n.add("module","autosave",{init:function(n){this.app=n;this.opts=n.opts;this.utils=n.utils;this.source=n.source},onsynced:function(){this.opts.autosave&&this._send()},_send:function(){var i=this.opts.autosaveName?this.opts.autosaveName:this.source.getName(),t={};t[i]=this.source.getCode();t=this.utils.extendData(t,this.opts.autosaveData);n.ajax.post({url:this.opts.autosave,data:t,success:function(n){this._complete(n,i,t)}.bind(this)})},_complete:function(n,t,i){var r=n&&n.error?"autosaveError":"autosave";this.app.broadcast(r,t,i,n)}});n.add("module","input",{init:function(n){this.app=n;this.opts=n.opts;this.utils=n.utils;this.editor=n.editor;this.keycodes=n.keycodes;this.element=n.element;this.selection=n.selection;this.insertion=n.insertion;this.inspector=n.inspector;this.autoparser=n.autoparser;this.lastShiftKey=!1},onpaste:function(t,i){if(this.opts.input)return n.create("input.paste",this.app,t,i)},onkeydown:function(t){var i,r,u,f;if(this.opts.input&&(i=t.which,r=n.create("input.shortcut",this.app,t),!r.is())){if((t.ctrlKey||t.metaKey)&&!t.altKey&&i===65)return t.preventDefault(),this._selectAll();if(u=[this.keycodes.ENTER,this.keycodes.SPACE,this.keycodes.BACKSPACE,this.keycodes.DELETE],this.selection.isAll()&&u.indexOf(i)!==-1){t.preventDefault();this.element.isType("inline")?(f=this.editor.getElement(),f.html(""),this.editor.startFocus()):this.insertion.set(this.opts.emptyHtml);return}if(this.opts.autoparse&&this.autoparser.format(t,i),!t.ctrlKey&&!t.metaKey&&(i>=48&&i<=57||i>=65&&i<=90)&&this.selection.hasNonEditable()){t.preventDefault();return}if(i===this.keycodes.ENTER)return n.create("input.enter",this.app,t,i);if(t.metaKey&&i===219){t.preventDefault();this.app.api("module.list.outdent");return}return i===this.keycodes.TAB||t.metaKey&&i===221?n.create("input.tab",this.app,t,i):i===this.keycodes.SPACE?n.create("input.space",this.app,t,i,this.lastShiftKey):this._isDeleteKey(i)?n.create("input.delete",this.app,t,i):this._isArrowKey(i)?n.create("input.arrow",this.app,t,i):void 0}},onkeyup:function(t){var r,u,f,i;if(this.opts.input&&(r=t.which,this.lastShiftKey=t.shiftKey,this.app.broadcast("contextbar.close"),u=n.create("input.shortcode",this.app,t,r),!u.is())){if(r===this.keycodes.BACKSPACE&&(f=this.editor.getElement(),i=this.utils.trimSpaces(f.html()),i=i.replace(/<br\s?\/?>/g,""),i=i.replace(/<div><\/div>/,""),i==="")){t.preventDefault();this.editor.setEmpty();this.editor.startFocus();return}this.editor.isEmpty()&&this.app.broadcast("empty")}},start:function(){this.opts.shortcutsAdd&&(this.opts.shortcuts=n.extend({},!0,this.opts.shortcuts,this.opts.shortcutsAdd))},_selectAll:function(){var i=this.selection.getCurrent(),n=this.inspector.parse(i),t;if(n.isComponentType("table")){t=n.getTable();this.selection.setAll(t);return}if(n.isComponentType("code")){t=n.getComponentCodeElement();this.selection.setAll(t);return}this.selection.setAll()},_isArrowKey:function(n){return[this.keycodes.UP,this.keycodes.DOWN,this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(n)!==-1},_isDeleteKey:function(n){return n===this.keycodes.BACKSPACE||n===this.keycodes.DELETE}});n.add("class","input.arrow",{init:function(n,t,i){this.app=n;this.opts=n.opts;this.utils=n.utils;this.caret=n.caret;this.marker=n.marker;this.editor=n.editor;this.keycodes=n.keycodes;this.component=n.component;this.inspector=n.inspector;this.selection=n.selection;this.key=i;this._init(t)},_init:function(n){if(!this._isRightLeftKey()||!this._isExitVariable(n)){if(this._isRightDownKey()){if(this._isExitOnDownRight(n))return;if(this._selectComponent(n,"End","next"))return}if(this._isLeftUpKey()){if(this._isExitOnUpLeft(n))return;if(this._selectComponent(n,"Start","prev"))return}this._isRightLeftKey()&&this._removeInvisibleSpace()}},_isRightDownKey:function(){return[this.keycodes.DOWN,this.keycodes.RIGHT].indexOf(this.key)!==-1},_isLeftUpKey:function(){return[this.keycodes.UP,this.keycodes.LEFT].indexOf(this.key)!==-1},_isRightLeftKey:function(){return[this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(this.key)!==-1},_isExitVariable:function(n){var r=this.selection.getCurrent(),t=this.inspector.parse(r),u=t.getComponent(),i;if(t.isComponentType("variable")&&t.isComponentActive()){n.preventDefault();i=this.key===this.keycodes.LEFT?"setBefore":"setAfter";this.caret[i](u);return}},_isExitOnUpLeft:function(t){var s=this.selection.getCurrent(),r=this.selection.getBlock(s),i=this.inspector.parse(s),f=r.previousElementSibling,u=this.caret.isStart(r),e,o;if(u&&f&&f.tagName==="TABLE")return t.preventDefault(),this.caret.setEnd(f),!0;if(i.isFigcaption()){if(r=i.getFigcaption(),u=this.caret.isStart(r),e=n.dom(r).closest(".redactor-component"),u&&e.length!==0)return t.preventDefault(),this.caret.setEnd(e),!0}else{if(i.isTable()&&u)return t.preventDefault(),this.caret.setEnd(r.previousElementSibling),!0;if(!i.isComponentEditable()&&i.isComponent()&&!i.isComponentType("variable")&&(o=i.getComponent(),o.previousElementSibling))return t.preventDefault(),this.component.clearActive(),this.caret.setEnd(o.previousElementSibling),!0}},_isExitOnDownRight:function(t){var l=this.editor.getElement(),s=this.selection.getCurrent(),i=this.inspector.parse(s),u=this.caret.isEnd(),f,r,h,e,c,o;if(i.isTable()){if(r||u)return this._exitNextElement(t,i.getComponent())}else if(i.isFigcaption()){if(f=i.getFigcaption(),r=this.caret.isEnd(f),r||u)return this._exitNextElement(t,i.getComponent())}else if(i.isComponentType("code")){if(h=i.getComponent(),e=n.dom(i.getComponentCodeElement()).closest("pre"),r=this.caret.isEnd(f),c=e&&e.get().nextElementSibling,r&&!c)return this._exitNextElement(t,h)}else if(i.isPre()||i.isBlockquote()||i.isDl()){if(u){if(i.isPre())return this._exitNextElement(t,i.getPre());if(i.isBlockquote())return this._exitNextElement(t,i.getBlockquote());if(i.isDl())return this._exitNextElement(t,i.getDl())}}else if(i.isList()){if(o=n.dom(s).parents("ul, ol",l).last(),r=this.caret.isEnd(o),r||u)return this._exitNextElement(t,o.get())}else if(i.isComponent()&&!i.isComponentType("variable"))return this.component.clearActive(),this._exitNextElement(t,i.getComponent())},_exitNextElement:function(n,t){return n.preventDefault(),t.nextElementSibling?this.caret.setStart(t.nextElementSibling):this.utils.createMarkup(t),!0},_removeInvisibleSpace:function(){var n=this.selection.getCurrent(),t=n?this.utils.isEmptyHtml(n.nodeType===3?n.textContent:n.innerHTML):!1;t&&n&&n.nodeType===3&&this.utils.searchInvisibleChars(n.textContent)===0&&n.parentNode.removeChild(n)},_selectComponent:function(n,t,i){var r=this.selection.getCurrent(),u=this.selection.getBlock(r),f=this.utils.findSiblings(r,i),e=this.utils.findSiblings(u,i);f&&this.caret["is"+t](r)?this._selectComponentItem(n,f,t):e&&this.caret["is"+t](u)&&this._selectComponentItem(n,e,t)},_selectComponentItem:function(n,t,i){if(this.component.isNonEditable(t))return n.preventDefault(),this.caret["set"+i](t),!0}});n.add("class","input.delete",{init:function(n,t,i){this.app=n;this.opts=n.opts;this.caret=n.caret;this.utils=n.utils;this.editor=n.editor;this.marker=n.marker;this.keycodes=n.keycodes;this.component=n.component;this.inspector=n.inspector;this.selection=n.selection;this.key=i;this._init(t)},_init:function(n){if(!this._removeActiveComponent(n)&&!this._removeAllSelectedTable(n)){if(this.key===this.keycodes.BACKSPACE){var t=this.editor.getElement(),i=this.utils.trimSpaces(t.html());if(i===this.opts.emptyHtml){n.preventDefault();return}}if(this._detectVariableOrNonEditable()||this.selection.hasNonEditable()){n.preventDefault();return}this.selection.isCollapsed()&&(this.key===this.keycodes.BACKSPACE?this._traverseBackspace(n):this.key===this.keycodes.DELETE&&this._traverseDelete(n));this._removeInvisibleSpace();this._removeUnwantedStyles();this._removeEmptySpans();this._removeSpanTagsInHeadings();this._removeInlineTagsInPre()}},_detectVariableOrNonEditable:function(){var t=this.selection.getBlock(),r=this.caret.isStart(t),u=this.caret.isEnd(t),n;if(this.key===this.keycodes.BACKSPACE&&r){if(n=t.previousSibling,this._isNonEditable(n))return!0}else if(this.key===this.keycodes.DELETE&&u&&(n=t.nextSibling,this._isNonEditable(n)))return!0;var i=this.selection.getCurrent(),f=this.caret.isStart(i),e=this.caret.isEnd(i),o=this.selection.getTextBeforeCaret().trim()==="",s=this.selection.getTextAfterCaret().trim()==="";if(this.key===this.keycodes.BACKSPACE&&f&&!o){if(n=i.previousSibling,this._isVariable(n))return this.caret.setEnd(n),!0;if(this._isNonEditable(n))return!0}else if(this.key===this.keycodes.DELETE&&e&&!s){if(n=i.nextSibling,this._isVariable(n))return this.caret.setStart(n),!0;if(this._isNonEditable(n))return!0}},_isVariable:function(t){return n.dom(t).closest('[data-redactor-type="variable"]').length!==0},_isNonEditable:function(t){return n.dom(t).closest(".non-editable").length!==0},_getBlock:function(){var r=this.editor.getElement(),t=this.selection.getBlock(),i=this.inspector.parse(t);return t=i.isList()?n.dom(t).parents("ul, ol",r).last().get():t,t=i.isDl()?i.getDl():t,i.isTable()?i.getTable():t},_traverseDelete:function(t){var v=this.selection.getCurrent(),e=this.inspector.parse(v),i,r,f,u,o,l,c,s,h,a;if(e.isFigcaption()){if(i=e.getFigcaption(),r=this.caret.isEnd(i),r){t.preventDefault();return}}else if(e.isComponentType("code")&&(i=e.getComponent(),r=this.caret.isEnd(i),r)){t.preventDefault();return}if(i=this._getBlock(),u=this.utils.findSiblings(i,"next"),u){if(r=this.caret.isEnd(i),o=this.inspector.parse(u),l=u.tagName==="P"||u.tagName==="DIV",r&&o.isComponentEditable()){t.preventDefault();this.component.remove(u,!1);return}if(r&&o.isComponent()){t.preventDefault();this.caret.setStart(u);this.utils.isEmptyHtml(i.innerHTML)&&n.dom(i).remove();return}if(r&&o.isList()){if(c=n.dom(i),f=n.dom(u),e.isList()){t.preventDefault();c.append(f);f.unwrap();return}if(s=f.children("li").first(),h=s.find("ul, ol"),h.length!==0){t.preventDefault();f.prepend(h);h.unwrap();c.append(s);s.unwrap();return}}else if(r&&!e.isTable()&&l&&!this.utils.isEmptyHtml(i.innerHTML)){t.preventDefault();a=n.dom(i);f=n.dom(u);a.append(f);f.unwrap();return}}},_traverseBackspace:function(t){var p=this.selection.getCurrent(),e=this.inspector.parse(p),i,r,o,f,u,s,a,y,h;if(e.isFigcaption()){if(i=e.getFigcaption(),r=this.caret.isStart(i),r){t.preventDefault();return}}else if(e.isComponentType("code")&&(i=e.getComponent(),r=this.caret.isStart(i),r&&i.previousElementSibling))return t.preventDefault(),this.caret.setEnd(i.previousElementSibling),!0;if(i=this._getBlock(),u=this.utils.findSiblings(i,"prev"),!u){setTimeout(this._replaceBlock.bind(this),1);return}if(r=this.caret.isStart(i),s=this.inspector.parse(u),a=u.tagName==="P"||u.tagName==="DIV",r&&s.isComponentEditable()){t.preventDefault();this.component.remove(u,!1);return}if(r&&s.isComponent()){t.preventDefault();this.caret.setStart(u);this.utils.isEmptyHtml(i.innerHTML)&&n.dom(i).remove();return}if(r&&e.isList()){if(t.preventDefault(),f=n.dom(i),o=n.dom(u),s.isList())f.children("li").first().prepend(this.marker.build("start")),o.append(f),f.unwrap(),this.selection.restoreMarkers();else{var v=f.children("li").first(),w=v.get(),c=v.find("ul, ol"),l=this.utils.replaceToTag(w,this.opts.markup);this.opts.breakline&&l.attr("data-redactor-tag","br");f.before(l);this.caret.setStart(l);c.length!==0&&(f.prepend(c),c.unwrap())}return}if(r&&a){t.preventDefault();y=this.utils.createInvisibleChar();h=n.dom(i);o=n.dom(u);this.caret.setEnd(o);h.prepend(y);o.append(h.contents());h.remove();return}},_replaceBlock:function(){var t=this.selection.getBlock(),r=n.dom(t),i;this.opts.markup==="p"&&t&&this._isNeedToReplaceBlock(t)&&(i=document.createElement(this.opts.markup),r.replaceWith(i),this.caret.setStart(i));this.opts.breakline&&t&&t.tagName==="DIV"&&r.attr("data-redactor-tag","br")},_isNeedToReplaceBlock:function(n){return n.tagName==="DIV"&&this.utils.isEmptyHtml(n.innerHTML)},_removeActiveComponent:function(n){var r=this.selection.getCurrent(),t=this.inspector.parse(r),i=t.getComponent();if(t.isComponent()&&this.component.isActive(i))return n.preventDefault(),this.component.remove(i),!0},_removeAllSelectedTable:function(n){var i=this.selection.getCurrent(),r=this.inspector.parse(i),t=r.getTable();if(t&&this.selection.isAll(t))return n.preventDefault(),this.component.remove(t),!0},_removeUnwantedStyles:function(){var n=this.editor.getElement();setTimeout(function(){var t=n.find("*[style]");t.not("img, figure, iframe, [data-redactor-style-cache], [data-redactor-span]").removeAttr("style")},0)},_removeEmptySpans:function(){var t=this.editor.getElement();setTimeout(function(){t.find("span").each(function(t){t.attributes.length===0&&n.dom(t).replaceWith(t.childNodes)})},0)},_removeInvisibleSpace:function(){var n=this.selection.getCurrent(),t=n?n.previousSibling:!1,i=n?this.utils.isEmptyHtml(n.nodeType===3?n.textContent:n.innerHTML):!1;i&&n&&n.nodeType===3&&this.utils.searchInvisibleChars(n.textContent)===0&&n.parentNode.removeChild(n);this.key===this.keycodes.DELETE&&t&&t.nodeType===3&&this.utils.searchInvisibleChars(t.textContent)===0&&t.parentNode.removeChild(t)},_removeSpanTagsInHeadings:function(){var t=this.editor.getElement();setTimeout(function(){t.find("h1, h2, h3, h4, h5, h6").each(function(t){var i=n.dom(t);i.closest("figure").length===0&&i.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker, [data-redactor-style-cache], [data-redactor-span]").unwrap()})},1)},_removeInlineTagsInPre:function(){var t=this.editor.getElement(),i=this.opts.inlineTags;setTimeout(function(){t.find("pre").each(function(t){var r=n.dom(t);r.closest("figure").length===0&&r.find(i.join(",")).not("code, .redactor-selection-marker").unwrap()})},1)}});n.add("class","input.enter",{init:function(n,t){this.app=n;this.opts=n.opts;this.utils=n.utils;this.caret=n.caret;this.editor=n.editor;this.insertion=n.insertion;this.selection=n.selection;this.inspector=n.inspector;this._init(t)},_init:function(n){if(!this.opts.enterKey)return this._disable(n);var t=this.app.broadcast("enter",n);if(t===!1)return n.preventDefault();if(this.selection.hasNonEditable()){n.preventDefault();return}if(n.ctrlKey||n.shiftKey)return this._insertBreak(n);this._isExit(n)||this._traverse(n)},_disable:function(n){n.preventDefault();var t=this.selection.getRange();t&&!t.collapsed&&t.deleteContents()},_insertBreak:function(n){n.preventDefault();var i=this.selection.getCurrent(),t=this.inspector.parse(i);t.isComponent()||t.isCode()||(t.isPre()?this.insertion.insertNewline():this.insertion.insertBreakLine())},_isExit:function(t){var l=this.editor.getElement(),r=this.selection.getBlock(),i=this.inspector.parse(r),u=this.caret.isEnd(r),h=this.selection.getCurrent(),f=h.previousSibling,c,o,e,s;if(i.isBlockquote()){if(c=u&&this._isExitableBlock(r,"P"),o=u&&this._isExitableDblBreak(f),c||o)return this._exitFromElement(t,o?f:r,i.getBlockquote())}else if(!i.isComponentType("code")&&i.isPre()){if(u&&(e=r.innerHTML,e=this.utils.removeInvisibleChars(e),e.match(/(\n\n\n)$/)!==null))return n.dom(f.previousSibling.previousSibling).remove(),this._exitFromElement(t,f,r)}else if(i.isDl()){if(u&&this._isExitableBlock(r,"DT"))return this._exitFromElement(t,r,i.getDl())}else if(i.isList()){if(s=n.dom(h).parents("ul, ol",l).last(),u=this.caret.isEnd(s),u&&this._isExitableBlock(r,"LI"))return this._exitFromElement(t,r,s)}else if(i.isComponent()&&i.isComponentActive()&&!i.isFigcaption()&&!i.isComponentEditable())return this._exitFromElement(t,!1,i.getComponent())},_isExitableDblBreak:function(n){var t=n?n.nextSibling:!1,i;if(t)return i=this.utils.removeInvisibleChars(t.textContent),t.nodeType===3&&i.trim()===""},_isExitableBlock:function(n,t){return n&&n.tagName===t&&this.utils.isEmptyHtml(n.innerHTML)},_exitFromElement:function(t,i,r){return t.preventDefault(),i&&n.dom(i).remove(),this.utils.createMarkup(r),!0},_exitNextElement:function(n,t){return n.preventDefault(),t.nextSibling?this.caret.setStart(t.nextSibling):this.utils.createMarkup(t),!0},_traverse:function(n){var r=this.selection.getCurrent(),e=this.selection.isText(),t=this.selection.getBlock(),i=this.inspector.parse(r),o=t?t.tagName.toLowerCase():!1,u,f;if(i.isPre())return n.preventDefault(),this.insertion.insertNewline();if(i.isBlockquote()){if(t=this.selection.getBlock(r),t&&t.tagName==="BLOCKQUOTE")return n.preventDefault(),this.insertion.insertBreakLine()}else{if(i.isFigcaption()){if(t=i.getFigcaption(),u=this.caret.isEnd(t),f=this.caret.isEnd(),u||f)return this._exitNextElement(n,i.getComponent());n.preventDefault();return}if(i.isDl())return n.preventDefault(),this._traverseDl(r);if(e||this.opts.breakline&&o==="div")return n.preventDefault(),this.insertion.insertBreakLine();setTimeout(this._replaceBlock.bind(this),1);return}},_traverseDl:function(t){var i=this.selection.getBlock(t),c=this.inspector.parse(i),o=c.getTag(),r=n.dom(i),u=r.get().nextSibling||!1,s=n.dom(u),l=u&&s.is("dd"),a=u&&s.is("dt"),h=this.caret.isEnd(i),f,e;if(o==="dt"&&!l&&h){f=document.createElement("dd");r.after(f);this.caret.setStart(f);return}if(o==="dd"&&!a&&h){e=document.createElement("dt");r.after(e);this.caret.setStart(e);return}return this.insertion.insertBreakLine()},_replaceBlock:function(){var t=this.selection.getBlock(),i=n.dom(t),u,r;this.opts.markup==="p"&&t&&this._isNeedToReplaceBlock(t)?(u=document.createElement(this.opts.markup),i.replaceWith(u),this.caret.setStart(u)):t&&(this.utils.isEmptyHtml(t.innerHTML)?this._clearBlock(i,t):(r=this.utils.getFirstNode(t),r&&r.tagName==="BR"&&(n.dom(r).remove(),this.caret.setStart(t))));t&&this._isNeedToCleanBlockStyle(t)&&this.opts.cleanOnEnter&&i.removeAttr("class style");this.opts.breakline&&t&&t.tagName==="DIV"&&i.attr("data-redactor-tag","br")},_clearBlock:function(n,t){(this.opts.cleanInlineOnEnter||t.innerHTML==="<br>")&&n.html("");this.caret.setStart(t)},_isNeedToReplaceBlock:function(n){return n.tagName==="DIV"&&this.utils.isEmptyHtml(n.innerHTML)},_isNeedToCleanBlockStyle:function(n){return n.tagName==="P"&&this.utils.isEmptyHtml(n.innerHTML)}});n.add("class","input.paste",{init:function(n,t,i,r,u){this.app=n;this.opts=n.opts;this.editor=n.editor;this.cleaner=n.cleaner;this.container=n.container;this.inspector=n.inspector;this.insertion=n.insertion;this.selection=n.selection;this.autoparser=n.autoparser;this.pasteHtml=r;this.pointInserted=u;this.dataTransfer=i;this._init(t)},_init:function(n){var t=this.dataTransfer||n.clipboardData,l=this.selection.getCurrent(),s=this.inspector.parse(l),h,f,i,r,c,e,u,o;if(this.dropPasted=this.dataTransfer,this.isRawCode=s.isPre()||s.isCode(),this.editor.enablePasting(),this.editor.saveScroll(),this.dropPasted||this.selection.saveMarkers(),this.isRawCode||!t){h=t.getData("text/plain");n.preventDefault();this._insert(n,h);return}if(this.pasteHtml)n.preventDefault(),this._insert(n,this.pasteHtml);else{if(f=t.getData("URL"),i=this._isPlainText(t)?t.getData("text/plain"):t.getData("text/html"),i=!f||f===""?i:f,r=t.items||t.files,c=t.items?!1:t.files,r&&i===""){for(e=[],u=0;u<r.length;u++)o=c?r[u]:r[u].getAsFile(),o&&e.push(o);if(e.length>0){n.preventDefault();this._insertFiles(n,e);return}}n.preventDefault();this._insert(n,i)}},_isPlainText:function(n){var i=n.getData("text/plain"),r=n.getData("text/html"),t;if(i&&r){if(t=document.createElement("div"),t.innerHTML=r,t.textContent===i)return!t.querySelector(":not(meta)")}else return i!==null},_restoreSelection:function(){this.editor.restoreScroll();this.editor.disablePasting();this.dropPasted||this.selection.restoreMarkers()},_insert:function(n,t){var i=this.app.broadcast("pasteBefore",t),r;t=i===undefined?t:i;t=this.isRawCode?t:this.cleaner.paste(t);t=this.isRawCode?this.cleaner.encodePhpCode(t):t;i=this.app.broadcast("pasting",t);t=i===undefined?t:i;this._restoreSelection();this.opts.autoparse&&this.opts.autoparsePaste&&(t=this.autoparser.parse(t));r=this.dropPasted?this.insertion.insertToPoint(n,t,this.pointInserted):this.insertion.insertHtml(t);this.app.broadcast("pasted",r);this.app.broadcast("autoparseobserve")},_insertFiles:function(n,t){this._restoreSelection();var r=this.opts.imageTypes.indexOf(t[0].type)!==-1,i=typeof this.dropPasted=="undefined";r?this.app.broadcast("dropimage",n,t,i):this.app.broadcast("dropfile",n,t,i)}});n.add("class","input.shortcode",{init:function(n,t,i){this.app=n;this.opts=n.opts;this.utils=n.utils;this.marker=n.marker;this.keycodes=n.keycodes;this.selection=n.selection;this.worked=!1;i===this.keycodes.SPACE&&this._init()},is:function(){return this.worked},_init:function(){var n=this.selection.getCurrent(),u,t,i,r,f;if(n&&n.nodeType===3){u=this.utils.removeInvisibleChars(n.textContent);t=this.opts.shortcodes;for(i in t)if(r=new RegExp("^"+this.utils.escapeRegExp(i)),f=u.match(r),f!==null&&typeof t[i].format!="undefined")return this._format(t[i].format,n,r)}},_format:function(n,t,i){var f=this.marker.insert("start"),r,u;t=f.previousSibling;r=t.textContent;r=this.utils.trimSpaces(r);r=r.replace(i,"");t.textContent=r;u=n==="ul"||n==="ol"?"module.list.toggle":"module.block.format";this.app.api(u,n);this.selection.restoreMarkers();this.worked=!0}});n.add("class","input.shortcut",{init:function(n,t){this.app=n;this.opts=n.opts;this.worked=!1;this.hotkeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};this.hotkeysShiftNums={"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"};this._init(t)},is:function(){return this.worked},_init:function(n){if(this.opts.shortcuts===!1){(n.ctrlKey||n.metaKey)&&(n.which===66||n.which===73)&&n.preventDefault();return}for(var t in this.opts.shortcuts)this._build(n,t,this.opts.shortcuts[t])},_build:function(n,t,i){for(var u=t.split(","),f=u.length,r=0;r<f;r++)typeof u[r]=="string"&&this._handler(n,u[r].trim(),i)},_handler:function(n,t,i){var o,c,r;t=t.toLowerCase().split(" ");var s=this.hotkeys[n.keyCode],e=String.fromCharCode(n.which).toLowerCase(),u="",f={},h=["alt","ctrl","meta","shift"];for(r=0;r<h.length;r++)o=h[r],n[o+"Key"]&&s!==o&&(u+=o+"+");for(s&&(f[u+s]=!0),e&&(f[u+e]=!0,f[u+this.hotkeysShiftNums[e]]=!0,u==="shift+"&&(f[this.hotkeysShiftNums[e]]=!0)),c=t.length,r=0;r<c;r++)if(f[t[r]]){n.preventDefault();this.worked=!0;i.message?this.app.broadcast(i.message,i.args):i.api&&this.app.api(i.api,i.args);return}}});n.add("class","input.space",{init:function(n,t,i,r){this.app=n;this.keycodes=n.keycodes;this.insertion=n.insertion;this.selection=n.selection;this.key=i;this.lastShiftKey=r;this._init(t)},_init:function(n){if(this.selection.hasNonEditable()){n.preventDefault();return}if(!this.lastShiftKey&&this.key===this.keycodes.SPACE&&(n.ctrlKey||n.shiftKey)){n.preventDefault();this.insertion.insertChar("&nbsp;");return}}});n.add("class","input.tab",{init:function(n,t){this.app=n;this.opts=n.opts;this.inspector=n.inspector;this.insertion=n.insertion;this.selection=n.selection;this._init(t)},_init:function(n){if(!this.opts.tabKey)return this._disable(n);var t=this.app.broadcast("tab",n);if(t===!1)return n.preventDefault();this._traverse(n)},_disable:function(n){n.preventDefault();return},_traverse:function(n){var i=this.selection.getCurrent(),t=this.inspector.parse(i);return!t.isComponent()&&n.shiftKey?this._insertHardTab(n,4):t.isList()?(n.preventDefault(),this.app.api("module.list.indent")):t.isPre()||t.isComponentType("code")&&!t.isFigcaption()?this._tabCode(n):this.opts.tabAsSpaces!==!1?this._insertHardTab(n,this.opts.tabAsSpaces):void 0},_insertHardTab:function(n,t){n.preventDefault();var i=document.createTextNode(Array(t+1).join("Â "));return this.insertion.insertNode(i,"end")},_tabCode:function(n){n.preventDefault();var t=this.opts.preSpaces?document.createTextNode(Array(this.opts.preSpaces+1).join("Â ")):document.createTextNode("\t");return this.insertion.insertNode(t,"end")}});n.add("module","upload",{init:function(n){this.app=n;this.opts=n.opts;this.lang=n.lang;this.utils=n.utils;this.editor=n.editor;this.progress=n.progress;this.defaults={event:!1,element:!1,name:!1,files:!1,url:!1,data:!1,paramName:!1}},build:function(t){this.p=n.extend(this.defaults,t);this.$el=n.dom(this.p.element);this.$el.get().tagName==="INPUT"?this._buildInput():this._buildBox()},send:function(t){this.p=n.extend(this.defaults,t);this.$uploadbox=this.editor.getElement();this._send(this.p.event,this.p.files)},complete:function(n,t){this._complete(n,t)},_buildInput:function(){this.box=!1;this.prefix="";this.$uploadbox=n.dom('<div class="upload-box" />');this.$el.hide();this.$el.after(this.$uploadbox);this.opts.multipleUpload?this.$el.attr("multiple","multiple"):this.$el.removeAttr("multiple");this._buildPlaceholder();this._buildEvents()},_buildBox:function(){this.box=!0;this.prefix="box-";this.$uploadbox=this.$el;this.$uploadbox.attr("ondragstart","return false;");this.$uploadbox.on("drop.redactor.upload",this._onDropBox.bind(this));this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this));this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_buildPlaceholder:function(){this.$placeholder=n.dom('<div class="upload-placeholder" />');this.$placeholder.html(this.lang.get("upload-label"));this.$uploadbox.append(this.$placeholder)},_buildEvents:function(){this.$el.on("change.redactor.upload",this._onChange.bind(this));this.$uploadbox.on("click.redactor.upload",this._onClick.bind(this));this.$uploadbox.on("drop.redactor.upload",this._onDrop.bind(this));this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this));this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_onClick:function(n){n.preventDefault();this.$el.click()},_onChange:function(n){this.app.broadcast("upload.start");this._send(n,this.$el.get().files)},_onDrop:function(n){n.preventDefault();this._clear();this._setStatusDrop();this.app.broadcast("upload.start");this._send(n)},_onDragOver:function(n){return n.preventDefault(),this._setStatusHover(),!1},_onDragLeave:function(n){return n.preventDefault(),this._removeStatusHover(),!1},_onDropBox:function(n){n.preventDefault();this._clear();this._setStatusDrop();this.app.broadcast("upload.start");this._send(n)},_removeStatusHover:function(){this.$uploadbox.removeClass("upload-"+this.prefix+"hover")},_setStatusDrop:function(){this.$uploadbox.addClass("upload-"+this.prefix+"drop")},_setStatusHover:function(){this.$uploadbox.addClass("upload-"+this.prefix+"hover")},_setStatusError:function(){this.$uploadbox.addClass("upload-"+this.prefix+"error")},_setStatusSuccess:function(){this.$uploadbox.addClass("upload-"+this.prefix+"success")},_clear:function(){for(var t=["drop","hover","error","success"],n=0;n<t.length;n++)this.$uploadbox.removeClass("upload-"+this.prefix+t[n]);this.$uploadbox.removeAttr("ondragstart")},_send:function(n,t){n=n.originalEvent||n;t=t?t:n.dataTransfer.files;var i=new FormData,r=this._getUploadParam();i=this._buildData(r,t,i);i=this.utils.extendData(i,this.p.data);this._sendData(i,t,n)},_sendData:function(t,i,r){if(this.progress.show(),typeof this.p.url=="function"){var u=this.p.url(t,i,r,this);u instanceof Promise||this._complete(u)}else n.ajax.post({url:this.p.url,data:t,before:function(n){return this.app.broadcast("upload.beforeSend",n)}.bind(this),success:function(n){this._complete(n,r)}.bind(this)})},_getUploadParam:function(){return this.p.paramName?this.p.paramName:"file"},_buildData:function(n,t,i){if(t.length===1)i.append(n+"[]",t[0]);else if(t.length>1&&this.opts.multipleUpload!==!1)for(var r=0;r<t.length;r++)i.append(n+"[]",t[r]);return i},_complete:function(n,t){this._clear();this.progress.hide();n&&n.error?(this._setStatusError(),this.app.broadcast("upload."+this.p.name+".error",n,t),this.app.broadcast("upload.error",n)):(this._setStatusSuccess(),this.app.broadcast("upload."+this.p.name+".complete",n,t),this.app.broadcast("upload.complete",n),setTimeout(this._clear.bind(this),500))}});n.add("class","code.component",{mixins:["dom","component"],init:function(n,t){return this.app=n,t&&t.cmnt!==undefined?t:this._init(t)},_init:function(t){var i,u,r;typeof t!="undefined"?(u=n.dom(t),r=u.closest("figure"),r.length!==0?this.parse(r):(this.parse("<figure>"),this.append(t)),i=this.find("pre code, pre").last()):(i=n.dom("<pre>"),this.parse("<figure>"),this.append(i));this._initElement(i);this._initWrapper()},_initElement:function(n){n.attr({tabindex:"-1",contenteditable:!0})},_initWrapper:function(){this.addClass("redactor-component");this.attr({"data-redactor-type":"code",tabindex:"-1",contenteditable:!1})}});n.add("module","form",{init:function(n){this.app=n;this.lang=n.lang;this.component=n.component;this.inspector=n.inspector},onform:{remove:function(n){this._remove(n)}},oncontextbar:function(n,t){var r=this.inspector.parse(n.target),i,u;r.isComponentType("form")&&(i=r.getComponent(),u={remove:{title:this.lang.get("delete"),api:"module.form.remove",args:i}},t.set(n,i,u,"top"))},_remove:function(n){this.component.remove(n)}});n.add("class","form.component",{mixins:["dom","component"],init:function(n,t){return this.app=n,this.utils=n.utils,t&&t.cmnt!==undefined?t:this._init(t)},_init:function(t){var i,r,u;typeof t!="undefined"?(i=n.dom(t),r=i.closest("form"),r.length!==0?(u=this.utils.replaceToTag(t,"figure"),this.parse(u)):(this.parse("<figure>"),this.append(t))):this.parse("<figure>");this._initWrapper()},_initWrapper:function(){this.addClass("redactor-component");this.attr({"data-redactor-type":"form",tabindex:"-1",contenteditable:!1})}});n.add("module","image",{modals:{image:'<div class="redactor-modal-tab" data-title="## upload ##"><form action="">                 <input type="file" name="file">             <\/form><\/div>',imageedit:'<div class="redactor-modal-group">                 <div id="redactor-modal-image-preview" class="redactor-modal-side"><\/div>                 <form action="" class="redactor-modal-area">                     <div class="form-item">                         <label for="modal-image-title"> ## title ##<\/label>                         <input type="text" id="modal-image-title" name="title" />                     <\/div>                     <div class="form-item">                         <label for="modal-image-caption">## caption ##<\/label>                         <input type="text" id="modal-image-caption" name="caption" aria-label="## caption ##" />                     <\/div>                     <div class="form-item form-item-align">                         <label>## image-position ##<\/label>                         <select name="align" aria-label="## image-position ##">                             <option value="none">## none ##<\/option>                             <option value="left">## left ##<\/option>                             <option value="center">## center ##<\/option>                             <option value="right">## right ##<\/option>                         <\/select>                     <\/div>                     <div class="form-item">                         <label for="modal-image-url">## link ##<\/label>                         <input type="text" id="modal-image-url" name="url" aria-label="## link ##" />                     <\/div>                     <div class="form-item">                         <label class="checkbox"><input type="checkbox" name="target" aria-label="## link-in-new-tab ##"> ## link-in-new-tab ##<\/label>                     <\/div>                 <\/form>             <\/div>'},init:function(n){this.app=n;this.opts=n.opts;this.lang=n.lang;this.caret=n.caret;this.utils=n.utils;this.editor=n.editor;this.storage=n.storage;this.component=n.component;this.inspector=n.inspector;this.insertion=n.insertion;this.selection=n.selection;this.justResized=!1},oninsert:function(){this._observeImages()},onstarted:function(){this.storage.observeImages();this.opts.imageResizable&&(this.resizer=n.create("image.resize",this.app));this._observeImages()},ondropimage:function(n,t,i){if(this.opts.imageUpload){var r={url:this.opts.imageUpload,event:i?!1:n,files:t,name:"imagedrop",data:this.opts.imageData};this.app.api("module.upload.send",r)}},onstop:function(){this.resizer&&this.resizer.stop()},onimageresizer:{stop:function(){this.resizer&&this.resizer.hide()}},onsource:{open:function(){this.resizer&&this.resizer.hide()},closed:function(){this._observeImages();this.resizer&&this.resizer.rebuild()}},onupload:{complete:function(){this._observeImages()},image:{complete:function(n){this._insert(n)},error:function(n){this._uploadError(n)}},imageedit:{complete:function(n){this._change(n)},error:function(n){this._uploadError(n)}},imagedrop:{complete:function(n,t){this._insert(n,t)},error:function(n){this._uploadError(n)}},imagereplace:{complete:function(n){this._change(n,!1)},error:function(n){this._uploadError(n)}}},onmodal:{image:{open:function(n,t){this._setUpload(t)}},imageedit:{open:function(n,t){this._setFormData(n,t)},opened:function(n,t){this._setFormFocus(t)},remove:function(){this._remove(this.$image)},save:function(n,t){this._save(n,t)}}},onimage:{observe:function(){this._observeImages()},resized:function(){this.justResized=!0}},oncontextbar:function(n,t){var u,i,r,f;if(this.justResized){this.justResized=!1;return}u=this.selection.getCurrent();i=this.inspector.parse(u);!i.isFigcaption()&&i.isComponentType("image")&&(r=i.getComponent(),f={edit:{title:this.lang.get("edit"),api:"module.image.open"},remove:{title:this.lang.get("delete"),api:"module.image.remove",args:r}},t.set(n,r,f))},open:function(){this.$image=this._getCurrent();this.app.api("module.modal.build",this._getModalData())},insert:function(n){this._insert(n)},remove:function(n){this._remove(n)},_getModalData:function(){return this._isImage()&&this.opts.imageEditable?{name:"imageedit",width:"800px",title:this.lang.get("edit"),handle:"save",commands:{save:{title:this.lang.get("save")},remove:{title:this.lang.get("delete"),type:"danger"},cancel:{title:this.lang.get("cancel")}}}:{name:"image",title:this.lang.get("image")}},_isImage:function(){return this.$image},_getCurrent:function(){var t=this.selection.getCurrent(),n=this.inspector.parse(t);return n.isComponentType("image")&&n.isComponentActive()?this.component.create("image",n.getComponent()):!1},_insert:function(n,t){if(this.app.api("module.modal.close"),typeof n=="string"&&(n={file:{url:n}}),typeof n=="object"){var i=Object.keys(n).length>1;i?this._insertMultiple(n,t):this._insertSingle(n,t)}},_insertSingle:function(n,t){var u,r,i;for(u in n)r=this._createImageAndStore(n[u]),i=t?this.insertion.insertToPoint(t,r):this.insertion.insertHtml(r),this._removeSpaceBeforeFigure(i[0]),this.component.setActive(i[0]),this.app.broadcast("image.uploaded",i[0],n)},_insertMultiple:function(t,i){var f=0,r=[],e,o,u,s;for(o in t)f++,u=this._createImageAndStore(t[o]),f===1?r=i?this.insertion.insertToPoint(i,u):this.insertion.insertHtml(u):(s=n.dom(r[0]),s.after(u),r=[u.get()],this.app.broadcast("image.inserted",u)),e=r[0],this._removeSpaceBeforeFigure(r[0]),this.app.broadcast("image.uploaded",r[0],t);this.component.setActive(e)},_createImageAndStore:function(n){var t=this.component.create("image");return t.addClass("redactor-uploaded-figure"),t.setData({src:n.url,id:n.id?n.id:this.utils.getRandomId()}),this.storage.add("image",t.getElement()),t},_removeSpaceBeforeFigure:function(n){if(n){var t=n.previousSibling;t&&(this._removeInvisibleSpace(t),this._removeInvisibleSpace(t.previousSibling))}},_removeInvisibleSpace:function(n){n&&n.nodeType===3&&this.utils.searchInvisibleChars(n.textContent)!==-1&&n.parentNode.removeChild(n)},_save:function(n,t){var i=t.getData(),r={title:i.title,link:{url:i.url,target:i.target}};this.opts.imageCaption&&(r.caption=i.caption);this.opts.imagePosition&&(r.align=i.align);this.$image.setData(r);this.resizer&&this.resizer.rebuild();this.app.broadcast("image.changed",this.$image);this.app.api("module.modal.close")},_change:function(t,i){var r,u;if(typeof t=="string"&&(t={file:{url:t}}),typeof t=="object"){for(u in t){r=n.dom("<img>");r.attr("src",t[u].url);this.$image.changeImage(t[u]);this.app.broadcast("image.changed",this.$image,t);this.app.broadcast("image.uploaded",this.$image,t);break}if(i!==!1)r.on("load",function(){this.$previewBox.html(r)}.bind(this))}},_uploadError:function(n){this.app.broadcast("image.uploadError",n)},_remove:function(n){this.app.api("module.modal.close");this.component.remove(n)},_observeImages:function(){var i=this.editor.getElement(),t=this;i.find("img").each(function(i){var r=n.dom(i);r.off(".drop-to-replace");r.on("dragover.drop-to-replace dragenter.drop-to-replace",function(n){n.preventDefault();return});r.on("drop.drop-to-replace",function(n){if(!t.app.isDragComponentInside())return t._setReplaceUpload(n,r)})})},_setFormData:function(n,t){this._buildPreview();this._buildPreviewUpload();var i=this.$image.getData(),r={title:i.title};this.opts.imageCaption?r.caption=i.caption:n.find(".form-item-caption").hide();this.opts.imagePosition?r.align=i.align:n.find(".form-item-align").hide();i.link&&(r.url=i.link.url,i.link.target&&(r.target=!0));t.setData(r)},_setFormFocus:function(n){n.getField("title").focus()},_setReplaceUpload:function(n,t){if(n=n.originalEvent||n,n.stopPropagation(),n.preventDefault(),this.opts.imageUpload){this.$image=this.component.create("image",t);var i={url:this.opts.imageUpload,files:n.dataTransfer.files,name:"imagereplace",data:this.opts.imageData};this.app.api("module.upload.send",i);return}},_setUpload:function(n){var t={url:this.opts.imageUpload,element:n.getField("file"),name:"image",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.build",t)},_buildPreview:function(){this.$preview=n.dom("#redactor-modal-image-preview");var i=this.$image.getData(),t=n.dom("<img>");t.attr("src",i.src);this.$previewBox=n.dom("<div>");this.$previewBox.append(t);this.$preview.html("");this.$preview.append(this.$previewBox)},_buildPreviewUpload:function(){var t,i;this.opts.imageUpload&&(t=n.dom('<div class="desc">'),t.html("Drop a new image to change"),this.$preview.append(t),i={url:this.opts.imageUpload,element:this.$previewBox,name:"imageedit"},this.app.api("module.upload.build",i))}});n.add("class","image.component",{mixins:["dom","component"],init:function(n,t){return this.app=n,this.opts=n.opts,this.selection=n.selection,t&&t.cmnt!==undefined?t:this._init(t)},setData:function(n){for(var t in n)this._set(t,n[t])},getData:function(){for(var t=["src","title","caption","align","link","id"],i={},n=0;n<t.length;n++)i[t[n]]=this._get(t[n]);return i},getElement:function(){return this.$element},changeImage:function(n){this.$element.attr("src",n.url)},_init:function(t){var i=n.dom(t),r=i.closest("figure");t===undefined?(this.$element=n.dom("<img>"),this.parse("<figure>"),this.append(this.$element)):r.length===0?(this.parse("<figure>"),this.$element=i,this.$element.wrap(this)):(this.parse(r),this.$element=this.find("img"));this._initWrapper()},_set:function(n,t){this["_set_"+n](t)},_get:function(n){return this["_get_"+n]()},_set_src:function(n){this.$element.attr("src",n)},_set_id:function(n){this.$element.attr("data-image",n)},_set_title:function(n){n=n.trim().replace(/(<([^>]+)>)/ig,"");n===""?(this.$element.removeAttr("alt"),this.$element.removeAttr("title")):(this.$element.attr("alt",n),this.$element.attr("title",n))},_set_caption:function(t){var i=this.find("figcaption");return i.length===0&&(i=n.dom("<figcaption>"),i.attr("contenteditable","true"),this.append(i)),t===""?i.remove():i.html(t),i},_set_align:function(n){var r="",u="",e="",t=this,i,o,f;if(typeof this.opts.imagePosition=="object"){i=this.opts.imagePosition;for(o in i)t.removeClass(i[o]);f=typeof i[n]!="undefined"?i[n]:!1;f&&t.addClass(f)}else{switch(n){case"left":r="left";u="0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+" 0";break;case"right":r="right";u="0 0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin;break;case"center":e="center"}t.css({float:r,margin:u,"text-align":e});t.attr("rel",t.attr("style"))}},_set_link:function(t){var i=this._findLink();if(t.url===""){i&&i.unwrap();return}return i||(i=n.dom("<a>"),this.$element.wrap(i)),i.attr("href",t.url),t.target?i.attr("target",t.target):i.removeAttr("target"),i},_get_src:function(){return this.$element.attr("src")},_get_id:function(){return this.$element.attr("data-image")},_get_title:function(){var n=this.$element.attr("alt"),t=this.$element.attr("title");return n?n:t?t:""},_get_caption:function(){var n=this.find("figcaption");return n.length===0?"":n.html()},_get_align:function(){var n="",t,i;if(typeof this.opts.imagePosition=="object"){n="none";t=this.opts.imagePosition;for(i in t)if(this.hasClass(t[i])){n=i;break}}else n=this.css("text-align")==="center"?"center":this.css("float");return n},_get_link:function(){var n=this._findLink(),t;if(n)return t=n.attr("target")?!0:!1,{url:n.attr("href"),target:t}},_initWrapper:function(){this.addClass("redactor-component");this.attr({"data-redactor-type":"image",tabindex:"-1",contenteditable:!1})},_findLink:function(){var t=this.find("a").filter(function(t){return n.dom(t).closest("figcaption").length===0});return t.length!==0?t:!1}});n.add("class","image.resize",{init:function(n){this.app=n;this.$doc=n.$doc;this.$win=n.$win;this.$body=n.$body;this.editor=n.editor;this.toolbar=n.toolbar;this.inspector=n.inspector;this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body;this._init()},rebuild:function(){this._setResizerPosition()},hide:function(){this.$target.find("#redactor-image-resizer").remove()},stop:function(){var n=this.editor.getElement();n.off(".redactor.image-resize");this.$doc.off(".redactor.image-resize");this.$win.off("resize.redactor.image-resize");this.hide()},_init:function(){var n=this.editor.getElement();n.on("click.redactor.image-resize",this._build.bind(this));this.$win.on("resize.redactor.image-resize",this._setResizerPosition.bind(this))},_build:function(t){this.$target.find("#redactor-image-resizer").remove();var i=this.inspector.parse(t.target),r=this.editor.getElement();if(i.isComponentType("image")){this.$resizableBox=r;this.$resizableImage=n.dom(i.getImageElement());this.$resizer=n.dom("<span>");this.$resizer.attr("id","redactor-image-resizer");this.$target.append(this.$resizer);this._setResizerPosition();this.$resizer.on("mousedown touchstart",this._set.bind(this))}},_setResizerPosition:function(){if(this.$resizer){var t=this.toolbar.isTarget(),i=this.$target.offset(),n=7,u=t?n-i.top+this.$target.scrollTop():n,f=t?n-i.left:n,r=this.$resizableImage.offset(),e=this.$resizableImage.width(),o=this.$resizableImage.height(),s=this.$resizer.width(),h=this.$resizer.height();this.$resizer.css({top:r.top+o-h+u+"px",left:r.left+e-s+f+"px"})}},_set:function(n){n.preventDefault();this.resizeHandle={x:n.pageX,y:n.pageY,el:this.$resizableImage,ratio:this.$resizableImage.width()/this.$resizableImage.height(),h:this.$resizableImage.height()};n=n.originalEvent||n;n.targetTouches&&(this.resizeHandle.x=n.targetTouches[0].pageX,this.resizeHandle.y=n.targetTouches[0].pageY);this.app.broadcast("contextbar.close");this.app.broadcast("image.resize",this.$resizableImage);this._start()},_start:function(){this.$doc.on("mousemove.redactor.image-resize touchmove.redactor.image-resize",this._move.bind(this));this.$doc.on("mouseup.redactor.image-resize touchend.redactor.image-resize",this._stop.bind(this))},_stop:function(){this.$doc.off(".redactor.image-resize");this.app.broadcast("image.resized",this.$resizableImage)},_move:function(n){var t,i;(n.preventDefault(),n=n.originalEvent||n,t=this.resizeHandle.h,t+=n.targetTouches?n.targetTouches[0].pageY-this.resizeHandle.y:n.pageY-this.resizeHandle.y,i=t*this.resizeHandle.ratio,t<50||i<100)||this._getResizableBoxWidth()<=i||(this.resizeHandle.el.attr({width:i,height:t}),this.resizeHandle.el.width(i),this.resizeHandle.el.height(t),this._setResizerPosition())},_getResizableBoxWidth:function(){var n=this.$resizableBox.width();return n-parseInt(this.$resizableBox.css("padding-left"))-parseInt(this.$resizableBox.css("padding-right"))}});n.add("module","file",{modals:{file:'<div class="redactor-modal-tab" data-title="## upload ##"><form action="">                 <div class="form-item form-item-title">                     <label for="modal-file-title"> ## filename ## <span class="desc">(## optional ##)<\/span><\/label>                     <input type="text" id="modal-file-title" name="title" />                 <\/div>                 <input type="file" name="file">             <\/form><\/div>'},init:function(n){this.app=n;this.opts=n.opts;this.lang=n.lang;this.caret=n.caret;this.utils=n.utils;this.storage=n.storage;this.component=n.component;this.inspector=n.inspector;this.insertion=n.insertion;this.selection=n.selection},onstarted:function(){this.storage.observeFiles()},ondropfile:function(n,t,i){if(this.opts.fileUpload){var r={url:this.opts.fileUpload,event:i?!1:n,files:t,name:"filedrop",data:this.opts.fileData};this.app.api("module.upload.send",r)}},onmodal:{file:{open:function(n,t){this._setFormData(n,t);this._setUpload(t)},opened:function(n,t){this._setFormFocus(t);this.$form=t}}},onupload:{file:{complete:function(n){this._insert(n)},error:function(n){this._uploadError(n)}},filedrop:{complete:function(n,t){this._insert(n,t)},error:function(n){this._uploadError(n)}}},oncontextbar:function(n,t){var f=this.selection.getCurrent(),r=this.inspector.parse(f),i,u;r.isFile()&&(i=r.getFile(),u={remove:{title:this.lang.get("delete"),api:"module.file.remove",args:i}},t.set(n,i,u,"bottom"))},open:function(){this._open()},insert:function(n){this._insert(n)},remove:function(n){this._remove(n)},_open:function(){this.app.api("module.modal.build",this._getModalData())},_getModalData:function(){return{name:"file",title:this.lang.get("file")}},_insert:function(n,t){if(this.app.api("module.modal.close"),typeof n=="object"){var i=Object.keys(n).length>1;i?this._insertMultiple(n,t):this._insertSingle(n,t);this.$form=!1}},_insertSingle:function(n,t){var r=[],u,i;for(u in n)i=this._createFileAndStore(n[u]),r=this.opts.fileAttachment?this._insertAsAttachment(i):t?this.insertion.insertToPoint(t,i):this.insertion.insertRaw(i),this.app.broadcast("file.uploaded",r[0],n)},_insertMultiple:function(t,i){var f=0,u=[],e,o,r,s;for(o in t)f++,r=this._createFileAndStore(t[o]),this.opts.fileAttachment?u=this._insertAsAttachment(r,t):f===1?u=i?this.insertion.insertToPoint(i,r):this.insertion.insertRaw(r):(s=n.dom(u[0]),s.after(r),u=[r.get()],this.app.broadcast("file.inserted",r)),e=r,this.app.broadcast("file.uploaded",u[0],t);this.opts.fileAttachment||this.caret.setAfter(e)},_insertAsAttachment:function(t,i){var f=n.dom(this.opts.fileAttachment),u=t.wrapAttachment(),r;return f.append(u),r=[u.get()],this.app.broadcast("file.appended",r[0],i),r},_createFileAndStore:function(n){var i=this.$form?this.$form.getData():!1,r=n.name?n.name:n.url,u=!this.opts.fileAttachment&&i&&i.title!==""?i.title:this._truncateUrl(r),t=this.component.create("file");return t.attr("href",n.url),t.attr("data-file",n.id?n.id:this.utils.getRandomId()),t.attr("data-name",n.name),t.html(u),this.storage.add("file",t),t},_remove:function(n){this.selection.save();var t=this.component.create("file",n),i=this.app.broadcast("file.delete",t);i!==!1?(t.unwrap(),this.selection.restore(),this.app.broadcast("file.deleted",t)):this.selection.restore()},_truncateUrl:function(n){return n.search(/^http/)!==-1&&n.length>20?n.substring(0,20)+"...":n},_setUpload:function(n){var t={url:this.opts.fileUpload,element:n.getField("file"),name:"file",data:this.opts.fileData,paramName:this.opts.fileUploadParam};this.app.api("module.upload.build",t)},_setFormData:function(n,t){this.opts.fileAttachment?n.find(".form-item-title").hide():t.setData({title:this.selection.getText()})},_setFormFocus:function(n){n.getField("title").focus()},_uploadError:function(n){this.app.broadcast("file.uploadError",n)}});n.add("class","file.component",{mixins:["dom","component"],init:function(n,t){return this.app=n,this.opts=n.opts,t&&t.cmnt!==undefined?t:this._init(t)},wrapAttachment:function(){this.$wrapper=n.dom('<span class="redactor-file-item">');this.$remover=n.dom('<span class="redactor-file-remover">');this.$remover.html("&times;");this.$remover.on("click",this.removeAttachment.bind(this));return this.$wrapper.append(this),this.$wrapper.append(this.$remover),this.$wrapper},removeAttachment:function(n){n.preventDefault();var t=this.app.broadcast("file.delete",this,this.$wrapper);t!==!1&&(this.$wrapper.remove(),this.app.broadcast("file.deleted",this),this.app.broadcast("file.removeAttachment",this))},_init:function(t){if(t===undefined)this.parse("<a>");else{var i=n.dom(t).closest("a");this.parse(i)}}});n.add("module","buffer",{init:function(n){this.app=n;this.opts=n.opts;this.editor=n.editor;this.offset=n.offset;this.keycodes=n.keycodes;this.selection=n.selection;this.state=!1;this.passed=!1;this.keyPressed=!1;this.savedHtml=!1;this.savedOffset=!1;this.undoStorage=[];this.redoStorage=[]},onkeydown:function(n){this._listen(n)},onsyncing:function(){this.keyPressed||this.trigger();this.keyPressed=!1},onstate:function(n,t,i){n&&(n.ctrlKey||n.metaKey)||n&&(this._isUndo(n)||this._isRedo(n))||(this.passed=!1,this._saveState(t,i))},onenable:function(){this.clear()},clear:function(){this.state=!1;this.undoStorage=[];this.redoStorage=[]},undo:function(){this._getUndo()},redo:function(){this._getRedo()},trigger:function(){this.state&&this.passed===!1&&this._setUndo()},_saveState:function(n,t){var i=this.editor.getElement();this.state={html:n||i.html(),offset:t||this.offset.get()}},_listen:function(n){var t=n.which,i=n.ctrlKey||n.metaKey,r=i||n.shiftKey||n.altKey,u=[this.keycodes.SPACE,this.keycodes.ENTER,this.keycodes.BACKSPACE,this.keycodes.DELETE,this.keycodes.TAB,this.keycodes.LEFT,this.keycodes.RIGHT,this.keycodes.UP,this.keycodes.DOWN];if(this._isUndo(n)){n.preventDefault();this.undo();return}if(this._isRedo(n)){n.preventDefault();this.redo();return}i||u.indexOf(t)===-1?i&&(t===88||t===67)&&(r=!0,this.trigger()):(r=!0,this.trigger());r||this._hasUndo()||this.trigger();this.keyPressed=!0},_isUndo:function(n){var t=n.which,i=n.ctrlKey||n.metaKey;return i&&t===90&&!n.shiftKey&&!n.altKey},_isRedo:function(n){var t=n.which,i=n.ctrlKey||n.metaKey;return i&&(t===90&&n.shiftKey||t===89&&!n.shiftKey)&&!n.altKey},_setUndo:function(){var n=this.undoStorage[this.undoStorage.length-1];(typeof n=="undefined"||n[0]!==this.state.html)&&(this.undoStorage.push([this.state.html,this.state.offset]),this._removeOverStorage())},_setRedo:function(){var n=this.editor.getElement(),t=this.offset.get(),i=n.html();this.redoStorage.push([i,t]);this.redoStorage=this.redoStorage.slice(0,this.opts.bufferLimit)},_getUndo:function(){if(this._hasUndo()){this.passed=!0;var t=this.editor.getElement(),n=this.undoStorage.pop();this._setRedo();t.html(n[0]);this.offset.set(n[1]);this.selection.restore();this.app.broadcast("undo",n[0],n[1])}},_getRedo:function(){if(this._hasRedo()){this.passed=!0;var t=this.editor.getElement(),n=this.redoStorage.pop();this._setUndo();t.html(n[0]);this.offset.set(n[1]);this.app.broadcast("redo",n[0],n[1])}},_removeOverStorage:function(){this.undoStorage.length>this.opts.bufferLimit&&(this.undoStorage=this.undoStorage.slice(0,this.undoStorage.length-this.opts.bufferLimit))},_hasUndo:function(){return this.undoStorage.length!==0},_hasRedo:function(){return this.redoStorage.length!==0}});n.add("module","list",{init:function(n){this.app=n;this.opts=n.opts;this.utils=n.utils;this.toolbar=n.toolbar;this.inspector=n.inspector;this.selection=n.selection},onbutton:{list:{observe:function(n){this._observeButton(n)}}},ondropdown:{list:{observe:function(n){this._observeDropdown(n)}}},toggle:function(t){this.selection.saveMarkers();var i=this._getBlocks(),u=this.selection.getBlock(),r=n.dom(u).parents("ul, ol",".redactor-in").last();return i.length===0&&r.length!==0&&(i=[r.get()]),i=this._isUnformat(t,i)?this._unformat(t,i):this._format(t,i),this.selection.restoreMarkers(),i},indent:function(){var c=this.selection.isCollapsed(),l=this.selection.getCurrent(),e=this.inspector.parse(l),o=e.isList()?e.getListItem():!1,t=n.dom(o),i=t.prevElement(),r=i.get(),a=c&&o&&r&&r.tagName==="LI",u,s,h,f;a&&(this.selection.saveMarkers(),i=n.dom(r),u=i.children("ul, ol"),s=t.closest("ul, ol"),u.length!==0?u.append(t):(h=s.get().tagName.toLowerCase(),f=n.dom("<"+h+">"),f.append(t),i.append(f)),this.selection.restoreMarkers())},outdent:function(){var b=this.selection.isCollapsed(),k=this.selection.getCurrent(),l=this.inspector.parse(k),a=l.isList()?l.getListItem():!1,t=n.dom(a),u,o,r;if(b&&a){var i=t.parent(),h=i.closest("li"),d=t.prevElement(),g=t.nextElement(),v=d.get(),y=g.get(),f,s,e,p,c=v===!1,w=v!==!1&&y!==!1,nt=!c&&y===!1;if(this.selection.saveMarkers(),h.length!==0)if(w){for(f=this._getAllNext(t.get()),e=n.dom("<"+i.get().tagName.toLowerCase()+">"),r=0;r<f.length;r++)e.append(f[r]);h.after(t);t.append(e)}else h.after(t),i.children().length===0?i.remove():c&&t.append(i);else{if(u=this._createUnformatContainer(t),o=u.find("ul, ol").first(),c)i.before(u);else if(nt)i.after(u);else if(w){for(e=n.dom("<"+i.get().tagName.toLowerCase()+">"),f=this._getAllNext(t.get()),r=0;r<f.length;r++)e.append(f[r]);i.after(u);u.after(e)}o.length!==0&&(p=u.nextElement(),s=p.get(),s&&s.tagName===i.get().tagName?(n.dom(s).prepend(o),o.unwrap()):u.after(o));t.remove()}this.selection.restoreMarkers()}},_getAllNext:function(t){for(var i=[],r;t;)if(r=n.dom(t).nextElement(),t=r.get(),t)i.push(t);else return i;return i},_isUnformat:function(n,t){for(var r,u=0,i=0;i<t.length;i++)t[i].nodeType!==3&&(r=t[i].tagName.toLowerCase(),(r===n||r==="figure")&&u++);return u===t.length},_format:function(t,i){var s=this._uniteBlocks(i,["p","div","blockquote","pre","h1","h2","h3","h4","h5","h6","ul","ol"]),c=[],h,u,e,r,f,o;for(h in s){for(u=s[h],e=this._createList(t,s[h]),r=0;r<u.length;r++)u[r].nodeType!==3&&(u[r].tagName==="UL"||u[r].tagName==="OL")?(o=n.dom(u[r]),f=o.contents(),e.append(f),this.utils.isEmpty(o)&&o.remove()):(f=this._createListItem(u[r]),this.utils.normalizeTextNodes(f),e.append(f));c.push(e.get())}return c},_uniteBlocks:function(t,i){for(var s,e,u=0,f={0:[]},o=!1,r=0;r<t.length;r++)s=n.dom(t[r]),e=s.closest("th, td"),e.length!==0?(e.get()!==o&&(u++,f[u]=[]),this._isUniteBlock(t[r],i)&&f[u].push(t[r])):this._isUniteBlock(t[r],i)?f[u].push(t[r]):(u++,f[u]=[]),o=e.get();return f},_isUniteBlock:function(n,t){return n.nodeType===3||t.indexOf(n.tagName.toLowerCase())!==-1},_createList:function(t,i){var u=i[i.length-1],f=n.dom(u),r=n.dom("<"+t+">");return f.after(r),r},_createListItem:function(t){var i=n.dom("<li>"),r;return t.nodeType===3?i.append(t):(r=n.dom(t),i.append(r.contents()),r.remove()),i},_unformat:function(t,i){var o,h,c,u;if(i.length===1){var f=n.dom(i[0]),e=f.find("li"),r=this.selection.getNodes({tags:["li"]}),y=this.selection.getBlock(),l=n.dom(y).closest("li");if(r.length===0&&l.length!==0&&(r=[l.get()]),r.length===e.length)return this._unformatEntire(i[0]);if(o=this._getItemsPosition(e,r),o==="Top")return this._unformatAtSide("before",r,f);if(o==="Bottom")return r.reverse(),this._unformatAtSide("after",r,f);if(o==="Middle"){var p=n.dom(r[r.length-1]),a=!1,s=!1,v=n.dom("<"+f.get().tagName.toLowerCase()+">");for(e.each(function(t){if(a){var i=n.dom(t);i.closest(".redactor-split-item").length===0&&(s===!1||i.closest(s).length===0)&&i.addClass("redactor-split-item");s=i}t===p.get()&&(a=!0)}),e.filter(".redactor-split-item").each(function(t){var i=n.dom(t);i.removeClass("redactor-split-item");v.append(t)}),f.after(v),r.reverse(),u=0;u<r.length;u++)h=n.dom(r[u]),c=this._createUnformatContainer(h),f.after(c),c.find("ul, ol").remove(),h.remove();return}}else for(u=0;u<i.length;u++)i[u].nodeType!==3&&i[u].tagName.toLowerCase()===t&&this._unformatEntire(i[u])},_unformatEntire:function(t){var i=n.dom(t),r=i.find("li");r.each(function(t){var r=n.dom(t),u=this._createUnformatContainer(r);r.remove();i.before(u)}.bind(this));i.remove()},_unformatAtSide:function(t,i,r){for(var f,e,o,u=0;u<i.length;u++)f=n.dom(i[u]),e=this._createUnformatContainer(f),r[t](e),o=e.find("ul, ol").first(),f.append(o),o.each(function(t){var r=n.dom(t),f=r.closest("li");f.get()===i[u]&&(r.unwrap(),f.addClass("r-unwrapped"))}),this.utils.isEmptyHtml(f.html())&&f.remove();r.find(".r-unwrapped").each(function(t){var i=n.dom(t);i.html().trim()===""?i.remove():i.removeClass("r-unwrapped")})},_getItemsPosition:function(n,t){var i="Middle",r=t[0],u=t[t.length-1],f=n.first().get(),e=n.last().get();return f===r&&e!==u?i="Top":f!==r&&e===u&&(i="Bottom"),i},_createUnformatContainer:function(t){var i=n.dom("<"+this.opts.markup+">");return this.opts.breakline&&i.attr("data-redactor-tag","br"),i.append(t.contents()),i},_getBlocks:function(){return this.selection.getBlocks({first:!0})},_observeButton:function(){var r=this.selection.getCurrent(),n=this.inspector.parse(r),u=n.isPre()||n.isCode()||n.isFigcaption(),t,i;this._observeButtonsList(u,["lists","ul","ol","outdent","indent"]);t=this.toolbar.getButton("outdent");i=this.toolbar.getButton("indent");this._observeIndent(i,t)},_observeDropdown:function(n){var t=n.getItem("outdent"),i=n.getItem("indent");this._observeIndent(i,t)},_observeIndent:function(t,i){var u=this.selection.isCollapsed(),o=this.selection.getCurrent(),f=this.inspector.parse(o),r=f.isList()?f.getListItem():!1,s=n.dom(r),h=s.prevElement(),e=h.get(),c=u&&r&&e&&e.tagName==="LI";i&&(r&&u?i.enable():i.disable());t&&(r&&c?t.enable():t.disable())},_observeButtonsList:function(n,t){for(var r,i=0;i<t.length;i++)r=this.toolbar.getButton(t[i]),r&&(n?r.disable():r.enable())}});window.Redactor=window.$R=n;window.addEventListener("load",function(){n("[data-redactor]")})})()